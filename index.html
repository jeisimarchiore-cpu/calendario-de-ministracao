<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda do Pregador</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter, Lora, Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Library to export to DOCX -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            background-color: #374151; /* bg-gray-700 */
            transform: scale(1.05);
        }
        .event-dot {
            width: 8px;
            height: 8px;
            background-color: #34d399; /* bg-emerald-400 */
            border-radius: 50%;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Glassmorphism effect for modals */
        .modal-glass {
            background: rgba(31, 41, 55, 0.6); /* bg-gray-800 with opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Tab styling */
        .tab-btn.active {
            border-bottom-color: #34d399; /* border-emerald-400 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .main-view-btn.active {
             background-color: #34d399; /* bg-emerald-500 */
             color: #111827; /* text-gray-900 */
        }
        .editor-toolbar button, .editor-toolbar select {
            transition: background-color 0.2s;
        }
        [contenteditable]:focus {
            outline: none;
        }
        .mobile-nav-btn.active {
            color: #34d399; /* emerald-400 */
        }
        /* Reading Plan Checkbox */
        .reading-plan-item.completed .read-and-explain-btn {
            text-decoration: line-through;
            color: #6b7280;
        }
        /* Seal styles */
        .seal {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            text-align: center;
            transition: all 0.3s ease;
        }
        .seal-locked {
            background-color: #374151; /* bg-gray-700 */
            color: #9ca3af; /* text-gray-400 */
            border: 2px dashed #4b5563; /* border-gray-600 */
        }
        .seal-unlocked {
            background-image: radial-gradient(circle, #fde047, #f59e0b); /* yellow-300 to amber-500 */
            color: #422006; /* dark brown */
            border: 3px solid #fcd34d; /* yellow-400 */
            box-shadow: 0 0 15px rgba(253, 224, 71, 0.5);
            transform: scale(1.05);
        }
        .seal .book-name {
            font-size: 0.7rem;
            font-weight: 600;
            line-height: 1;
        }
        .seal .read-count {
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 2px;
            background: rgba(0,0,0,0.1);
            padding: 0 5px;
            border-radius: 10px;
        }
         /* Presentation Mode Styles */
        #presentation-modal {
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #presentation-modal.visible {
            opacity: 1;
        }
        #presentation-title {
            font-family: 'Montserrat', sans-serif;
            text-shadow: 0 0 15px rgba(52, 211, 153, 0.5);
        }
        #presentation-content {
            font-family: 'Lora', serif;
        }
        #presentation-content h1,
        #presentation-content h2,
        #presentation-content h3,
        #presentation-content h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: #6ee7b7; /* emerald-300 */
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
         #presentation-content h1 { font-size: 1.8em; }
         #presentation-content h2 { font-size: 1.5em; }
         #presentation-content h3 { font-size: 1.25em; }
         #presentation-content h4 { font-size: 1.1em; }

        #presentation-content blockquote {
            border-left: 3px solid #34d399; /* emerald-400 */
            padding-left: 1rem;
            margin-left: 0.5rem;
            font-style: italic;
            color: #9ca3af; /* gray-400 */
        }
         #presentation-content ul, #presentation-content ol {
            padding-left: 2rem;
         }
         #presentation-content li {
            margin-bottom: 0.5rem;
         }
    </style>
</head>
<body class="antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <p class="text-white text-lg"><i class="fas fa-spinner fa-spin mr-2"></i>A carregar...</p>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen w-full flex-col">

        <!-- Top Header for User Info and Logout -->
        <header class="absolute top-0 right-0 p-4 flex items-center gap-4 text-sm z-20">
             <div class="text-right">
                 <span id="user-email" class="text-gray-400 block font-medium"></span>
                 <span id="user-id" class="text-gray-500 text-xs block"></span>
             </div>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg transition-colors" title="Sair">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </header>

        <!-- Main View Navigation (New Header) -->
        <nav id="main-view-nav" class="px-4 lg:px-8 pt-16 lg:pt-12 w-full z-10">
            <div class="bg-gray-800 rounded-lg p-1.5 flex justify-center items-center gap-2 max-w-md mx-auto">
                <button data-view="left-panel" class="main-view-btn w-full py-2 px-4 rounded-md text-sm font-semibold text-gray-300 transition-colors duration-200 flex items-center justify-center gap-2"><i class="fas fa-calendar-alt"></i> Agenda</button>
                <button data-view="center-panel" class="main-view-btn w-full py-2 px-4 rounded-md text-sm font-semibold text-gray-300 transition-colors duration-200 flex items-center justify-center gap-2"><i class="fas fa-pencil-alt"></i> Esboço</button>
                <button data-view="right-panel" class="main-view-btn w-full py-2 px-4 rounded-md text-sm font-semibold text-gray-300 transition-colors duration-200 flex items-center justify-center gap-2"><i class="fas fa-tools"></i> Ferramentas</button>
            </div>
        </nav>

        <!-- Main Content Layout -->
        <div id="main-content-layout" class="flex-grow w-full p-4 lg:p-8 overflow-y-auto pb-24 lg:pb-8">
            <!-- Left Panel: Calendar and Engagements -->
            <aside id="left-panel" class="main-panel w-full h-full hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col">
                         <div class="flex items-center justify-between mb-4">
                            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-left"></i></button>
                            <h2 id="month-year" class="text-xl font-bold text-white"></h2>
                            <button id="next-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 text-center text-xs text-gray-400 mb-2">
                            <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                        </div>
                        <div id="calendar-grid" class="grid calendar-grid gap-1 flex-grow">
                            <!-- Calendar days will be generated by JS -->
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg shadow-lg overflow-y-auto">
                        <h3 class="text-lg font-semibold text-white mb-2 border-b border-gray-700 pb-2">Próximas Ministrações</h3>
                        <div id="engagements-list">
                            <p class="text-gray-400 text-sm">Nenhuma ministração agendada.</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Center Panel: Editor & Integrated Study Tools -->
            <main id="center-panel" class="main-panel w-full h-full hidden">
                <div class="bg-gray-800 rounded-lg shadow-lg p-0 flex flex-col lg:flex-row overflow-hidden transition-all duration-300 h-full relative">
                     <!-- Editor Area -->
                    <div id="editor-area" class="w-full lg:w-full p-6 flex flex-col transition-all duration-300 flex-grow">
                        <div class="flex items-center justify-between mb-4 flex-shrink-0">
                            <h2 id="editor-title" class="text-2xl font-bold text-white">Novo Esboço</h2>
                            <div class="flex gap-2 items-center">
                                <button id="toggle-focus-mode-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg transition-colors" title="Modo Foco">
                                    <i class="fas fa-expand-arrows-alt"></i>
                                </button>
                                <div class="w-px h-6 bg-gray-700"></div>
                                <button id="open-study-tools-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2" title="Ferramentas de Estudo"><i class="fas fa-book-open"></i> <span class="hidden sm:inline">Estudo</span></button>
                                <button id="suggestion-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2" title="Gerar sugestão de esboço"><i class="fas fa-lightbulb"></i> <span class="hidden sm:inline">Gerar Ideia</span></button>
                                <button id="save-outline-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2"><i class="fas fa-save"></i> <span class="hidden sm:inline">Salvar</span></button>
                                <button id="clear-editor-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-eraser"></i> <span class="hidden sm:inline">Limpar</span></button>
                            </div>
                        </div>
                        
                        <div class="flex-grow flex flex-col gap-4 overflow-y-auto pr-2">
                            <input type="text" id="outline-title" placeholder="Título do Esboço" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 mb-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 flex-shrink-0">
                        
                            <!-- Rich Text Editor -->
                            <div class="flex flex-col flex-grow min-h-[250px]">
                                <div class="editor-toolbar flex items-center gap-2 bg-gray-900 p-2 rounded-t-lg border-b border-gray-700 flex-wrap flex-shrink-0">
                                    <button id="format-bold" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Negrito"><i class="fas fa-bold"></i></button>
                                    <button id="format-italic" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Itálico"><i class="fas fa-italic"></i></button>
                                    <button id="format-underline" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Sublinhado"><i class="fas fa-underline"></i></button>
                                    <button id="format-list" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Lista Numerada"><i class="fas fa-list-ol"></i></button>
                                    <div class="w-px h-5 bg-gray-700 mx-1"></div>
                                    <div class="relative flex items-center" title="Cor da Fonte">
                                        <input type="color" id="font-color-picker" class="absolute opacity-0 w-8 h-8 cursor-pointer">
                                        <i class="fas fa-palette text-lg px-2 text-gray-400"></i>
                                    </div>
                                    <select id="font-size-select" class="bg-gray-700 text-white text-xs rounded border-none focus:ring-0 p-1" title="Tamanho da Fonte">
                                        <option value="3">Normal</option>
                                        <option value="1">Mínimo</option>
                                        <option value="2">Pequeno</option>
                                        <option value="4">Médio</option>
                                        <option value="5">Grande</option>
                                        <option value="7">Enorme</option>
                                    </select>
                                </div>
                                <div id="outline-content" contenteditable="true" class="w-full flex-grow bg-gray-900 border-x border-b border-gray-700 rounded-b-lg p-4 text-gray-200 resize-none focus:outline-none overflow-y-auto"></div>
                            </div>

                            <!-- Notes Area -->
                            <div class="flex flex-col flex-grow min-h-[150px]">
                                <label for="outline-notes" class="block mb-2 text-sm font-medium text-gray-300 flex-shrink-0">Notas e Ilustrações</label>
                                <textarea id="outline-notes" placeholder="Anote aqui ideias, ilustrações, estatísticas..." class="w-full flex-grow bg-gray-900 border border-gray-700 rounded-lg p-4 text-gray-200 resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                            </div>
                        </div>

                        <div class="mt-4 flex-shrink-0">
                            <label for="bible-book-select" class="block mb-2 text-sm font-medium text-gray-300">Vincular esboço ao livro de:</label>
                            <select id="bible-book-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5"></select>
                        </div>
                    </div>

                    <!-- Study Tools Panel (Overlay on mobile/tablet, sidebar on desktop) -->
                    <aside id="study-tools-area" class="absolute lg:relative inset-0 lg:w-1/3 bg-gray-900 p-4 flex-col border-l border-gray-700 hidden transition-all duration-300 flex-shrink-0 z-10">
                        <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <h3 class="text-xl font-bold text-white">Ferramentas de Estudo</h3>
                            <div class="flex gap-2">
                                 <button id="clear-study-results-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded-lg text-xs" title="Limpar Resultados"><i class="fas fa-times-circle"></i></button>
                                 <button id="close-study-tools-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-xs" title="Fechar Ferramentas"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="flex-grow flex flex-col overflow-hidden">
                             <!-- Sub-tabs for Study -->
                             <div class="border-b border-gray-700 mb-2 flex-shrink-0">
                                 <nav id="study-sub-tabs" class="flex gap-4 -mb-px">
                                     <button data-subtab="verse-lookup" class="study-subtab-btn py-2 px-1 border-b-2 border-emerald-400 text-white text-sm font-medium">Busca</button>
                                     <button data-subtab="topical-study" class="study-subtab-btn py-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white text-sm font-medium">Tema</button>
                                     <button data-subtab="commentary" class="study-subtab-btn py-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white text-sm font-medium">Comentário</button>
                                 </nav>
                             </div>
            
                             <!-- Verse Lookup Pane -->
                             <div id="verse-lookup-pane" class="study-subtab-pane flex-grow flex flex-col overflow-hidden">
                                 <div class="flex gap-2 mb-2 items-center flex-shrink-0">
                                     <select id="bible-study-book-select" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5"></select>
                                     <input type="text" id="bible-ref-input" placeholder="3:16" class="w-1/3 bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white">
                                     <button id="fetch-verse-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-2.5 rounded-lg" title="Buscar Versículo"><i class="fas fa-search"></i></button>
                                 </div>
                                 <div id="verse-display" class="bg-gray-800 rounded-lg p-3 flex-grow text-gray-300 text-sm flex gap-4 overflow-x-auto pb-4"></div>
                             </div>
            
                             <!-- Topical Study Pane -->
                             <div id="topical-study-pane" class="study-subtab-pane hidden flex-grow flex flex-col overflow-hidden">
                                 <div class="flex gap-2 mb-2 items-center flex-shrink-0">
                                     <input type="text" id="topical-theme-input" placeholder="Digite um tema (ex: Fé, Amor)" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white">
                                     <button id="fetch-topic-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-2.5 rounded-lg" title="Buscar Tema"><i class="fas fa-search"></i></button>
                                 </div>
                                 <div id="topical-results-display" class="bg-gray-800 rounded-lg p-3 flex-grow text-gray-300 text-sm overflow-y-auto space-y-3">
                                      <p class="text-gray-500 italic flex items-center justify-center h-full">Pesquise um tema para ver os versículos.</p>
                                 </div>
                             </div>
                             
                             <!-- Commentary Pane -->
                            <div id="commentary-pane" class="study-subtab-pane hidden flex-grow flex flex-col overflow-hidden">
                                <div class="flex gap-2 mb-2 items-center flex-shrink-0">
                                    <select id="bible-commentary-book-select" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5"></select>
                                    <input type="number" id="bible-chapter-input" placeholder="Cap." class="w-1/4 bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white">
                                    <button id="fetch-commentary-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-2.5 rounded-lg" title="Gerar Comentário"><i class="fas fa-feather-alt"></i></button>
                                </div>
                                <div id="commentary-results-display" class="bg-gray-800 rounded-lg p-3 flex-grow text-gray-300 text-sm overflow-y-auto space-y-3">
                                     <p class="text-gray-500 italic flex items-center justify-center h-full">Selecione um livro e capítulo.</p>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </main>

            <!-- Right Panel: Tools -->
            <aside id="right-panel" class="main-panel w-full h-full bg-gray-800 rounded-lg shadow-lg p-6 flex-col hidden">
                 <div class="border-b border-gray-700 mb-4">
                     <nav id="right-tabs" class="flex gap-4 -mb-px">
                         <button data-tab="archive" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-book-bible mr-2"></i>Biblioteca</button>
                         <button data-tab="reading-plan" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-tasks mr-2"></i>Plano</button>
                         <button data-tab="achievements" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-award mr-2"></i>Conquistas</button>
                         <button data-tab="fasting" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-pray mr-2"></i>Jejum</button>
                     </nav>
                 </div>
                 <div id="right-tab-content" class="flex-grow flex flex-col min-h-0">
                     <div id="archive-tab-content" class="right-tab-pane flex-grow overflow-y-auto">
                         <div id="archive-list" class="space-y-2"></div>
                     </div>
                     <div id="reading-plan-tab-content" class="right-tab-pane hidden flex-grow flex flex-col">
                         <h3 class="text-xl font-semibold text-white mb-2 flex-shrink-0">Plano de Leitura Bíblica</h3>
                         <div class="mb-4 flex-shrink-0">
                             <label for="reading-plan-select" class="block mb-2 text-sm font-medium text-gray-300">Escolha um plano:</label>
                             <select id="reading-plan-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5"></select>
                         </div>
                         <div id="reading-plan-summary" class="bg-gray-900 rounded-lg p-3 mb-3 text-center flex-shrink-0">
                             <p class="text-gray-400">Selecione um plano para começar.</p>
                         </div>
                         <div id="reading-plan-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                         </div>
                     </div>
                     <div id="achievements-tab-content" class="right-tab-pane hidden flex-grow flex flex-col overflow-y-auto">
                         <h3 class="text-xl font-semibold text-white mb-4">Galeria de Selos</h3>
                         <div id="achievements-list" class="space-y-4">
                            <!-- Seals will be rendered here -->
                         </div>
                     </div>
                     <div id="fasting-tab-content" class="right-tab-pane hidden flex-grow flex flex-col">
                        <div class="flex-shrink-0">
                            <h3 class="text-xl font-semibold text-white mb-2">Jejum e Oração</h3>
                            
                            <div id="active-fast-timer" class="hidden mb-4 bg-emerald-900/50 border border-emerald-700 rounded-lg p-4 text-center">
                               <p class="text-sm text-emerald-300 mb-1">Propósito Ativo</p>
                               <p id="active-fast-title" class="font-bold text-lg text-white"></p>
                               <div id="timer-display" class="text-2xl lg:text-3xl font-mono tracking-wider text-emerald-400 mt-2"></div>
                            </div>
                            
                            <div class="bg-gray-900 rounded-lg p-3 mb-3">
                                <h4 class="font-semibold text-white mb-2 text-sm">Novo Propósito</h4>
                                 <input type="text" id="fasting-title" placeholder="Propósito" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm mb-2">
                                <div class="mb-2">
                                    <label for="fasting-type" class="text-xs text-gray-400">Tipo</label>
                                    <select id="fasting-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                                        <option value="Jejum">Jejum</option>
                                        <option value="Oração">Oração</option>
                                        <option value="Jejum e Oração">Jejum e Oração</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label for="fasting-start-date" class="text-xs text-gray-400">Início</label>
                                        <input type="datetime-local" id="fasting-start-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                                    </div>
                                    <div>
                                        <label for="fasting-end-date" class="text-xs text-gray-400">Fim</label>
                                        <input type="datetime-local" id="fasting-end-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                                    </div>
                                </div>
                                <textarea id="fasting-notes" placeholder="Anotações..." rows="2" class="w-full bg-gray-700 border rounded-lg p-2 text-white text-sm"></textarea>
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                   <button id="save-fasting-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Adicionar</button>
                                   <button id="suggest-delivery-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Como Entregar o Jejum?</button>
                               </div>
                            </div>
                        </div>
                        
                        <div class="flex-grow overflow-y-auto pr-2 min-h-0">
                            <h4 class="font-semibold text-white mb-2 text-sm">Propósitos Ativos/Futuros</h4>
                            <div id="fasting-list" class="space-y-2 mb-4"></div>
   
                            <h4 class="font-semibold text-white mt-4 mb-2 text-sm">Histórico</h4>
                             <div id="fasting-summary" class="grid grid-cols-3 gap-2 text-center mb-4">
                                <!-- Summary stats will be injected here -->
                            </div>

                            <div class="bg-gray-900 p-2 rounded-lg mb-4" style="height: 250px;">
                                <canvas id="fasting-chart"></canvas>
                            </div>
                            <div id="fasting-history" class="space-y-2"></div>
                        </div>
                    </div>
                 </div>
            </aside>
        </div>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav id="bottom-nav" class="lg:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around p-2 z-30">
            <button data-view="left-panel" class="mobile-nav-btn flex flex-col items-center text-emerald-400 w-1/3">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">Agenda</span>
            </button>
            <button data-view="center-panel" class="mobile-nav-btn flex flex-col items-center text-gray-400 w-1/3">
                <i class="fas fa-pencil-alt text-xl"></i>
                <span class="text-xs mt-1">Esboço</span>
            </button>
            <button data-view="right-panel" class="mobile-nav-btn flex flex-col items-center text-gray-400 w-1/3">
                <i class="fas fa-tools text-xl"></i>
                <span class="text-xs mt-1">Ferramentas</span>
            </button>
        </nav>
    </div>
    
    <!-- Modals -->
    <div id="engagement-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-40">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-white">Agendar Ministração</h3>
            <p class="mb-4 text-gray-300">Data: <span id="modal-date" class="font-semibold"></span></p>
            <div>
                <label for="engagement-title" class="block mb-2 text-sm font-medium text-gray-300">Título do Evento/Local</label>
                <input type="text" id="engagement-title" placeholder="Ex: Culto de Domingo - Igreja X" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5 mb-4">
            </div>
            <div>
                <label for="modal-outline-select" class="block mb-2 text-sm font-medium text-gray-300">Vincular Esboço</label>
                <select id="modal-outline-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5"></select>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-engagement" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Cancelar</button>
                <button id="save-engagement" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg">Salvar Agendamento</button>
                <button id="delete-engagement" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg hidden">Excluir</button>
            </div>
        </div>
    </div>
    
    <div id="suggestion-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-40">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-white">Assistente de Esboços (IA)</h3>
            <p class="text-sm text-gray-300 mb-4">Descreva o esboço que você precisa. Quanto mais detalhes, melhor o resultado.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="suggestion-theme-input" class="block mb-1 text-sm font-medium text-gray-300">Tema Principal</label>
                    <input type="text" id="suggestion-theme-input" placeholder="Ex: A Parábola do Filho Pródigo" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block p-2.5">
                </div>
                <div>
                    <label for="suggestion-base-text-input" class="block mb-1 text-sm font-medium text-gray-300">Texto-Base (Opcional)</label>
                    <input type="text" id="suggestion-base-text-input" placeholder="Ex: Lucas 15:11-32" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block p-2.5">
                </div>
                <div>
                    <label for="suggestion-audience-select" class="block mb-1 text-sm font-medium text-gray-300">Público-Alvo</label>
                    <select id="suggestion-audience-select" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block p-2.5">
                        <option>Geral</option>
                        <option>Jovens</option>
                        <option>Casais</option>
                        <option>Homens</option>
                        <option>Mulheres</option>
                        <option>Novos Convertidos</option>
                    </select>
                </div>
                <div>
                    <label for="suggestion-tone-select" class="block mb-1 text-sm font-medium text-gray-300">Tom da Mensagem</label>
                    <select id="suggestion-tone-select" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block p-2.5">
                        <option>Evangelístico</option>
                        <option>Doutrinário</option>
                        <option>Consolador</option>
                        <option>Exortativo / Confronto</option>
                        <option>Devocional / Inspirador</option>
                    </select>
                </div>
            </div>
    
            <div class="flex justify-end gap-2 mb-4">
                <button id="generate-suggestion-btn" class="py-2 px-6 bg-sky-500 hover:bg-sky-600 text-white rounded-lg flex items-center gap-2">
                    <i class="fas fa-magic-sparkles"></i> Gerar Esboço
                </button>
            </div>
    
            <div id="suggestion-result" class="bg-gray-900 rounded-lg p-4 flex-grow overflow-y-auto text-gray-300 text-sm whitespace-pre-wrap"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-suggestion" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Fechar</button>
                <button id="use-suggestion-btn" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg hidden">Usar este Esboço</button>
            </div>
        </div>
    </div>

    <!-- Reading Modal -->
    <div id="reading-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-50">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-4xl flex flex-col max-h-[90vh]">
            <h3 id="reading-modal-title" class="text-xl font-bold mb-4 text-white flex-shrink-0">Leitura do Dia</h3>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 overflow-hidden">
                <div id="reading-modal-text" class="bg-gray-900 rounded-lg p-4 overflow-y-auto text-gray-300 text-sm"></div>
                <div id="reading-modal-explanation" class="bg-gray-900 rounded-lg p-4 overflow-y-auto text-gray-300 text-sm"></div>
            </div>
            <div class="mt-6 flex justify-end gap-3 flex-shrink-0">
                <button id="close-reading-modal-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Fechar</button>
            </div>
        </div>
    </div>


    <!-- Explanation Modal -->
     <div id="explanation-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-50">
         <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="explanation-title" class="text-xl font-bold text-white">Explicação do Versículo</h3>
                <button id="copy-explanation-btn" class="py-1 px-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm hidden"><i class="fas fa-copy mr-2"></i>Copiar para Notas</button>
            </div>
             <div id="explanation-result" class="bg-gray-900 rounded-lg p-4 flex-grow overflow-y-auto text-gray-300 text-sm whitespace-pre-wrap">
                 <!-- Explanation will be loaded here -->
             </div>
             <div class="mt-6 flex justify-end gap-3">
                 <button id="close-explanation-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Fechar</button>
             </div>
         </div>
     </div>

    <!-- Fasting Delivery Suggestion Modal -->
    <div id="fasting-suggestion-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-50">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
           <h3 class="text-xl font-bold mb-4 text-white">Sugestão para Entrega do Jejum</h3>
            <div id="fasting-suggestion-result" class="bg-gray-900 rounded-lg p-4 flex-grow overflow-y-auto text-gray-300 text-sm whitespace-pre-wrap">
                <!-- Suggestion will be loaded here -->
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="close-fasting-suggestion-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Presentation Mode Modal -->
    <div id="presentation-modal" class="fixed inset-0 p-4 md:p-8 flex-col hidden z-50">
        <div class="w-full max-w-5xl mx-auto flex-grow flex flex-col h-full">
            <h2 id="presentation-title" class="text-3xl md:text-5xl font-bold text-emerald-400 mb-6 text-center flex-shrink-0"></h2>
            <div id="presentation-content" class="text-lg md:text-xl text-gray-200 leading-loose flex-grow overflow-y-auto p-6 md:p-10 bg-gray-800/50 rounded-lg border border-gray-700 shadow-2xl">
                <!-- Outline content goes here -->
            </div>
             <div class="text-center mt-8 flex-shrink-0">
                <button id="close-presentation-btn" class="py-2 px-6 bg-red-600/80 hover:bg-red-600 text-white rounded-lg transition-colors text-lg font-semibold">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-50">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 id="confirmation-title" class="text-lg font-bold mb-4 text-white">Confirmar Ação</h3>
            <p id="confirmation-message" class="mb-6 text-gray-300"></p>
            <div class="flex justify-end gap-3">
                <button id="cancel-confirmation-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Cancelar</button>
                <button id="confirm-action-btn" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 lg:bottom-5 right-5 bg-emerald-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, query, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CHAVE DA API DE IA ---
        // IMPORTANTE: Para usar no GitHub, substitua pela sua chave da API do Google AI Studio
        // Recomenda-se criar uma chave com restrições de segurança.
        const GEMINI_API_KEY = "";

        // --- Firebase Configuration ---
        // Configuração para funcionar em qualquer ambiente, incluindo GitHub Pages
        const firebaseConfig = {
            apiKey: "AIzaSyCp2CxegdrcOk4Bj6I45_8LOl0nTOt3rEg",
            authDomain: "calendario-de-ministracao.firebaseapp.com",
            projectId: "calendario-de-ministracao",
            storageBucket: "calendario-de-ministracao.appspot.com",
            messagingSenderId: "1091866768883",
            appId: "1:1091866768883:web:9290fd424ff5cbf0980e86",
            measurementId: "G-TBPTMVYF4M"
        };
        const appId = 'default-preaching-app';

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const userIdEl = document.getElementById('user-id');
        const userEmailEl = document.getElementById('user-email');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        let userId = null;
        let outlinesUnsubscribe, engagementsUnsubscribe, fastingUnsubscribe, readingPlanUnsubscribe;
        let appInitialized = false;

        // --- Auth State & App Startup ---
        const main = async () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userEmailEl.textContent = user.isAnonymous ? 'Utilizador Convidado' : user.email || 'Utilizador';
                    userIdEl.textContent = `ID: ${user.uid}`;

                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('flex');
                    loadingOverlay.classList.add('hidden');
                    
                    if (!appInitialized) {
                        initializeAppLogic();
                        appInitialized = true;
                    }
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        let errorMessage = '<p class="text-red-500 text-lg">Falha na autenticação. Verifique a consola para mais detalhes.</p>';
                        if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                            errorMessage = `
                                <div class="text-center max-w-2xl mx-auto">
                                    <p class="text-xl font-bold text-red-400">Ação Necessária: Ativar Login Anónimo</p>
                                    <p class="text-gray-300 mt-2">A aplicação não consegue iniciar porque o método de login "Anónimo" está desativado no seu projeto Firebase.</p>
                                    <p class="text-gray-300 mt-4 font-semibold">Para corrigir, siga estes passos:</p>
                                    <ol class="text-left text-gray-400 mt-2 list-decimal list-inside bg-gray-800 p-4 rounded-lg">
                                        <li>Abra a consola do seu projeto Firebase.</li>
                                        <li>No menu lateral, vá para <strong>Authentication</strong> (Autenticação).</li>
                                        <li>Clique no separador <strong>Sign-in method</strong> (Método de login).</li>
                                        <li>Encontre <strong>Anónimo</strong> na lista de provedores e clique para editar.</li>
                                        <li>Ative o método e clique em <strong>Guardar</strong>.</li>
                                        <li>Depois de guardar, <strong>recarregue esta página</strong>.</li>
                                    </ol>
                                </div>
                            `;
                        }
                        loadingOverlay.innerHTML = `<div class="p-4">${errorMessage}</div>`;
                    });
                }
            });
        };

        main();

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- Main App Logic (to be initialized after login) ---
        function initializeAppLogic() {
            let outlinesCol, engagementsCol, fastingCol;
            let currentDate = new Date();
            let outlines = [], engagements = [], fastingSchedules = [], userReadingProgress = null;
            let currentEditingOutlineId = null, currentSelectedDate = null, currentEditingEngagementId = null;
            let isFocusMode = false;
            let fastingChartInstance = null;


            const BIBLE_BOOKS = [
                "Gênesis", "Êxodo", "Levítico", "Números", "Deuteronômio", "Josué", "Juízes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Crônicas", "2 Crônicas", "Esdras", "Neemias", "Ester", "Jó", "Salmos", "Provérbios", "Eclesiastes", "Cânticos", "Isaías", "Jeremias", "Lamentações", "Ezequiel", "Daniel", "Oséias", "Joel", "Amós", "Obadias", "Jonas", "Miquéias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias",
                "Mateus", "Marcos", "Lucas", "João", "Atos", "Romanos", "1 Coríntios", "2 Coríntios", "Gálatas", "Efésios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Timóteo", "2 Timóteo", "Tito", "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 João", "2 João", "3 João", "Judas", "Apocalipse"
            ];
            
            const OLD_TESTAMENT_BOOKS = BIBLE_BOOKS.slice(0, 39);
            
            const READING_PLANS = {
                completeBible365: {
                    name: "Bíblia Completa em 365 dias",
                    readings: ["Gênesis 1-3", "Gênesis 4-6", "Gênesis 7-9", "Gênesis 10-12", "Gênesis 13-16", "Gênesis 17-19", "Gênesis 20-22", "Gênesis 23-25", "Gênesis 26-28", "Gênesis 29-31", "Gênesis 32-34", "Gênesis 35-37", "Gênesis 38-40", "Gênesis 41-43", "Gênesis 44-46", "Gênesis 47-50", "Êxodo 1-4", "Êxodo 5-7", "Êxodo 8-10", "Êxodo 11-13", "Êxodo 14-16", "Êxodo 17-19", "Êxodo 20-22", "Êxodo 23-25", "Êxodo 26-28", "Êxodo 29-31", "Êxodo 32-34", "Êxodo 35-37", "Êxodo 38-40", "Levítico 1-4", "Levítico 5-7", "Levítico 8-10", "Levítico 11-13", "Levítico 14-16", "Levítico 17-19", "Levítico 20-22", "Levítico 23-25", "Levítico 26-27", "Números 1-3", "Números 4-6", "Números 7-9", "Números 10-12", "Números 13-15", "Números 16-18", "Números 19-21", "Números 22-24", "Números 25-27", "Números 28-30", "Números 31-33", "Números 34-36", "Deuteronômio 1-3", "Deuteronômio 4-6", "Deuteronômio 7-9", "Deuteronômio 10-12", "Deuteronômio 13-15", "Deuteronômio 16-18", "Deuteronômio 19-21", "Deuteronômio 22-24", "Deuteronômio 25-27", "Deuteronômio 28-30", "Deuteronômio 31-34", "Josué 1-4", "Josué 5-8", "Josué 9-12", "Josué 13-16", "Josué 17-20", "Josué 21-24", "Juízes 1-4", "Juízes 5-8", "Juízes 9-12", "Juízes 13-16", "Juízes 17-21", "Rute 1-4", "1 Samuel 1-4", "1 Samuel 5-8", "1 Samuel 9-12", "1 Samuel 13-16", "1 Samuel 17-20", "1 Samuel 21-24", "1 Samuel 25-28", "1 Samuel 29-31", "2 Samuel 1-4", "2 Samuel 5-8", "2 Samuel 9-12", "2 Samuel 13-16", "2 Samuel 17-20", "2 Samuel 21-24", "1 Reis 1-4", "1 Reis 5-8", "1 Reis 9-12", "1 Reis 13-16", "1 Reis 17-20", "1 Reis 21-22", "2 Reis 1-4", "2 Reis 5-8", "2 Reis 9-12", "2 Reis 13-16", "2 Reis 17-20", "2 Reis 21-25", "1 Crônicas 1-4", "1 Crônicas 5-8", "1 Crônicas 9-12", "1 Crônicas 13-16", "1 Crônicas 17-20", "1 Crônicas 21-24", "1 Crônicas 25-29", "2 Crônicas 1-5", "2 Crônicas 6-9", "2 Crônicas 10-14", "2 Crônicas 15-19", "2 Crônicas 20-24", "2 Crônicas 25-29", "2 Crônicas 30-33", "2 Crônicas 34-36", "Esdras 1-5", "Esdras 6-10", "Neemias 1-4", "Neemias 5-8", "Neemias 9-13", "Ester 1-5", "Ester 6-10", "Jó 1-5", "Jó 6-10", "Jó 11-15", "Jó 16-20", "Jó 21-25", "Jó 26-30", "Jó 31-35", "Jó 36-42", "Salmos 1-10", "Salmos 11-20", "Salmos 21-30", "Salmos 31-40", "Salmos 41-50", "Salmos 51-60", "Salmos 61-70", "Salmos 71-80", "Salmos 81-90", "Salmos 91-100", "Salmos 101-110", "Salmos 111-119", "Salmos 120-135", "Salmos 136-150", "Provérbios 1-5", "Provérbios 6-10", "Provérbios 11-15", "Provérbios 16-20", "Provérbios 21-25", "Provérbios 26-31", "Eclesiastes 1-6", "Eclesiastes 7-12", "Cânticos 1-8", "Isaías 1-5", "Isaías 6-10", "Isaías 11-15", "Isaías 16-20", "Isaías 21-25", "Isaías 26-30", "Isaías 31-35", "Isaías 36-40", "Isaías 41-45", "Isaías 46-50", "Isaías 51-55", "Isaías 56-60", "Isaías 61-66", "Jeremias 1-5", "Jeremias 6-10", "Jeremias 11-15", "Jeremias 16-20", "Jeremias 21-25", "Jeremias 26-30", "Jeremias 31-35", "Jeremias 36-40", "Jeremias 41-45", "Jeremias 46-52", "Lamentações 1-5", "Ezequiel 1-5", "Ezequiel 6-10", "Ezequiel 11-15", "Ezequiel 16-20", "Ezequiel 21-25", "Ezequiel 26-30", "Ezequiel 31-35", "Ezequiel 36-40", "Ezequiel 41-48", "Daniel 1-6", "Daniel 7-12", "Oséias 1-7", "Oséias 8-14", "Joel 1-3", "Amós 1-9", "Obadias 1", "Jonas 1-4", "Miquéias 1-7", "Naum 1-3", "Habacuque 1-3", "Sofonias 1-3", "Ageu 1-2", "Zacarias 1-7", "Zacarias 8-14", "Malaquias 1-4", "Mateus 1-4", "Mateus 5-7", "Mateus 8-10", "Mateus 11-13", "Mateus 14-16", "Mateus 17-19", "Mateus 20-22", "Mateus 23-25", "Mateus 26-28", "Marcos 1-4", "Marcos 5-8", "Marcos 9-12", "Marcos 13-16", "Lucas 1-3", "Lucas 4-6", "Lucas 7-9", "Lucas 10-12", "Lucas 13-15", "Lucas 16-18", "Lucas 19-21", "Lucas 22-24", "João 1-4", "João 5-8", "João 9-12", "João 13-16", "João 17-21", "Atos 1-4", "Atos 5-8", "Atos 9-12", "Atos 13-16", "Atos 17-20", "Atos 21-24", "Atos 25-28", "Romanos 1-4", "Romanos 5-8", "Romanos 9-12", "Romanos 13-16", "1 Coríntios 1-4", "1 Coríntios 5-8", "1 Coríntios 9-12", "1 Coríntios 13-16", "2 Coríntios 1-6", "2 Coríntios 7-13", "Gálatas 1-6", "Efésios 1-6", "Filipenses 1-4", "Colossenses 1-4", "1 Tessalonicenses 1-5", "2 Tessalonicenses 1-3", "1 Timóteo 1-6", "2 Timóteo 1-4", "Tito 1-3", "Filemom 1", "Hebreus 1-6", "Hebreus 7-10", "Hebreus 11-13", "Tiago 1-5", "1 Pedro 1-5", "2 Pedro 1-3", "1 João 1-5", "2 João 1", "3 João 1", "Judas 1", "Apocalipse 1-5", "Apocalipse 6-11", "Apocalipse 12-17", "Apocalipse 18-22"]
                },
                oldTestament270: {
                    name: "Antigo Testamento em 270 dias",
                    readings: ["Gênesis 1-3", "Gênesis 4-6", "Gênesis 7-9", "Gênesis 10-12", "Gênesis 13-16", "Gênesis 17-19", "Gênesis 20-22", "Gênesis 23-25", "Gênesis 26-28", "Gênesis 29-31", "Gênesis 32-34", "Gênesis 35-37", "Gênesis 38-40", "Gênesis 41-43", "Gênesis 44-46", "Gênesis 47-50", "Êxodo 1-4", "Êxodo 5-7", "Êxodo 8-10", "Êxodo 11-13", "Êxodo 14-16", "Êxodo 17-19", "Êxodo 20-22", "Êxodo 23-25", "Êxodo 26-28", "Êxodo 29-31", "Êxodo 32-34", "Êxodo 35-37", "Êxodo 38-40", "Levítico 1-4", "Levítico 5-7", "Levítico 8-10", "Levítico 11-13", "Levítico 14-16", "Levítico 17-19", "Levítico 20-22", "Levítico 23-25", "Levítico 26-27", "Números 1-3", "Números 4-6", "Números 7-9", "Números 10-12", "Números 13-15", "Números 16-18", "Números 19-21", "Números 22-24", "Números 25-27", "Números 28-30", "Números 31-33", "Números 34-36", "Deuteronômio 1-3", "Deuteronômio 4-6", "Deuteronômio 7-9", "Deuteronômio 10-12", "Deuteronômio 13-15", "Deuteronômio 16-18", "Deuteronômio 19-21", "Deuteronômio 22-24", "Deuteronômio 25-27", "Deuteronômio 28-30", "Deuteronômio 31-34", "Josué 1-4", "Josué 5-8", "Josué 9-12", "Josué 13-16", "Josué 17-20", "Josué 21-24", "Juízes 1-4", "Juízes 5-8", "Juízes 9-12", "Juízes 13-16", "Juízes 17-21", "Rute 1-4", "1 Samuel 1-4", "1 Samuel 5-8", "1 Samuel 9-12", "1 Samuel 13-16", "1 Samuel 17-20", "1 Samuel 21-24", "1 Samuel 25-28", "1 Samuel 29-31", "2 Samuel 1-4", "2 Samuel 5-8", "2 Samuel 9-12", "2 Samuel 13-16", "2 Samuel 17-20", "2 Samuel 21-24", "1 Reis 1-4", "1 Reis 5-8", "1 Reis 9-12", "1 Reis 13-16", "1 Reis 17-20", "1 Reis 21-22", "2 Reis 1-4", "2 Reis 5-8", "2 Reis 9-12", "2 Reis 13-16", "2 Reis 17-20", "2 Reis 21-25", "1 Crônicas 1-4", "1 Crônicas 5-8", "1 Crônicas 9-12", "1 Crônicas 13-16", "1 Crônicas 17-20", "1 Crônicas 21-24", "1 Crônicas 25-29", "2 Crônicas 1-5", "2 Crônicas 6-9", "2 Crônicas 10-14", "2 Crônicas 15-19", "2 Crônicas 20-24", "2 Crônicas 25-29", "2 Crônicas 30-33", "2 Crônicas 34-36", "Esdras 1-5", "Esdras 6-10", "Neemias 1-4", "Neemias 5-8", "Neemias 9-13", "Ester 1-5", "Ester 6-10", "Jó 1-5", "Jó 6-10", "Jó 11-15", "Jó 16-20", "Jó 21-25", "Jó 26-30", "Jó 31-35", "Jó 36-42", "Salmos 1-10", "Salmos 11-20", "Salmos 21-30", "Salmos 31-40", "Salmos 41-50", "Salmos 51-60", "Salmos 61-70", "Salmos 71-80", "Salmos 81-90", "Salmos 91-100", "Salmos 101-110", "Salmos 111-119", "Salmos 120-135", "Salmos 136-150", "Provérbios 1-5", "Provérbios 6-10", "Provérbios 11-15", "Provérbios 16-20", "Provérbios 21-25", "Provérbios 26-31", "Eclesiastes 1-6", "Eclesiastes 7-12", "Cânticos 1-8", "Isaías 1-5", "Isaías 6-10", "Isaías 11-15", "Isaías 16-20", "Isaías 21-25", "Isaías 26-30", "Isaías 31-35", "Isaías 36-40", "Isaías 41-45", "Isaías 46-50", "Isaías 51-55", "Isaías 56-60", "Isaías 61-66", "Jeremias 1-5", "Jeremias 6-10", "Jeremias 11-15", "Jeremias 16-20", "Jeremias 21-25", "Jeremias 26-30", "Jeremias 31-35", "Jeremias 36-40", "Jeremias 41-45", "Jeremias 46-52", "Lamentações 1-5", "Ezequiel 1-5", "Ezequiel 6-10", "Ezequiel 11-15", "Ezequiel 16-20", "Ezequiel 21-25", "Ezequiel 26-30", "Ezequiel 31-35", "Ezequiel 36-40", "Ezequiel 41-48", "Daniel 1-6", "Daniel 7-12", "Oséias 1-7", "Oséias 8-14", "Joel 1-3", "Amós 1-9", "Obadias 1", "Jonas 1-4", "Miquéias 1-7", "Naum 1-3", "Habacuque 1-3", "Sofonias 1-3", "Ageu 1-2", "Zacarias 1-7", "Zacarias 8-14", "Malaquias 1-4"]
                },
                newTestament90: {
                    name: "Novo Testamento em 90 dias",
                    readings: ["Mateus 1-4", "Mateus 5-7", "Mateus 8-10", "Mateus 11-13", "Mateus 14-16", "Mateus 17-19", "Mateus 20-22", "Mateus 23-25", "Mateus 26-28", "Marcos 1-4", "Marcos 5-8", "Marcos 9-12", "Marcos 13-16", "Lucas 1-3", "Lucas 4-6", "Lucas 7-9", "Lucas 10-12", "Lucas 13-15", "Lucas 16-18", "Lucas 19-21", "Lucas 22-24", "João 1-4", "João 5-8", "João 9-12", "João 13-16", "João 17-21", "Atos 1-4", "Atos 5-8", "Atos 9-12", "Atos 13-16", "Atos 17-20", "Atos 21-24", "Atos 25-28", "Romanos 1-4", "Romanos 5-8", "Romanos 9-12", "Romanos 13-16", "1 Coríntios 1-4", "1 Coríntios 5-8", "1 Coríntios 9-12", "1 Coríntios 13-16", "2 Coríntios 1-6", "2 Coríntios 7-13", "Gálatas 1-6", "Efésios 1-6", "Filipenses 1-4", "Colossenses 1-4", "1 Tessalonicenses 1-5", "2 Tessalonicenses 1-3", "1 Timóteo 1-6", "2 Timóteo 1-4", "Tito 1-3", "Filemom 1", "Hebreus 1-6", "Hebreus 7-10", "Hebreus 11-13", "Tiago 1-5", "1 Pedro 1-5", "2 Pedro 1-3", "1 João 1-5", "2 João 1", "3 João 1", "Judas 1", "Apocalipse 1-5", "Apocalipse 6-11", "Apocalipse 12-17", "Apocalipse 18-22"]
                }
            };

            const monthYearEl = document.getElementById('month-year');
            const calendarGridEl = document.getElementById('calendar-grid');
            const saveOutlineBtn = document.getElementById('save-outline-btn');
            const outlineTitleEl = document.getElementById('outline-title');
            const outlineContentEl = document.getElementById('outline-content');
            const outlineNotesEl = document.getElementById('outline-notes');
            const bibleBookSelectEl = document.getElementById('bible-book-select');
            const archiveListEl = document.getElementById('archive-list');
            const modalOutlineSelectEl = document.getElementById('modal-outline-select');
            const engagementsListEl = document.getElementById('engagements-list');
            const editorTitleEl = document.getElementById('editor-title');
            const bibleStudyBookSelectEl = document.getElementById('bible-study-book-select');
            const verseDisplayEl = document.getElementById('verse-display');
            const bibleRefInputEl = document.getElementById('bible-ref-input');
            const fastingListEl = document.getElementById('fasting-list');
            const fastingTitleEl = document.getElementById('fasting-title');
            const fastingStartDateEl = document.getElementById('fasting-start-date');
            const fastingEndDateEl = document.getElementById('fasting-end-date');
            const fastingNotesEl = document.getElementById('fasting-notes');
            const fastingTypeEl = document.getElementById('fasting-type'); 
            const suggestionModalEl = document.getElementById('suggestion-modal');
            const suggestionThemeInputEl = document.getElementById('suggestion-theme-input');
            const suggestionBaseTextInputEl = document.getElementById('suggestion-base-text-input');
            const suggestionAudienceSelectEl = document.getElementById('suggestion-audience-select');
            const suggestionToneSelectEl = document.getElementById('suggestion-tone-select');
            const suggestionResultEl = document.getElementById('suggestion-result');
            const useSuggestionBtn = document.getElementById('use-suggestion-btn');
            const generateSuggestionBtn = document.getElementById('generate-suggestion-btn');
            const engagementModalEl = document.getElementById('engagement-modal');
            const modalDateEl = document.getElementById('modal-date');
            const engagementTitleEl = document.getElementById('engagement-title');
            const deleteEngagementBtn = document.getElementById('delete-engagement');
            const presentationModalEl = document.getElementById('presentation-modal');
            const presentationTitleEl = document.getElementById('presentation-title');
            const presentationContentEl = document.getElementById('presentation-content');
            const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
            const mainViewNav = document.getElementById('main-view-nav');
            const mainPanels = document.querySelectorAll('.main-panel');
            const confirmationModalEl = document.getElementById('confirmation-modal');
            const confirmationMessageEl = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
            
            const openStudyToolsBtn = document.getElementById('open-study-tools-btn');
            const closeStudyToolsBtn = document.getElementById('close-study-tools-btn');
            const studyToolsArea = document.getElementById('study-tools-area');
            const editorArea = document.getElementById('editor-area');
            const studySubTabs = document.getElementById('study-sub-tabs');
            const studySubtabPanes = document.querySelectorAll('.study-subtab-pane');
            const topicalThemeInput = document.getElementById('topical-theme-input');
            const fetchTopicBtn = document.getElementById('fetch-topic-btn');
            const topicalResultsDisplay = document.getElementById('topical-results-display');
            const explanationModal = document.getElementById('explanation-modal');
            const explanationTitle = document.getElementById('explanation-title');
            const explanationResult = document.getElementById('explanation-result');
            const closeExplanationBtn = document.getElementById('close-explanation-btn');
            const toggleFocusModeBtn = document.getElementById('toggle-focus-mode-btn');
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const centerPanel = document.getElementById('center-panel');
            const readingPlanSelect = document.getElementById('reading-plan-select');
            const readingPlanSummary = document.getElementById('reading-plan-summary');
            const readingPlanList = document.getElementById('reading-plan-list');
            const achievementsList = document.getElementById('achievements-list');
            const readingModal = document.getElementById('reading-modal');
            const readingModalTitle = document.getElementById('reading-modal-title');
            const readingModalText = document.getElementById('reading-modal-text');
            const readingModalExplanation = document.getElementById('reading-modal-explanation');
            const closeReadingModalBtn = document.getElementById('close-reading-modal-btn');
            const clearStudyResultsBtn = document.getElementById('clear-study-results-btn');
            const commentaryBookSelect = document.getElementById('bible-commentary-book-select');
            const commentaryChapterInput = document.getElementById('bible-chapter-input');
            const fetchCommentaryBtn = document.getElementById('fetch-commentary-btn');
            const commentaryResultsDisplay = document.getElementById('commentary-results-display');
            const copyExplanationBtn = document.getElementById('copy-explanation-btn');
            const fastingHistoryEl = document.getElementById('fasting-history');
            const activeFastTimerEl = document.getElementById('active-fast-timer');
            const activeFastTitleEl = document.getElementById('active-fast-title');
            const timerDisplayEl = document.getElementById('timer-display');
            const suggestDeliveryBtn = document.getElementById('suggest-delivery-btn');
            const fastingSuggestionModalEl = document.getElementById('fasting-suggestion-modal');
            const fastingSuggestionResultEl = document.getElementById('fasting-suggestion-result');
            const closeFastingSuggestionBtn = document.getElementById('close-fasting-suggestion-btn');
            const fastingSummaryEl = document.getElementById('fasting-summary');


            let confirmationCallback = null;

            const showConfirmationModal = (message, callback) => {
                confirmationMessageEl.textContent = message;
                confirmationCallback = callback;
                confirmationModalEl.classList.remove('hidden');
                confirmationModalEl.classList.add('flex');
            };

            const hideConfirmationModal = () => {
                confirmationModalEl.classList.add('hidden');
                confirmationModalEl.classList.remove('flex');
                confirmationCallback = null;
            };

            confirmActionBtn.addEventListener('click', () => {
                if (confirmationCallback) {
                    confirmationCallback();
                }
                hideConfirmationModal();
            });

            cancelConfirmationBtn.addEventListener('click', hideConfirmationModal);

            const showToast = (message) => {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.remove('opacity-0', 'translate-y-20');
                toast.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-20');
                    toast.classList.remove('opacity-100', 'translate-y-0');
                }, 3000);
            };

            const formatText = (command, value = null) => {
                document.execCommand(command, false, value);
                outlineContentEl.focus();
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                monthYearEl.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${year}`;
                calendarGridEl.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGridEl.innerHTML += `<div class="p-2"></div>`;
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                    const dayEngagements = engagements.filter(e => e.date === dateStr);
                    const dayEl = document.createElement('div');
                    dayEl.className = `calendar-day cursor-pointer flex flex-col items-center justify-center h-12 md:h-16 rounded-lg border border-transparent ${isToday ? 'bg-emerald-500 text-white font-bold' : 'hover:border-emerald-400'}`;
                    dayEl.dataset.date = dateStr;
                    dayEl.innerHTML = `<span>${day}</span><div class="flex gap-1 mt-1">${dayEngagements.map(() => `<div class="event-dot"></div>`).join('')}</div>`;
                    dayEl.addEventListener('click', () => openEngagementModal(dateStr));
                    calendarGridEl.appendChild(dayEl);
                }
            };

            const downloadOutline = (outlineId) => {
                const outline = outlines.find(o => o.id === outlineId);
                if (!outline) return;

                const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${outline.title}</title></head><body>`;
                const footer = "</body></html>";
                
                let contentHtml = `<h1>${outline.title}</h1>`;
                contentHtml += `<p><strong>Livro:</strong> ${outline.book}</p><br>`;
                contentHtml += `<h2>Esboço</h2>`;
                contentHtml += `<div>${outline.content}</div>`;

                if (outline.notes) {
                    contentHtml += `<br><h2>Notas e Ilustrações</h2>`;
                    contentHtml += `<p>${outline.notes.replace(/\n/g, '<br>')}</p>`;
                }
                
                const source = header + contentHtml + footer;

                const fileDownload = htmlDocx.asBlob(source);
                
                const url = URL.createObjectURL(fileDownload);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${outline.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('A baixar o esboço...');
            };

            const printOutline = (outlineId) => {
                const outline = outlines.find(o => o.id === outlineId);
                if (!outline) return;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Imprimir Esboço</title>');
                printWindow.document.write(`
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Georgia&family=Helvetica&display=swap');
                        body { 
                            font-family: 'Georgia', serif; 
                            line-height: 1.6;
                            margin: 40px;
                        } 
                        h1, h2 {
                            font-family: 'Helvetica', sans-serif;
                            color: #222; 
                            border-bottom: 2px solid #333;
                            padding-bottom: 8px;
                            margin-top: 24px;
                        }
                        h1 { font-size: 24pt; }
                        h2 { font-size: 18pt; }
                        p, div, li { font-size: 12pt; }
                        strong { font-weight: bold; }
                        em, i { font-style: italic; }
                        u { text-decoration: underline; }
                    </style>
                `);
                printWindow.document.write('</head><body>');
                printWindow.document.write(`<h1>${outline.title}</h1>`);
                printWindow.document.write(`<p><strong>Livro:</strong> ${outline.book}</p>`);
                printWindow.document.write('<h2>Esboço</h2>');
                printWindow.document.write(`<div>${outline.content}</div>`);
                if(outline.notes) {
                    printWindow.document.write('<h2>Notas e Ilustrações</h2>');
                    printWindow.document.write(`<p>${outline.notes.replace(/\n/g, '<br>')}</p>`);
                }
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            };

            const renderOutlines = () => {
                archiveListEl.innerHTML = '';
                modalOutlineSelectEl.innerHTML = '<option value="">Nenhum (somente agendar)</option>';
                const groupedOutlines = BIBLE_BOOKS.reduce((acc, book) => {
                    const bookOutlines = outlines.filter(o => o.book === book);
                    if (bookOutlines.length > 0) acc[book] = bookOutlines;
                    return acc;
                }, {});
                if (outlines.length === 0) {
                    archiveListEl.innerHTML = '<p class="text-gray-400 text-sm">Nenhum esboço salvo ainda.</p>';
                }
                for (const book in groupedOutlines) {
                    const bookSection = document.createElement('div');
                    bookSection.innerHTML = `<h3 class="text-lg font-semibold text-emerald-400">${book}</h3>`;
                    const list = document.createElement('ul');
                    list.className = 'ml-4 space-y-1';
                    groupedOutlines[book].forEach(outline => {
                        const li = document.createElement('li');
                        li.className = 'text-gray-300 hover:text-white flex justify-between items-center group';
                        li.innerHTML = `
                            <span class="cursor-pointer flex-grow pr-4"><i class="fas fa-file-alt mr-2 text-gray-500"></i>${outline.title}</span>
                            <div class="flex items-center gap-4 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                                <button data-id="${outline.id}" class="print-outline-btn text-sky-400 hover:text-sky-300" title="Imprimir"><i class="fas fa-print"></i></button>
                                <button data-id="${outline.id}" class="download-outline-btn text-emerald-400 hover:text-emerald-300" title="Baixar como DOCX"><i class="fas fa-file-word"></i></button>
                                <button data-id="${outline.id}" class="delete-outline-btn text-red-500 hover:text-red-400" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        
                        li.querySelector('span').addEventListener('click', () => loadOutlineIntoEditor(outline.id));
                        li.querySelector('.print-outline-btn').addEventListener('click', (e) => { e.stopPropagation(); printOutline(outline.id); });
                        li.querySelector('.download-outline-btn').addEventListener('click', (e) => { e.stopPropagation(); downloadOutline(outline.id); });
                        li.querySelector('.delete-outline-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            showConfirmationModal('Tem certeza que deseja excluir este esboço?', async () => {
                               await deleteDoc(doc(outlinesCol, outline.id));
                               showToast('Esboço excluído.');
                               if(currentEditingOutlineId === outline.id) clearEditor();
                            });
                        });
                        list.appendChild(li);
                    });
                    bookSection.appendChild(list);
                    archiveListEl.appendChild(bookSection);
                }
                outlines.forEach(outline => modalOutlineSelectEl.add(new Option(outline.title, outline.id)));
            };
        
            const renderEngagementsList = () => {
                const sortedEngagements = [...engagements].filter(e => new Date(e.date) >= new Date(new Date().toDateString())).sort((a, b) => new Date(a.date) - new Date(b.date));
                if(sortedEngagements.length === 0) {
                    engagementsListEl.innerHTML = '<p class="text-gray-400 text-sm">Nenhuma ministração agendada.</p>';
                    return;
                }
                engagementsListEl.innerHTML = sortedEngagements.map(e => {
                    const outline = outlines.find(o => o.id === e.outlineId);
                    const date = new Date(`${e.date}T12:00:00Z`);
                    const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', timeZone: 'UTC' });
                    return `<div class="p-2 rounded-lg hover:bg-gray-700 cursor-pointer" data-engagement-id="${e.id}"><p class="font-semibold text-white">${formattedDate} - ${e.title}</p><p class="text-sm text-gray-400">${outline ? outline.title : 'Sem esboço vinculado'}</p></div>`;
                }).join('');
                document.querySelectorAll('#engagements-list [data-engagement-id]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const engagementId = e.currentTarget.dataset.engagementId;
                        const engagement = engagements.find(eng => eng.id === engagementId);
                        if (engagement && engagement.outlineId) {
                            openPresentationMode(engagement.outlineId);
                        } else {
                            showToast("Este agendamento não tem um esboço vinculado.");
                        }
                    });
                });
            };

            const renderFastingSchedules = () => {
                const now = new Date();
                
                const sortedSchedules = [...fastingSchedules].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                const activeAndFuture = sortedSchedules.filter(item => new Date(item.endDate) >= now);
                const past = sortedSchedules
                    .filter(item => new Date(item.endDate) < now)
                    .sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
                
                if (activeAndFuture.length === 0) {
                    fastingListEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Nenhum propósito ativo ou futuro.</p>';
                } else {
                    fastingListEl.innerHTML = activeAndFuture.map(item => {
                        const startDate = new Date(item.startDate);
                        const endDate = new Date(item.endDate);
                        const formattedStartDate = startDate.toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                        const formattedEndDate = endDate.toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                        
                        let typeBadge = '';
                        if (item.type === 'Jejum') {
                            typeBadge = '<span class="text-xs bg-red-500/50 text-red-300 px-2 py-0.5 rounded-full">Jejum</span>';
                        } else if (item.type === 'Oração') {
                            typeBadge = '<span class="text-xs bg-sky-500/50 text-sky-300 px-2 py-0.5 rounded-full">Oração</span>';
                        } else {
                            typeBadge = '<span class="text-xs bg-purple-500/50 text-purple-300 px-2 py-0.5 rounded-full">Jejum e Oração</span>';
                        }

                        return `<div class="bg-gray-800 p-3 rounded-lg group"><div class="flex justify-between items-start"><div><div class="flex items-center gap-2 mb-1">${typeBadge}<p class="font-semibold text-white">${item.title}</p></div><p class="text-xs text-emerald-400">${formattedStartDate} até ${formattedEndDate}</p></div><button data-id="${item.id}" class="delete-fasting-btn text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-sm"><i class="fas fa-trash"></i></button></div><p class="text-sm text-gray-300 mt-2">${item.notes || ''}</p></div>`;
                    }).join('');
                }

                if (past.length === 0) {
                    fastingHistoryEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Nenhum jejum concluído.</p>';
                } else {
                    fastingHistoryEl.innerHTML = past.map(item => {
                         const startDate = new Date(item.startDate).toLocaleDateString('pt-BR');
                        const endDate = new Date(item.endDate).toLocaleDateString('pt-BR');
                        return `<div class="bg-gray-900/50 p-3 rounded-lg opacity-70"><p class="font-semibold text-gray-300">${item.title}</p><p class="text-xs text-gray-400">${startDate} até ${endDate}</p></div>`;
                    }).join('');
                }

                // Update summary and chart
                const totalJejum = past.filter(i => i.type === 'Jejum').length;
                const totalOracao = past.filter(i => i.type === 'Oração').length;
                const totalAmbos = past.filter(i => i.type === 'Jejum e Oração').length;
                
                fastingSummaryEl.innerHTML = `
                    <div class="bg-red-500/20 p-2 rounded">
                        <p class="text-xs text-red-300">Jejuns</p>
                        <p class="text-xl font-bold">${totalJejum}</p>
                    </div>
                    <div class="bg-sky-500/20 p-2 rounded">
                        <p class="text-xs text-sky-300">Orações</p>
                        <p class="text-xl font-bold">${totalOracao}</p>
                    </div>
                     <div class="bg-purple-500/20 p-2 rounded">
                        <p class="text-xs text-purple-300">Ambos</p>
                        <p class="text-xl font-bold">${totalAmbos}</p>
                    </div>
                `;

                renderFastingChart(past);

                document.querySelectorAll('.delete-fasting-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.currentTarget.dataset.id;
                        showConfirmationModal('Deseja excluir este propósito?', async () => {
                            await deleteDoc(doc(fastingCol, id));
                            showToast('Propósito excluído.');
                        });
                    });
                });
            };

            const renderFastingChart = (pastData) => {
                const ctx = document.getElementById('fasting-chart').getContext('2d');
                if (fastingChartInstance) {
                    fastingChartInstance.destroy();
                }

                if (pastData.length === 0) return; 

                const sortedData = [...pastData].reverse();

                const labels = sortedData.map(item => new Date(item.endDate).toLocaleDateString('pt-br', { month: 'short', day: 'numeric'}));
                const jejumData = sortedData.map(item => (item.type === 'Jejum' ? (new Date(item.endDate) - new Date(item.startDate)) / (1000 * 60 * 60) : 0));
                const oracaoData = sortedData.map(item => (item.type === 'Oração' ? (new Date(item.endDate) - new Date(item.startDate)) / (1000 * 60 * 60) : 0));
                const ambosData = sortedData.map(item => (item.type === 'Jejum e Oração' ? (new Date(item.endDate) - new Date(item.startDate)) / (1000 * 60 * 60) : 0));

                fastingChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Jejum',
                                data: jejumData,
                                backgroundColor: 'rgba(239, 68, 68, 0.6)', // Red
                            },
                            {
                                label: 'Oração',
                                data: oracaoData,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)', // Blue
                            },
                            {
                                label: 'Jejum e Oração',
                                data: ambosData,
                                backgroundColor: 'rgba(168, 85, 247, 0.6)', // Purple
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Duração (horas)', color: '#9ca3af' },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(156, 163, 175, 0.1)' }
                            },
                            x: {
                                stacked: true, 
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(156, 163, 175, 0.1)' },
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#d1d5db' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.parsed.y === 0) return null;
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(1) + 'h';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            const renderVerseDisplayPlaceholder = () => {
                if(verseDisplayEl.children.length === 0) {
                    verseDisplayEl.innerHTML = '<p class="text-gray-500 italic flex items-center justify-center h-full w-full text-center">Consulte um versículo...</p>';
                }
                if (topicalResultsDisplay.children.length === 0) {
                   topicalResultsDisplay.innerHTML = '<p class="text-gray-500 italic flex items-center justify-center h-full">Pesquise um tema para ver os versículos.</p>';
                }
                 if (commentaryResultsDisplay.children.length === 0) {
                   commentaryResultsDisplay.innerHTML = '<p class="text-gray-500 italic flex items-center justify-center h-full">Selecione um livro e capítulo.</p>';
                }
            };
            
            const setupFirebaseListeners = () => {
                 outlinesCol = collection(db, `artifacts/${appId}/users/${userId}/outlines`);
                 engagementsCol = collection(db, `artifacts/${appId}/users/${userId}/engagements`);
                 fastingCol = collection(db, `artifacts/${appId}/users/${userId}/fastingSchedules`);
                 outlinesUnsubscribe = onSnapshot(query(outlinesCol), (snapshot) => {
                     outlines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.title.localeCompare(b.title));
                     renderOutlines();
                     renderEngagementsList();
                 });
                 engagementsUnsubscribe = onSnapshot(query(engagementsCol), (snapshot) => {
                     engagements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     renderCalendar();
                     renderEngagementsList();
                 });
                 fastingUnsubscribe = onSnapshot(query(fastingCol), (snapshot) => {
                     fastingSchedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     renderFastingSchedules();
                 });
                 const readingPlanDoc = doc(db, `artifacts/${appId}/users/${userId}/readingPlan/progress`);
                 readingPlanUnsubscribe = onSnapshot(readingPlanDoc, (snapshot) => {
                     if (snapshot.exists()) {
                         userReadingProgress = snapshot.data();
                     } else {
                         // Initialize with book progress structure
                         const initialBookProgress = {};
                         BIBLE_BOOKS.forEach(book => initialBookProgress[book] = { readCount: 0 });
                         userReadingProgress = { activePlan: null, completedDays: [], achievements: [], bookProgress: initialBookProgress };
                     }
                     // Ensure bookProgress exists for older users
                     if (!userReadingProgress.bookProgress) {
                         const initialBookProgress = {};
                         BIBLE_BOOKS.forEach(book => initialBookProgress[book] = { readCount: 0 });
                         userReadingProgress.bookProgress = initialBookProgress;
                     }
                     renderReadingPlan();
                 });
            };
            
            const changeMonth = (offset) => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                renderCalendar();
            };

            const saveOutline = async () => {
                const title = outlineTitleEl.value.trim();
                const content = outlineContentEl.innerHTML;
                const notes = outlineNotesEl.value.trim();
                const book = bibleBookSelectEl.value;
                if (!title || !content) {
                    showToast('Preencha o título e o conteúdo.');
                    return;
                }
                const outlineData = { title, content, notes, book, updatedAt: new Date() };
                if (currentEditingOutlineId) {
                    await setDoc(doc(outlinesCol, currentEditingOutlineId), outlineData, { merge: true });
                    showToast('Esboço atualizado com sucesso!');
                } else {
                    const newDoc = await addDoc(outlinesCol, outlineData);
                    currentEditingOutlineId = newDoc.id; // Keep editing the same doc after first save
                    editorTitleEl.textContent = 'Editando Esboço';
                    showToast('Esboço salvo com sucesso!');
                }
            };

            const loadOutlineIntoEditor = (id) => {
                const outline = outlines.find(o => o.id === id);
                if (outline) {
                    currentEditingOutlineId = id;
                    outlineTitleEl.value = outline.title;
                    outlineContentEl.innerHTML = outline.content;
                    outlineNotesEl.value = outline.notes || '';
                    bibleBookSelectEl.value = outline.book;
                    editorTitleEl.textContent = 'Editando Esboço';
                }
                switchMainView('center-panel');
            };

            const clearEditor = () => {
                currentEditingOutlineId = null;
                outlineTitleEl.value = '';
                outlineContentEl.innerHTML = '';
                outlineNotesEl.value = '';
                bibleBookSelectEl.value = BIBLE_BOOKS[0];
                editorTitleEl.textContent = 'Novo Esboço';
                outlineTitleEl.focus();
            };

            const openEngagementModal = (dateStr) => {
                currentSelectedDate = dateStr;
                const engagement = engagements.find(e => e.date === dateStr);
                const date = new Date(`${dateStr}T12:00:00Z`);
                modalDateEl.textContent = date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
                if (engagement) {
                    currentEditingEngagementId = engagement.id;
                    engagementTitleEl.value = engagement.title;
                    modalOutlineSelectEl.value = engagement.outlineId || '';
                    deleteEngagementBtn.classList.remove('hidden');
                } else {
                    currentEditingEngagementId = null;
                    engagementTitleEl.value = '';
                    modalOutlineSelectEl.value = '';
                    deleteEngagementBtn.classList.add('hidden');
                }
                engagementModalEl.classList.remove('hidden');
                engagementModalEl.classList.add('flex');
            };

            const closeEngagementModal = () => {
                engagementModalEl.classList.add('hidden');
                engagementModalEl.classList.remove('flex');
            };
            
            const handleSaveEngagement = async () => {
                const title = engagementTitleEl.value.trim();
                const outlineId = modalOutlineSelectEl.value;
                if (!title) {
                    showToast('Por favor, preencha o título.');
                    return;
                }
                const engagementData = { date: currentSelectedDate, title: title, outlineId: outlineId };
                if (currentEditingEngagementId) {
                    await setDoc(doc(engagementsCol, currentEditingEngagementId), engagementData, { merge: true });
                } else {
                    await addDoc(engagementsCol, engagementData);
                }
                showToast('Agendamento salvo!');
                closeEngagementModal();
            };
            
            const handleDeleteEngagement = async () => {
                if (currentEditingEngagementId) {
                    showConfirmationModal('Tem certeza que deseja excluir este agendamento?', async () => {
                        await deleteDoc(doc(engagementsCol, currentEditingEngagementId));
                        showToast('Agendamento excluído.');
                        closeEngagementModal();
                    });
                }
            }
            
            const saveFastingSchedule = async () => {
                const title = fastingTitleEl.value.trim();
                const type = fastingTypeEl.value;
                const startDate = fastingStartDateEl.value;
                const endDate = fastingEndDateEl.value;
                const notes = fastingNotesEl.value.trim();
                if (!title || !startDate || !endDate || !type) {
                    showToast('Preencha o propósito, tipo e as datas/horas.');
                    return;
                }
                const scheduleData = { title, type, startDate, endDate, notes, createdAt: new Date() };
                await addDoc(fastingCol, scheduleData);
                showToast('Propósito salvo!');
                fastingTitleEl.value = '';
                fastingStartDateEl.value = '';
                fastingEndDateEl.value = '';
                fastingNotesEl.value = '';
            };

            const fetchVerse = async (referenceOverride = null, targetElement = verseDisplayEl, isTopicalSearch = false, isModal = false) => {
                let reference;
                if (referenceOverride) {
                    reference = referenceOverride;
                } else {
                    const book = bibleStudyBookSelectEl.value;
                    const userInput = bibleRefInputEl.value.trim();
                    if (!userInput) return;
                    reference = /[a-zA-ZáéíóúâêîôûãõçÁÉÍÓÚÂÊÎÔÛÃÕÇ]/.test(userInput) ? userInput : `${book} ${userInput}`;
                }
                
                targetElement.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando ${reference}...</div>`;

                try {
                    const response = await fetch(`https://bible-api.com/${reference}?translation=almeida`);
                    if (!response.ok) throw new Error('Referência não encontrada.');
                    const data = await response.json();
                    
                    const verseText = data.verses ? data.verses.map(v => `${v.verse} ${v.text}`).join('\n') : data.text;
                    let verseContentHTML = data.verses ? data.verses.map(v => `<p class="mb-2"><strong>${v.verse}</strong>&nbsp;${v.text}</p>`).join('') : `<p>${data.text}</p>`;
                    
                    if(isModal) {
                        targetElement.innerHTML = `<h4 class="text-lg font-bold text-emerald-400 mb-2">${data.reference}</h4>${verseContentHTML}`;
                        return;
                    }
                    
                    if (targetElement.querySelector('.italic')) targetElement.innerHTML = '';
                    
                    const verseEl = document.createElement('div');
                    let verseElClasses = isTopicalSearch 
                        ? "w-full p-3 border border-gray-700 rounded-lg bg-gray-900 flex flex-col"
                        : "w-72 flex-shrink-0 p-3 border border-gray-700 rounded-lg bg-gray-900 h-full flex flex-col";
                    
                    verseEl.className = verseElClasses;
                    verseEl.dataset.reference = data.reference;
                    verseEl.dataset.text = verseText;

                    verseEl.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-bold text-emerald-400">${data.reference}</p>
                            <div class="flex items-center gap-3 text-gray-400">
                                <button class="copy-to-outline-btn hover:text-emerald-400 transition-colors" title="Copiar para Esboço"><i class="fas fa-file-import"></i></button>
                                <button class="copy-to-notes-btn hover:text-yellow-400 transition-colors" title="Copiar para Notas"><i class="fas fa-clipboard"></i></button>
                                <button class="explain-verse-btn hover:text-sky-400 transition-colors" title="Explicar versículo"><i class="fas fa-comment-dots"></i></button>
                                <button class="remove-verse-btn text-gray-500 hover:text-red-400 transition-colors"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="overflow-y-auto flex-grow min-h-0">${verseContentHTML}</div>
                    `;

                    verseEl.querySelector('.copy-to-outline-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        const ref = verseEl.dataset.reference;
                        const textToCopy = verseEl.dataset.text;
                        const formattedContent = `<p><br></p><h4><strong>${ref}</strong></h4><blockquote>${textToCopy.replace(/\n/g, '<br>')}</blockquote>`;
                        outlineContentEl.innerHTML += formattedContent;
                        showToast(`"${ref}" copiado para o esboço.`);
                    });

                    verseEl.querySelector('.copy-to-notes-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        const ref = verseEl.dataset.reference;
                        const textToCopy = verseEl.dataset.text;
                        const currentNotes = outlineNotesEl.value;
                        const formattedContent = `${currentNotes ? '\n\n' : ''}${ref}\n${textToCopy}`;
                        outlineNotesEl.value += formattedContent;
                        showToast(`"${ref}" copiado para as notas.`);
                    });

                    verseEl.querySelector('.remove-verse-btn').addEventListener('click', () => {
                        verseEl.remove();
                        renderVerseDisplayPlaceholder();
                    });
                    verseEl.querySelector('.explain-verse-btn').addEventListener('click', () => openExplanationModal(data.reference));
                    
                    targetElement.appendChild(verseEl);

                    if(!isTopicalSearch) {
                       bibleRefInputEl.value = ''; 
                       bibleRefInputEl.focus();
                       targetElement.scrollLeft = targetElement.scrollWidth;
                    }

                } catch (error) {
                    targetElement.innerHTML = `<p class="text-red-400 p-3">Erro ao buscar ${reference}: ${error.message}</p>`;
                    setTimeout(() => { 
                        renderVerseDisplayPlaceholder();
                    }, 3000);
                }
            };
            
            const handleGenerateSuggestion = async () => {
                const theme = suggestionThemeInputEl.value.trim();
                const baseText = suggestionBaseTextInputEl.value.trim();
                const audience = suggestionAudienceSelectEl.value;
                const tone = suggestionToneSelectEl.value;

                if (!theme) {
                    showToast("Por favor, insira pelo menos um tema.");
                    return;
                }

                suggestionResultEl.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>Gerando esboço...</div>';
                useSuggestionBtn.classList.add('hidden');
                generateSuggestionBtn.disabled = true;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const systemPrompt = `Você é um assistente pastoral e teólogo experiente. Sua tarefa é criar esboços para sermões bíblicos detalhados e bem estruturados. A resposta deve ser clara, objetiva e seguir sempre o formato solicitado.`;
                
                let userQuery = `Crie um esboço de sermão com as seguintes características:\n- Tema Principal: "${theme}"\n- Público-Alvo: ${audience}\n- Tom da Mensagem: ${tone}\n`;
                if (baseText) {
                    userQuery += `- Texto-Base Principal: ${baseText}\n`;
                }
                userQuery += `\nA resposta DEVE ter o seguinte formato:\nTítulo: [Título do Sermão]\n\n[Restante do conteúdo do esboço, incluindo uma introdução cativante, 3 a 4 pontos principais bem desenvolvidos com versículos de apoio relevantes, e uma conclusão prática e inspiradora].`;
                
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        suggestionResultEl.textContent = text;
                        useSuggestionBtn.classList.remove('hidden');
                    } else {
                        throw new Error("Resposta da IA inválida ou vazia.");
                    }
                } catch (error) {
                    console.error("Error generating suggestion:", error);
                    suggestionResultEl.textContent = `Ocorreu um erro ao gerar a sugestão. Tente novamente.\nDetalhes: ${error.message}`;
                } finally {
                    generateSuggestionBtn.disabled = false;
                }
            };
            
            const useSuggestion = () => {
                const fullText = suggestionResultEl.textContent;
                const baseText = suggestionBaseTextInputEl.value.trim();
                const lines = fullText.split('\n');
                let title = "Esboço Gerado", content = fullText;
                if(lines[0].toLowerCase().startsWith('título:')) {
                    title = lines[0].substring(7).trim();
                    content = lines.slice(2).join('\n');
                }
                outlineTitleEl.value = title;
                outlineContentEl.innerHTML = content.replace(/\n/g, '<br>');

                if(baseText) {
                    const currentNotes = outlineNotesEl.value;
                    outlineNotesEl.value = `Texto-Base: ${baseText}${currentNotes ? `\n\n${currentNotes}` : ''}`;
                }

                closeSuggestionModal();
                showToast("Esboço inserido no editor!");
            };

            const openSuggestionModal = () => {
                suggestionModalEl.classList.remove('hidden');
                suggestionModalEl.classList.add('flex');
                suggestionThemeInputEl.focus();
            };

            const closeSuggestionModal = () => {
                suggestionModalEl.classList.add('hidden');
                suggestionModalEl.classList.remove('flex');
                suggestionResultEl.textContent = 'Aguardando um tema para gerar a sugestão...';
                suggestionThemeInputEl.value = '';
                suggestionBaseTextInputEl.value = '';
                suggestionAudienceSelectEl.selectedIndex = 0;
                suggestionToneSelectEl.selectedIndex = 0;
                useSuggestionBtn.classList.add('hidden');
            };

            const switchTab = (tabName) => {
                document.querySelectorAll('.right-tab-pane').forEach(pane => pane.classList.add('hidden'));
                document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
            };
            
            const openPresentationMode = (outlineId) => {
                const outline = outlines.find(o => o.id === outlineId);
                if (outline) {
                    presentationTitleEl.textContent = outline.title;
                    presentationContentEl.innerHTML = outline.content;
                    presentationModalEl.classList.remove('hidden');
                    presentationModalEl.classList.add('flex');
                    setTimeout(() => {
                        presentationModalEl.classList.add('visible');
                    }, 10);
                }
            };
            
            const closePresentationMode = () => {
                presentationModalEl.classList.remove('visible');
                setTimeout(() => {
                    presentationModalEl.classList.add('hidden');
                    presentationModalEl.classList.remove('flex');
                }, 300);
            };
            
            const switchMainView = (viewId) => {
                mainPanels.forEach(panel => {
                    panel.classList.toggle('hidden', panel.id !== viewId);
                    panel.classList.toggle('flex', panel.id === viewId);
                     // Special handling for left-panel to make it a flex container
                    if (panel.id === 'left-panel' && panel.id === viewId) {
                        panel.classList.add('flex', 'flex-col', 'gap-4');
                    }
                });

                document.querySelectorAll('.main-view-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === viewId);
                });

                mobileNavBtns.forEach(btn => {
                     if (btn.dataset.view === viewId) {
                         btn.classList.add('active', 'text-emerald-400');
                         btn.classList.remove('text-gray-400');
                     } else {
                         btn.classList.remove('active', 'text-emerald-400');
                         btn.classList.add('text-gray-400');
                     }
                 });
            };

            const switchStudySubTab = (subtabName) => {
                studySubtabPanes.forEach(pane => {
                    pane.classList.toggle('hidden', pane.id !== `${subtabName}-pane`);
                });
                document.querySelectorAll('.study-subtab-btn').forEach(btn => {
                    const isActive = btn.dataset.subtab === subtabName;
                    btn.classList.toggle('border-emerald-400', isActive);
                    btn.classList.toggle('text-white', isActive);
                    btn.classList.toggle('border-transparent', !isActive);
                    btn.classList.toggle('text-gray-400', !isActive);
                });
            };

            const openExplanationModal = (reference) => {
                explanationTitle.textContent = `Explicação de ${reference}`;
                explanationResult.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>A carregar explicação...</div>';
                copyExplanationBtn.classList.add('hidden');
                explanationModal.classList.remove('hidden');
                explanationModal.classList.add('flex');
                getVerseExplanation(reference, explanationResult);
            };

            const closeExplanationModal = () => {
                explanationModal.classList.add('hidden');
                explanationModal.classList.remove('flex');
            };

            const getVerseExplanation = async (reference, targetElement) => {
                targetElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>A gerar explicação...</div>';
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const systemPrompt = `Você é um teólogo e estudioso da Bíblia. Forneça uma explicação clara e concisa para a passagem bíblica solicitada. Foque no contexto histórico, significado teológico e aplicação prática.`;
                const userQuery = `Explique a passagem: ${reference}.`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        targetElement.innerHTML = text.replace(/\n/g, '<br>');
                        copyExplanationBtn.classList.remove('hidden');
                    } else {
                        copyExplanationBtn.classList.add('hidden');
                        throw new Error("Resposta da IA inválida ou vazia.");
                    }
                } catch (error) {
                    copyExplanationBtn.classList.add('hidden');
                    console.error("Error getting explanation:", error);
                    targetElement.textContent = `Ocorreu um erro ao buscar a explicação. Detalhes: ${error.message}`;
                }
            };

            const handleTopicalSearch = async () => {
                const theme = topicalThemeInput.value.trim();
                if (!theme) {
                    showToast("Por favor, insira um tema.");
                    return;
                }
                topicalResultsDisplay.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>A procurar versículos sobre o tema...</div>';
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const systemPrompt = `Você é um assistente de estudo bíblico. Sua tarefa é encontrar referências bíblicas sobre um determinado tema.`;
                const userQuery = `Liste 5 a 7 referências de versículos bíblicos chave sobre o tema "${theme}". Responda APENAS com as referências, separadas por vírgula (ex: João 3:16, Romanos 8:28, Salmos 23:1).`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        topicalResultsDisplay.innerHTML = ''; // Clear loading
                        const references = text.split(',').map(ref => ref.trim());
                        for (const ref of references) {
                            if (ref) {
                               await fetchVerse(ref, topicalResultsDisplay, true, false);
                            }
                        }
                    } else {
                        throw new Error("Não foi possível encontrar versículos para este tema.");
                    }

                } catch (error) {
                    console.error("Error on topical search:", error);
                    topicalResultsDisplay.innerHTML = `<p class="text-red-400 text-center">${error.message}</p>`;
                }
            };

            const handleGenerateCommentary = async () => {
                const book = commentaryBookSelect.value;
                const chapter = commentaryChapterInput.value.trim();
                if (!book || !chapter) {
                    showToast("Por favor, selecione o livro e o capítulo.");
                    return;
                }

                commentaryResultsDisplay.innerHTML = `<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>A gerar comentário para ${book} ${chapter}...</div>`;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const systemPrompt = `Você é um teólogo e exegeta bíblico. Sua tarefa é escrever um comentário aprofundado para um capítulo da Bíblia. Estruture sua resposta com clareza, usando títulos em negrito (ex: **Contexto**).`;
                const userQuery = `Gere um comentário bíblico detalhado para ${book} capítulo ${chapter}. Aborde o seguinte: 1. **Contexto Histórico e Literário**. 2. **Análise dos Temas Principais**. 3. **Comentário de Versículos Chave**. 4. **Aplicações Práticas e Teológicas**.`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        let formattedText = text.replace(/\n/g, '<br>');
                        formattedText = formattedText.replace(/\*\*([^*]+)\*\*/g, '<br><strong class="text-emerald-400 text-base mt-2 block">$1</strong>');
                        commentaryResultsDisplay.innerHTML = formattedText;
                    } else {
                        throw new Error("Resposta da IA inválida ou vazia.");
                    }
                } catch (error) {
                    console.error("Error generating commentary:", error);
                    commentaryResultsDisplay.innerHTML = `<p class="text-red-400">${error.message}</p>`;
                }
            };

            const toggleFocusMode = () => {
                 isFocusMode = !isFocusMode;
                 const icon = toggleFocusModeBtn.querySelector('i');
                 
                 document.getElementById('main-view-nav').classList.toggle('hidden', isFocusMode);
                 appContainer.classList.toggle('lg:p-4', !isFocusMode)
                 
                 if (isFocusMode) {
                     icon.classList.remove('fa-expand-arrows-alt');
                     icon.classList.add('fa-compress-arrows-alt');
                     toggleFocusModeBtn.title = "Sair do Modo Foco";
                 } else {
                     icon.classList.remove('fa-compress-arrows-alt');
                     icon.classList.add('fa-expand-arrows-alt');
                     toggleFocusModeBtn.title = "Modo Foco";
                 }
             };

            const renderReadingPlan = () => {
                if (!userReadingProgress) return;
                
                readingPlanSelect.innerHTML = '<option value="">Nenhum plano ativo</option>';
                for(const planId in READING_PLANS) {
                    const option = new Option(READING_PLANS[planId].name, planId);
                    readingPlanSelect.add(option);
                }
                readingPlanSelect.value = userReadingProgress.activePlan || "";

                readingPlanList.innerHTML = '';
                const activePlanId = userReadingProgress.activePlan;

                // Render achievements (plan completions)
                achievementsList.innerHTML = '';
                 const achievements = userReadingProgress.achievements || [];

                // Render Book Seals
                const oldTestamentContainer = document.createElement('div');
                const newTestamentContainer = document.createElement('div');
                
                oldTestamentContainer.innerHTML = '<h5 class="font-bold text-gray-400 text-sm mb-2">ANTIGO TESTAMENTO</h5>';
                newTestamentContainer.innerHTML = '<h5 class="font-bold text-gray-400 text-sm mt-4 mb-2">NOVO TESTAMENTO</h5>';
                
                const sealGridClasses = 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-4 xl:grid-cols-5 gap-4';
                const otGrid = document.createElement('div');
                otGrid.className = sealGridClasses;
                const ntGrid = document.createElement('div');
                ntGrid.className = sealGridClasses;
                
                BIBLE_BOOKS.forEach(book => {
                    const readCount = userReadingProgress.bookProgress[book]?.readCount || 0;
                    const seal = document.createElement('div');
                    const isUnlocked = readCount > 0;
                    seal.className = `seal ${isUnlocked ? 'seal-unlocked' : 'seal-locked'}`;
                    seal.innerHTML = `
                        <span class="book-name">${book}</span>
                        ${isUnlocked ? `<span class="read-count">x${readCount}</span>` : '<i class="fas fa-lock mt-1"></i>'}
                    `;

                    if (OLD_TESTAMENT_BOOKS.includes(book)) {
                        otGrid.appendChild(seal);
                    } else {
                        ntGrid.appendChild(seal);
                    }
                });

                oldTestamentContainer.appendChild(otGrid);
                newTestamentContainer.appendChild(ntGrid);
                achievementsList.appendChild(oldTestamentContainer);
                achievementsList.appendChild(newTestamentContainer);
                
                if(achievements.length > 0) {
                      achievements.forEach(ach => {
                         const achEl = document.createElement('div');
                         achEl.className = "flex items-center gap-4 bg-gray-900 p-3 rounded-lg mt-4";
                         achEl.innerHTML = `
                             <div class="text-yellow-400 text-3xl"><i class="fas fa-trophy"></i></div>
                             <div>
                                 <p class="font-bold text-white">${READING_PLANS[ach.planId]?.name || 'Plano Completado'}</p>
                                 <p class="text-xs text-gray-400">Completado em ${ach.completionDate.toDate().toLocaleDateString('pt-BR')} em ${ach.durationDays} dias.</p>
                             </div>
                         `;
                         achievementsList.appendChild(achEl);
                     });
                }


                if (!activePlanId || !READING_PLANS[activePlanId]) {
                    readingPlanSummary.innerHTML = `<p class="text-gray-400">Selecione um plano para começar.</p>`;
                    return;
                }

                const plan = READING_PLANS[activePlanId];
                const completed = userReadingProgress.completedDays || [];
                const totalDays = plan.readings.length;
                const completedCount = completed.length;
                const progress = totalDays > 0 ? Math.round((completedCount / totalDays) * 100) : 0;

                readingPlanSummary.innerHTML = `
                    <p class="font-semibold text-white">${plan.name}</p>
                    <p class="text-sm text-emerald-400">Progresso: ${completedCount} de ${totalDays} dias (${progress}%)</p>
                `;

                plan.readings.forEach((reading, index) => {
                    const day = index + 1;
                    const isCompleted = completed.includes(day);
                    const item = document.createElement('div');
                    item.className = `reading-plan-item flex items-center gap-4 p-2 rounded-lg hover:bg-gray-700 ${isCompleted ? 'completed' : ''}`;
                    item.innerHTML = `
                        <input type="checkbox" data-day="${day}" id="day-${day}" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-600 text-emerald-500 focus:ring-emerald-500 flex-shrink-0 cursor-pointer" ${isCompleted ? 'checked' : ''}>
                        <div data-reading="${reading}" class="read-and-explain-btn flex-grow cursor-pointer">
                            <label for="day-${day}" class="font-bold text-sm cursor-pointer">Dia ${day}:</label>
                            <span class="text-gray-300 ml-2 reading-scripture">${reading}</span>
                        </div>
                    `;
                    item.querySelector('input').addEventListener('change', handleReadingCheck);
                    item.querySelector('.read-and-explain-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        openReadingModal(reading);
                    });
                    readingPlanList.appendChild(item);
                });
            };

            const handleReadingCheck = async (e) => {
                const day = parseInt(e.target.dataset.day);
                const isChecked = e.target.checked;
                let completedDays = userReadingProgress.completedDays || [];
                let achievements = userReadingProgress.achievements || [];
                let bookProgress = userReadingProgress.bookProgress || {};

                if (isChecked) {
                    if (!completedDays.includes(day)) {
                        completedDays.push(day);
                    }
                } else {
                    completedDays = completedDays.filter(d => d !== day);
                }
                
                const activePlanId = userReadingProgress.activePlan;
                const plan = READING_PLANS[activePlanId];
                
                // Check for plan completion
                if (isChecked && completedDays.length === plan.readings.length) {
                    const startDate = userReadingProgress.planStartDate.toDate();
                    const completionDate = new Date();
                    const durationMs = completionDate - startDate;
                    const durationDays = Math.ceil(durationMs / (1000 * 60 * 60 * 24));

                    const newAchievement = {
                        planId: activePlanId,
                        completionDate: Timestamp.fromDate(completionDate),
                        durationDays: durationDays
                    };
                    
                    if (!achievements.some(a => a.planId === activePlanId && a.completionDate.isEqual(newAchievement.completionDate))) {
                        achievements.push(newAchievement);
                        showToast(`Parabéns! Completou o plano '${plan.name}'!`);
                        
                        // Increment read count for all books in the plan
                        const booksInPlan = new Set(plan.readings.map(r => r.match(/^[0-9]?\s?[a-zA-Z\u00C0-\u017F]+/)[0].trim()));
                        booksInPlan.forEach(bookName => {
                            if(bookProgress[bookName]) {
                                bookProgress[bookName].readCount++;
                            } else {
                                bookProgress[bookName] = { readCount: 1 };
                            }
                        });
                    }
                }

                const newProgress = { ...userReadingProgress, completedDays: completedDays.sort((a,b) => a-b), achievements, bookProgress };
                const readingPlanDoc = doc(db, `artifacts/${appId}/users/${userId}/readingPlan/progress`);
                await setDoc(readingPlanDoc, newProgress);
            };

            const handlePlanChange = async (e) => {
                const newPlanId = e.target.value;
                if (newPlanId === userReadingProgress.activePlan) return;

                const startNewPlan = async () => {
                    const newProgress = { 
                        ...userReadingProgress,
                        activePlan: newPlanId || null, 
                        completedDays: [],
                        planStartDate: Timestamp.fromDate(new Date()) 
                    };
                    const readingPlanDoc = doc(db, `artifacts/${appId}/users/${userId}/readingPlan/progress`);
                    await setDoc(readingPlanDoc, newProgress);
                    if(newPlanId) {
                        showToast(`Plano '${READING_PLANS[newPlanId].name}' iniciado!`);
                    } else {
                         showToast(`Nenhum plano de leitura ativo.`);
                    }
                }

                if (userReadingProgress.activePlan && userReadingProgress.completedDays.length > 0) {
                     showConfirmationModal('Mudar de plano irá apagar o seu progresso atual. Deseja continuar?', () => {
                         startNewPlan();
                     });
                     readingPlanSelect.value = userReadingProgress.activePlan;
                } else {
                    startNewPlan();
                }
            };

            const openReadingModal = (reference) => {
                readingModalTitle.textContent = `Leitura e Estudo: ${reference}`;
                readingModal.classList.remove('hidden');
                readingModal.classList.add('flex');
                fetchVerse(reference, readingModalText, false, true);
                getVerseExplanation(reference, readingModalExplanation);
            };

            const closeReadingModal = () => {
                readingModal.classList.add('hidden');
                readingModal.classList.remove('flex');
            };

            const toggleStudyTools = () => {
                 const isHidden = studyToolsArea.classList.contains('hidden');
                
                 if (window.innerWidth < 1024) { // Mobile/Tablet: Overlay behavior
                     if (isHidden) {
                         studyToolsArea.classList.remove('hidden');
                         studyToolsArea.classList.add('flex');
                         editorArea.classList.add('hidden');
                     } else {
                         studyToolsArea.classList.add('hidden');
                         studyToolsArea.classList.remove('flex');
                         editorArea.classList.remove('hidden');
                     }
                 } else { // Desktop: Sidebar behavior
                    if (isHidden) {
                        studyToolsArea.classList.remove('hidden');
                        studyToolsArea.classList.add('lg:flex');
                        editorArea.classList.remove('lg:w-full');
                        editorArea.classList.add('lg:w-2/3');
                    } else {
                        studyToolsArea.classList.add('hidden');
                        studyToolsArea.classList.remove('lg:flex');
                        editorArea.classList.remove('lg:w-2/3');
                        editorArea.classList.add('lg:w-full');
                    }
                 }
             };

            const requestNotificationPermission = () => {
                if (!("Notification" in window)) {
                    console.log("This browser does not support desktop notification");
                } else if (Notification.permission === "default") {
                    Notification.requestPermission();
                }
            }

            const sendNotification = (title, body) => {
                if (Notification.permission === "granted") {
                    new Notification(title, { body });
                }
            }
            
            const updateActiveFastTimer = () => {
                const now = new Date();
                const activeFast = fastingSchedules.find(f => {
                    const start = new Date(f.startDate);
                    const end = new Date(f.endDate);
                    return now >= start && now <= end;
                });

                if(activeFast){
                    const endTime = new Date(activeFast.endDate);
                    const totalSeconds = (endTime - now) / 1000;

                    if (totalSeconds > 0) {
                        const days = Math.floor(totalSeconds / 3600 / 24);
                        const hours = Math.floor(totalSeconds / 3600) % 24;
                        const minutes = Math.floor(totalSeconds / 60) % 60;
                        const seconds = Math.floor(totalSeconds) % 60;

                        activeFastTimerEl.classList.remove('hidden');
                        activeFastTitleEl.textContent = activeFast.title;
                        timerDisplayEl.textContent = `${String(days).padStart(2, '0')}d ${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s`;

                        // Notification logic
                        const notificationKey = `notified_${activeFast.id}`;
                        if (totalSeconds < 15 * 60 && !sessionStorage.getItem(notificationKey)) {
                            sendNotification('Jejum a Terminar!', `O seu propósito "${activeFast.title}" termina em menos de 15 minutos.`);
                            sessionStorage.setItem(notificationKey, 'true');
                        }

                    } else {
                        activeFastTimerEl.classList.add('hidden');
                    }
                } else {
                    activeFastTimerEl.classList.add('hidden');
                }
            };
            
            const handleSuggestDelivery = async () => {
                fastingSuggestionModalEl.classList.remove('hidden');
                fastingSuggestionModalEl.classList.add('flex');
                fastingSuggestionResultEl.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>A gerar sugestão...</div>';

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const systemPrompt = `Você é um conselheiro espiritual. Sugira uma forma significativa de concluir um período de jejum e oração, focando em gratidão, reflexão e uma refeição leve e saudável. Apresente a sugestão em 2-3 parágrafos.`;
                const userQuery = `Sugira como entregar (terminar) um jejum.`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

                 try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        fastingSuggestionResultEl.innerHTML = text.replace(/\n/g, '<br>');
                    } else {
                        throw new Error("Resposta da IA inválida ou vazia.");
                    }
                } catch (error) {
                    console.error("Error generating fasting suggestion:", error);
                    fastingSuggestionResultEl.textContent = `Ocorreu um erro ao gerar a sugestão. Detalhes: ${error.message}`;
                }
            };


            // Initial calls
            bibleBookSelectEl.innerHTML = '';
            bibleStudyBookSelectEl.innerHTML = '';
            commentaryBookSelect.innerHTML = '';
            BIBLE_BOOKS.forEach(book => {
                bibleBookSelectEl.add(new Option(book, book));
                bibleStudyBookSelectEl.add(new Option(book, book));
                commentaryBookSelect.add(new Option(book, book));
            });
            document.getElementById('prev-month').onclick = () => changeMonth(-1);
            document.getElementById('next-month').onclick = () => changeMonth(1);
            saveOutlineBtn.onclick = saveOutline;
            document.getElementById('clear-editor-btn').onclick = clearEditor;
            document.getElementById('cancel-engagement').onclick = closeEngagementModal;
            document.getElementById('save-engagement').onclick = handleSaveEngagement;
            document.getElementById('delete-engagement').onclick = handleDeleteEngagement;
            
            document.getElementById('fetch-verse-btn').onclick = () => fetchVerse(null, document.getElementById('verse-display'), false, false);
            document.getElementById('bible-ref-input').onkeypress = (e) => { if (e.key === 'Enter') fetchVerse(null, document.getElementById('verse-display'), false, false); };
            
            clearStudyResultsBtn.onclick = () => {
                document.getElementById('verse-display').innerHTML = '';
                document.getElementById('topical-results-display').innerHTML = '';
                document.getElementById('commentary-results-display').innerHTML = '';
                renderVerseDisplayPlaceholder();
                showToast('Resultados limpos.');
            };

            document.getElementById('right-tabs').onclick = (e) => {
                const tabBtn = e.target.closest('.tab-btn');
                if(tabBtn) {
                    switchTab(tabBtn.dataset.tab);
                    if(tabBtn.dataset.tab === 'fasting') {
                        requestNotificationPermission();
                    }
                }
            };
            document.getElementById('save-fasting-btn').onclick = saveFastingSchedule;

            document.getElementById('format-bold').onclick = () => formatText('bold');
            document.getElementById('format-italic').onclick = () => formatText('italic');
            document.getElementById('format-underline').onclick = () => formatText('underline');
            document.getElementById('format-list').onclick = () => formatText('insertOrderedList');
            document.getElementById('font-color-picker').oninput = (e) => formatText('foreColor', e.target.value);
            document.getElementById('font-size-select').onchange = (e) => formatText('fontSize', e.target.value);

            document.getElementById('suggestion-btn').onclick = openSuggestionModal;
            document.getElementById('cancel-suggestion').onclick = closeSuggestionModal;
            generateSuggestionBtn.onclick = handleGenerateSuggestion;
            
            document.getElementById('close-presentation-btn').onclick = closePresentationMode;
            
            mainViewNav.addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.main-view-btn');
                if (viewBtn) switchMainView(viewBtn.dataset.view);
            });

            mobileNavBtns.forEach(btn => {
                btn.addEventListener('click', () => switchMainView(btn.dataset.view));
            });
            
            openStudyToolsBtn.onclick = toggleStudyTools;
            closeStudyToolsBtn.onclick = toggleStudyTools;

            studySubTabs.addEventListener('click', (e) => {
                const tabBtn = e.target.closest('.study-subtab-btn');
                if (tabBtn) switchStudySubTab(tabBtn.dataset.subtab);
            });
            fetchTopicBtn.onclick = handleTopicalSearch;
            topicalThemeInput.onkeypress = (e) => { if (e.key === 'Enter') handleTopicalSearch(); };
            closeExplanationBtn.onclick = closeExplanationModal;
            toggleFocusModeBtn.onclick = toggleFocusMode;
            readingPlanSelect.onchange = handlePlanChange;
            closeReadingModalBtn.onclick = closeReadingModal;
            fetchCommentaryBtn.onclick = handleGenerateCommentary;
            commentaryChapterInput.onkeypress = (e) => { if (e.key === 'Enter') handleGenerateCommentary(); };
            
            copyExplanationBtn.addEventListener('click', () => {
                const explanationText = explanationResult.innerText;
                const currentNotes = outlineNotesEl.value;
                const formattedContent = `${currentNotes ? '\n\n' : ''}Explicação de ${explanationTitle.textContent.replace('Explicação de ', '')}:\n${explanationText}`;
                outlineNotesEl.value += formattedContent;
                showToast(`Explicação copiada para as notas.`);
                closeExplanationModal();
            });

            suggestDeliveryBtn.onclick = handleSuggestDelivery;
            closeFastingSuggestionBtn.onclick = () => {
                fastingSuggestionModalEl.classList.add('hidden');
                fastingSuggestionModalEl.classList.remove('flex');
            };
            useSuggestionBtn.onclick = useSuggestion;


            setInterval(updateActiveFastTimer, 1000);
            setupFirebaseListeners();
            switchTab('archive');
            renderCalendar();
            renderVerseDisplayPlaceholder();
            switchMainView('center-panel'); // Set initial view to Esboço
        }

    </script>
</body>
</html>

