<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Ministrações</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            background-color: #374151; /* bg-gray-700 */
            transform: scale(1.05);
        }
        .event-dot {
            width: 8px;
            height: 8px;
            background-color: #34d399; /* bg-emerald-400 */
            border-radius: 50%;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Glassmorphism effect for modals */
        .modal-glass {
            background: rgba(31, 41, 55, 0.6); /* bg-gray-800 with opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Tab styling */
        .tab-btn.active {
            border-bottom-color: #34d399; /* border-emerald-400 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .editor-toolbar button, .editor-toolbar select {
            transition: background-color 0.2s;
        }
        [contenteditable]:focus {
            outline: none;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Container (Login/Register) -->
    <div id="auth-container" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md">
            <div class="bg-gray-800 rounded-lg shadow-xl p-8">
                <h2 id="auth-title" class="text-2xl font-bold text-center text-white mb-6">Login</h2>
                
                <!-- Auth Forms -->
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-300 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="login-email" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-300 text-sm font-bold mb-2">Palavra-passe</label>
                        <input type="password" id="login-password" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors">
                            Entrar
                        </button>
                        <a href="#" id="show-register" class="inline-block align-baseline font-bold text-sm text-sky-400 hover:text-sky-500">
                            Criar Conta
                        </a>
                    </div>
                </form>

                <form id="register-form" class="hidden">
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-300 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="register-email" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-300 text-sm font-bold mb-2">Palavra-passe</label>
                        <input type="password" id="register-password" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors">
                            Registar
                        </button>
                        <a href="#" id="show-login" class="inline-block align-baseline font-bold text-sm text-sky-400 hover:text-sky-500">
                            Já tenho conta
                        </a>
                    </div>
                </form>

                <p id="auth-error" class="text-red-500 text-xs italic mt-4 text-center"></p>

                <div class="my-4 flex items-center before:flex-1 before:border-t before:border-gray-600 before:mt-0.5 after:flex-1 after:border-t after:border-gray-600 after:mt-0.5">
                    <p class="text-center font-semibold mx-4 mb-0 text-gray-400">OU</p>
                </div>

                <button id="google-signin-btn" class="w-full flex justify-center items-center gap-2 bg-white hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Entrar com Google
                </button>
            </div>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen w-full p-4 gap-4">

        <!-- Top Header for User Info and Logout -->
        <header class="absolute top-0 right-0 p-4 flex items-center gap-4 text-sm z-10">
            <span id="user-email" class="text-gray-400"></span>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg transition-colors" title="Sair">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </header>

        <!-- Main Content Layout -->
        <div class="flex h-full w-full pt-12 gap-4">
            <!-- Left Panel: Calendar and Engagements -->
            <aside class="w-1/4 flex flex-col gap-4">
                <!-- Calendar Card -->
                <div id="calendar-card" class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="month-year" class="text-xl font-bold text-white"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs text-gray-400 mb-2">
                        <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                    </div>
                    <div id="calendar-grid" class="grid calendar-grid gap-1 flex-grow">
                        <!-- Calendar days will be generated by JS -->
                    </div>
                </div>
                <!-- Engagements List -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg h-1/3 overflow-y-auto">
                    <h3 class="text-lg font-semibold text-white mb-2 border-b border-gray-700 pb-2">Próximas Ministrações</h3>
                    <div id="engagements-list">
                        <p class="text-gray-400 text-sm">Nenhuma ministração agendada.</p>
                    </div>
                </div>
            </aside>

            <!-- Center Panel: Outline Editor -->
            <main class="w-1/2 bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <h2 id="editor-title" class="text-2xl font-bold text-white">Novo Esboço</h2>
                    <div class="flex gap-2">
                        <button id="suggestion-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2" title="Gerar sugestão de esboço"><i class="fas fa-lightbulb"></i> Gerar Ideia</button>
                        <button id="save-outline-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2"><i class="fas fa-save"></i> Salvar</button>
                        <button id="clear-editor-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-eraser"></i> Limpar</button>
                    </div>
                </div>
                
                <input type="text" id="outline-title" placeholder="Título do Esboço" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 mb-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                
                <div class="flex-grow flex gap-4 overflow-hidden">
                    <div class="w-2/3 flex flex-col">
                        <div class="editor-toolbar flex items-center gap-2 bg-gray-900 p-2 rounded-t-lg border-b border-gray-700">
                            <button id="format-bold" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Negrito"><i class="fas fa-bold"></i></button>
                            <button id="format-italic" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Itálico"><i class="fas fa-italic"></i></button>
                            <button id="format-underline" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Sublinhado"><i class="fas fa-underline"></i></button>
                            <button id="format-list" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Lista Numerada"><i class="fas fa-list-ol"></i></button>
                            <div class="w-px h-5 bg-gray-700 mx-1"></div>
                            <div class="relative flex items-center" title="Cor da Fonte">
                                <input type="color" id="font-color-picker" class="absolute opacity-0 w-8 h-8 cursor-pointer">
                                <i class="fas fa-palette text-lg px-2 text-gray-400"></i>
                            </div>
                            <select id="font-size-select" class="bg-gray-700 text-white text-xs rounded border-none focus:ring-0 p-1" title="Tamanho da Fonte">
                                <option value="3">Normal</option>
                                <option value="1">Mínimo</option>
                                <option value="2">Pequeno</option>
                                <option value="4">Médio</option>
                                <option value="5">Grande</option>
                                <option value="7">Enorme</option>
                            </select>
                        </div>
                        <div id="outline-content" contenteditable="true" class="w-full h-full flex-grow bg-gray-900 border-x border-b border-gray-700 rounded-b-lg p-4 text-gray-200 resize-none focus:outline-none overflow-y-auto"></div>
                    </div>
                    <div class="w-1/3 flex flex-col">
                        <label for="outline-notes" class="block mb-2 text-sm font-medium text-gray-300">Notas e Ilustrações</label>
                        <textarea id="outline-notes" placeholder="Anote aqui ideias, ilustrações, estatísticas..." class="w-full h-full flex-grow bg-gray-900 border border-gray-700 rounded-lg p-4 text-gray-200 resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                    </div>
                </div>

                <div class="mt-4">
                    <label for="bible-book-select" class="block mb-2 text-sm font-medium text-gray-300">Vincular esboço ao livro de:</label>
                    <select id="bible-book-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5"></select>
                </div>
            </main>

            <!-- Right Panel: Tools -->
            <aside class="w-1/4 bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col">
                 <div class="border-b border-gray-700 mb-4">
                    <nav id="right-tabs" class="flex gap-4 -mb-px">
                        <button data-tab="archive" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-archive mr-2"></i>Arquivo</button>
                        <button data-tab="study" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-book-open mr-2"></i>Estudo</button>
                        <button data-tab="fasting" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-pray mr-2"></i>Jejum</button>
                    </nav>
                </div>
                <div id="right-tab-content" class="flex-grow flex flex-col overflow-y-hidden">
                    <div id="archive-tab-content" class="right-tab-pane flex-grow overflow-y-auto">
                        <div id="archive-list" class="space-y-2"></div>
                    </div>
                    <div id="study-tab-content" class="right-tab-pane hidden flex-grow flex flex-col overflow-hidden">
                         <h3 class="text-xl font-semibold text-white mb-2">Estudo Rápido</h3>
                        <div class="flex gap-2 mb-2 items-center">
                            <select id="bible-study-book-select" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5"></select>
                            <input type="text" id="bible-ref-input" placeholder="3:16" class="w-1/3 bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white">
                            <button id="fetch-verse-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-2.5 rounded-lg"><i class="fas fa-search"></i></button>
                            <button id="clear-verses-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2.5 rounded-lg" title="Limpar"><i class="fas fa-times-circle"></i></button>
                        </div>
                        <div id="verse-display" class="bg-gray-900 rounded-lg p-3 flex-grow text-gray-300 text-sm flex gap-4 overflow-x-auto pb-4"></div>
                    </div>
                    <div id="fasting-tab-content" class="right-tab-pane hidden flex-grow flex flex-col">
                        <h3 class="text-xl font-semibold text-white mb-2">Jejum e Oração</h3>
                        <div class="bg-gray-900 rounded-lg p-3 mb-3">
                            <h4 class="font-semibold text-white mb-2 text-sm">Novo Propósito</h4>
                             <input type="text" id="fasting-title" placeholder="Propósito" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm mb-2">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label for="fasting-start-date" class="text-xs text-gray-400">Início</label>
                                    <input type="date" id="fasting-start-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                                </div>
                                <div>
                                    <label for="fasting-end-date" class="text-xs text-gray-400">Fim</label>
                                    <input type="date" id="fasting-end-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                                </div>
                            </div>
                            <textarea id="fasting-notes" placeholder="Anotações..." rows="2" class="w-full bg-gray-700 border rounded-lg p-2 text-white text-sm"></textarea>
                            <button id="save-fasting-btn" class="mt-2 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Adicionar</button>
                        </div>
                        <div id="fasting-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    
    <button id="feedback-btn" class="fixed bottom-5 left-5 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-full shadow-lg z-30 transition-transform hover:scale-110 hidden" title="Enviar Feedback">
        <i class="fas fa-comment-dots"></i>
    </button>

    <!-- Modals -->
    <div id="engagement-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-40">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-white">Agendar Ministração</h3>
            <p class="mb-4 text-gray-300">Data: <span id="modal-date" class="font-semibold"></span></p>
            <div>
                <label for="engagement-title" class="block mb-2 text-sm font-medium text-gray-300">Título do Evento/Local</label>
                <input type="text" id="engagement-title" placeholder="Ex: Culto de Domingo - Igreja X" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5 mb-4">
            </div>
            <div>
                <label for="modal-outline-select" class="block mb-2 text-sm font-medium text-gray-300">Vincular Esboço</label>
                <select id="modal-outline-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5"></select>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-engagement" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Cancelar</button>
                <button id="save-engagement" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg">Salvar Agendamento</button>
                <button id="delete-engagement" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg hidden">Excluir</button>
            </div>
        </div>
    </div>
    
    <div id="suggestion-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-40">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-white">Assistente de Esboços (IA)</h3>
            <p class="text-sm text-gray-300 mb-4">Digite um tema, versículo ou palavra-chave para gerar uma sugestão de esboço.</p>
            <div class="flex gap-2 mb-4">
                <input type="text" id="suggestion-theme-input" placeholder="Ex: A Parábola do Filho Pródigo" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                <button id="generate-suggestion-btn" class="py-2 px-4 bg-sky-500 hover:bg-sky-600 text-white rounded-lg">Gerar Esboço</button>
            </div>
            <div id="suggestion-result" class="bg-gray-900 rounded-lg p-4 flex-grow overflow-y-auto text-gray-300 text-sm whitespace-pre-wrap"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-suggestion" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Fechar</button>
                <button id="use-suggestion-btn" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg hidden">Usar este Esboço</button>
            </div>
        </div>
    </div>

    <!-- Presentation Mode Modal -->
    <div id="presentation-modal" class="fixed inset-0 bg-gray-900 p-8 flex-col hidden z-50">
        <div class="w-full max-w-4xl mx-auto flex-grow flex flex-col h-full">
            <h2 id="presentation-title" class="text-4xl font-bold text-emerald-400 mb-6 text-center flex-shrink-0"></h2>
            <div id="presentation-content" class="text-lg text-gray-200 leading-relaxed flex-grow overflow-y-auto p-6 bg-gray-800 rounded-lg">
                <!-- Outline content goes here -->
            </div>
             <div class="text-center mt-6 flex-shrink-0">
                <button id="close-presentation-btn" class="py-2 px-6 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-40">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-white">Enviar Feedback ou Sugestão</h3>
            <p class="text-sm text-gray-300 mb-4">A sua opinião é muito importante para nós! Deixe a sua sugestão para melhorarmos a ferramenta.</p>
            <textarea id="feedback-text" placeholder="Escreva a sua mensagem aqui..." rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"></textarea>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-feedback" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Cancelar</button>
                <button id="save-feedback" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-emerald-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCp2CxegdrcOk4Bj6I45_8LOl0nTOt3rEg",
            authDomain: "calendario-de-ministracao.firebaseapp.com",
            projectId: "calendario-de-ministracao",
            storageBucket: "calendario-de-ministracao.firebasestorage.app",
            messagingSenderId: "1091866768883",
            appId: "1:1091866768883:web:9290fd424ff5cbf0980e86",
            measurementId: "G-TBPTMVYF4M"
        };
        const appId = 'default-preaching-app';

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authErrorEl = document.getElementById('auth-error');
        const feedbackBtn = document.getElementById('feedback-btn');
        
        let userId = null;
        let outlinesUnsubscribe, engagementsUnsubscribe, fastingUnsubscribe;

        // --- Auth State Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-email').textContent = user.email;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                feedbackBtn.classList.remove('hidden');
                
                initializeAppLogic();
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
                feedbackBtn.classList.add('hidden');
                
                if (outlinesUnsubscribe) outlinesUnsubscribe();
                if (engagementsUnsubscribe) engagementsUnsubscribe();
                if (fastingUnsubscribe) fastingUnsubscribe();
            }
        });

        // --- Auth Event Listeners ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authErrorEl.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error.code);
                 switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        authErrorEl.textContent = "Email ou palavra-passe inválidos.";
                        break;
                    default:
                        authErrorEl.textContent = "Ocorreu um erro ao fazer o login.";
                }
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authErrorEl.textContent = '';
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Register error:", error.code);
                switch (error.code) {
                    case 'auth/weak-password':
                        authErrorEl.textContent = "A palavra-passe deve ter pelo menos 6 caracteres.";
                        break;
                    case 'auth/email-already-in-use':
                        authErrorEl.textContent = "Este email já está a ser utilizado.";
                        break;
                    case 'auth/invalid-email':
                        authErrorEl.textContent = "O formato do email é inválido.";
                        break;
                    case 'auth/operation-not-allowed':
                         authErrorEl.textContent = "Registo desativado. Contacte o administrador.";
                         break;
                    default:
                        authErrorEl.textContent = "Ocorreu um erro ao criar a conta.";
                }
            }
        });
        
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            authErrorEl.textContent = '';
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-in error:", error.code);
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        break;
                    case 'auth/account-exists-with-different-credential':
                        authErrorEl.textContent = "Já existe uma conta com este email. Tente fazer login com outro método.";
                        break;
                    default:
                        authErrorEl.textContent = "Ocorreu um erro ao entrar com o Google.";
                }
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            document.getElementById('auth-title').textContent = 'Criar Conta';
            authErrorEl.textContent = '';
        });
        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.getElementById('auth-title').textContent = 'Login';
            authErrorEl.textContent = '';
        });

        // --- Main App Logic (to be initialized after login) ---
        function initializeAppLogic() {
            let outlinesCol, engagementsCol, fastingCol;
            let currentDate = new Date();
            let outlines = [], engagements = [], fastingSchedules = [];
            let currentEditingOutlineId = null, currentSelectedDate = null, currentEditingEngagementId = null;

            const BIBLE_BOOKS = [
                "Gênesis", "Êxodo", "Levítico", "Números", "Deuteronômio", "Josué", "Juízes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Crônicas", "2 Crônicas", "Esdras", "Neemias", "Ester", "Jó", "Salmos", "Provérbios", "Eclesiastes", "Cânticos", "Isaías", "Jeremias", "Lamentações", "Ezequiel", "Daniel", "Oséias", "Joel", "Amós", "Obadias", "Jonas", "Miquéias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias",
                "Mateus", "Marcos", "Lucas", "João", "Atos", "Romanos", "1 Coríntios", "2 Coríntios", "Gálatas", "Efésios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Timóteo", "2 Timóteo", "Tito", "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 João", "2 João", "3 João", "Judas", "Apocalipse"
            ];
            
            const monthYearEl = document.getElementById('month-year');
            const calendarGridEl = document.getElementById('calendar-grid');
            const saveOutlineBtn = document.getElementById('save-outline-btn');
            const outlineTitleEl = document.getElementById('outline-title');
            const outlineContentEl = document.getElementById('outline-content');
            const outlineNotesEl = document.getElementById('outline-notes');
            const bibleBookSelectEl = document.getElementById('bible-book-select');
            const archiveListEl = document.getElementById('archive-list');
            const modalOutlineSelectEl = document.getElementById('modal-outline-select');
            const engagementsListEl = document.getElementById('engagements-list');
            const editorTitleEl = document.getElementById('editor-title');
            const bibleStudyBookSelectEl = document.getElementById('bible-study-book-select');
            const verseDisplayEl = document.getElementById('verse-display');
            const bibleRefInputEl = document.getElementById('bible-ref-input');
            const fastingListEl = document.getElementById('fasting-list');
            const fastingTitleEl = document.getElementById('fasting-title');
            const fastingStartDateEl = document.getElementById('fasting-start-date');
            const fastingEndDateEl = document.getElementById('fasting-end-date');
            const fastingNotesEl = document.getElementById('fasting-notes');
            const suggestionModalEl = document.getElementById('suggestion-modal');
            const suggestionThemeInputEl = document.getElementById('suggestion-theme-input');
            const suggestionResultEl = document.getElementById('suggestion-result');
            const useSuggestionBtn = document.getElementById('use-suggestion-btn');
            const generateSuggestionBtn = document.getElementById('generate-suggestion-btn');
            const engagementModalEl = document.getElementById('engagement-modal');
            const modalDateEl = document.getElementById('modal-date');
            const engagementTitleEl = document.getElementById('engagement-title');
            const deleteEngagementBtn = document.getElementById('delete-engagement');
            const presentationModalEl = document.getElementById('presentation-modal');
            const presentationTitleEl = document.getElementById('presentation-title');
            const presentationContentEl = document.getElementById('presentation-content');
            const feedbackModalEl = document.getElementById('feedback-modal');
            const feedbackTextEl = document.getElementById('feedback-text');
            const cancelFeedbackBtn = document.getElementById('cancel-feedback');
            const saveFeedbackBtn = document.getElementById('save-feedback');
            
            const showToast = (message) => {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.remove('opacity-0', 'translate-y-20');
                toast.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-20');
                    toast.classList.remove('opacity-100', 'translate-y-0');
                }, 3000);
            };

            const formatText = (command, value = null) => {
                document.execCommand(command, false, value);
                outlineContentEl.focus();
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                monthYearEl.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${year}`;
                calendarGridEl.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGridEl.innerHTML += `<div class="p-2"></div>`;
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                    const dayEngagements = engagements.filter(e => e.date === dateStr);
                    const dayEl = document.createElement('div');
                    dayEl.className = `calendar-day cursor-pointer flex flex-col items-center justify-center h-16 rounded-lg border border-transparent ${isToday ? 'bg-emerald-500 text-white font-bold' : 'hover:border-emerald-400'}`;
                    dayEl.dataset.date = dateStr;
                    dayEl.innerHTML = `<span>${day}</span><div class="flex gap-1 mt-1">${dayEngagements.map(() => `<div class="event-dot"></div>`).join('')}</div>`;
                    dayEl.addEventListener('click', () => openEngagementModal(dateStr));
                    calendarGridEl.appendChild(dayEl);
                }
            };

            const renderOutlines = () => {
                archiveListEl.innerHTML = '';
                modalOutlineSelectEl.innerHTML = '<option value="">Nenhum (somente agendar)</option>';
                const groupedOutlines = BIBLE_BOOKS.reduce((acc, book) => {
                    const bookOutlines = outlines.filter(o => o.book === book);
                    if (bookOutlines.length > 0) acc[book] = bookOutlines;
                    return acc;
                }, {});
                if (outlines.length === 0) {
                    archiveListEl.innerHTML = '<p class="text-gray-400 text-sm">Nenhum esboço salvo ainda.</p>';
                }
                for (const book in groupedOutlines) {
                    const bookSection = document.createElement('div');
                    bookSection.innerHTML = `<h3 class="text-lg font-semibold text-emerald-400">${book}</h3>`;
                    const list = document.createElement('ul');
                    list.className = 'ml-4 space-y-1';
                    groupedOutlines[book].forEach(outline => {
                        const li = document.createElement('li');
                        li.className = 'text-gray-300 hover:text-white cursor-pointer flex justify-between items-center group';
                        li.innerHTML = `<span><i class="fas fa-file-alt mr-2 text-gray-500"></i>${outline.title}</span><button data-id="${outline.id}" class="delete-outline-btn text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-trash-alt"></i></button>`;
                        li.addEventListener('click', (e) => {
                            if (e.target.closest('.delete-outline-btn')) return;
                            loadOutlineIntoEditor(outline.id)
                        });
                        list.appendChild(li);
                    });
                    bookSection.appendChild(list);
                    archiveListEl.appendChild(bookSection);
                }
                outlines.forEach(outline => modalOutlineSelectEl.add(new Option(outline.title, outline.id)));
                document.querySelectorAll('.delete-outline-btn').forEach(btn => {
                   btn.addEventListener('click', async (e) => {
                       const id = e.currentTarget.dataset.id;
                       if (confirm('Tem certeza que deseja excluir este esboço?')) {
                            await deleteDoc(doc(outlinesCol, id));
                            showToast('Esboço excluído.');
                            clearEditor();
                       }
                   }) 
                });
            };
        
            const renderEngagementsList = () => {
                const sortedEngagements = [...engagements].filter(e => new Date(e.date) >= new Date(new Date().toDateString())).sort((a, b) => new Date(a.date) - new Date(b.date));
                if(sortedEngagements.length === 0) {
                    engagementsListEl.innerHTML = '<p class="text-gray-400 text-sm">Nenhuma ministração agendada.</p>';
                    return;
                }
                engagementsListEl.innerHTML = sortedEngagements.map(e => {
                    const outline = outlines.find(o => o.id === e.outlineId);
                    const date = new Date(`${e.date}T00:00:00-03:00`);
                    const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                    return `<div class="p-2 rounded-lg hover:bg-gray-700 cursor-pointer" data-engagement-id="${e.id}"><p class="font-semibold text-white">${formattedDate} - ${e.title}</p><p class="text-sm text-gray-400">${outline ? outline.title : 'Sem esboço vinculado'}</p></div>`;
                }).join('');
                document.querySelectorAll('#engagements-list [data-engagement-id]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const engagementId = e.currentTarget.dataset.engagementId;
                        const engagement = engagements.find(eng => eng.id === engagementId);
                        if (engagement && engagement.outlineId) {
                            openPresentationMode(engagement.outlineId);
                        } else {
                            showToast("Este agendamento não tem um esboço vinculado.");
                        }
                    });
                });
            };

            const renderFastingSchedules = () => {
                const sortedSchedules = [...fastingSchedules].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                if (sortedSchedules.length === 0) {
                    fastingListEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Nenhum propósito cadastrado.</p>';
                    return;
                }
                fastingListEl.innerHTML = sortedSchedules.map(item => {
                    const startDate = new Date(`${item.startDate}T00:00:00-03:00`).toLocaleDateString('pt-BR');
                    const endDate = new Date(`${item.endDate}T00:00:00-03:00`).toLocaleDateString('pt-BR');
                    return `<div class="bg-gray-800 p-3 rounded-lg group"><div class="flex justify-between items-start"><div><p class="font-semibold text-white">${item.title}</p><p class="text-xs text-emerald-400">${startDate} até ${endDate}</p></div><button data-id="${item.id}" class="delete-fasting-btn text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-sm"><i class="fas fa-trash"></i></button></div><p class="text-sm text-gray-300 mt-2">${item.notes || ''}</p></div>`;
                }).join('');
                document.querySelectorAll('.delete-fasting-btn').forEach(btn => {
                    btn.addEventListener('click', async e => {
                        const id = e.currentTarget.dataset.id;
                        if (confirm('Deseja excluir este propósito?')) {
                            await deleteDoc(doc(fastingCol, id));
                            showToast('Propósito excluído.');
                        }
                    });
                });
            };

            const renderVerseDisplayPlaceholder = () => {
                if (verseDisplayEl.children.length === 0) {
                    verseDisplayEl.innerHTML = '<p class="text-gray-500 italic flex items-center justify-center h-full">Consulte um versículo...</p>';
                }
            };
            
            const setupFirebaseListeners = () => {
                 outlinesCol = collection(db, `artifacts/${appId}/users/${userId}/outlines`);
                 engagementsCol = collection(db, `artifacts/${appId}/users/${userId}/engagements`);
                 fastingCol = collection(db, `artifacts/${appId}/users/${userId}/fastingSchedules`);
                outlinesUnsubscribe = onSnapshot(query(outlinesCol), (snapshot) => {
                    outlines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.title.localeCompare(b.title));
                    renderOutlines();
                    renderEngagementsList();
                });
                engagementsUnsubscribe = onSnapshot(query(engagementsCol), (snapshot) => {
                    engagements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCalendar();
                    renderEngagementsList();
                });
                fastingUnsubscribe = onSnapshot(query(fastingCol), (snapshot) => {
                    fastingSchedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderFastingSchedules();
                });
            };
            
            const changeMonth = (offset) => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                renderCalendar();
            };

            const saveOutline = async () => {
                const title = outlineTitleEl.value.trim();
                const content = outlineContentEl.innerHTML;
                const notes = outlineNotesEl.value.trim();
                const book = bibleBookSelectEl.value;
                if (!title || !content) {
                    showToast('Preencha o título e o conteúdo.');
                    return;
                }
                const outlineData = { title, content, notes, book, updatedAt: new Date() };
                if (currentEditingOutlineId) {
                    await setDoc(doc(outlinesCol, currentEditingOutlineId), outlineData, { merge: true });
                    showToast('Esboço atualizado com sucesso!');
                } else {
                    await addDoc(outlinesCol, outlineData);
                    showToast('Esboço salvo com sucesso!');
                }
                clearEditor();
            };

            const loadOutlineIntoEditor = (id) => {
                const outline = outlines.find(o => o.id === id);
                if (outline) {
                    currentEditingOutlineId = id;
                    outlineTitleEl.value = outline.title;
                    outlineContentEl.innerHTML = outline.content;
                    outlineNotesEl.value = outline.notes || '';
                    bibleBookSelectEl.value = outline.book;
                    editorTitleEl.textContent = 'Editando Esboço';
                }
            };

            const clearEditor = () => {
                currentEditingOutlineId = null;
                outlineTitleEl.value = '';
                outlineContentEl.innerHTML = '';
                outlineNotesEl.value = '';
                bibleBookSelectEl.value = BIBLE_BOOKS[0];
                editorTitleEl.textContent = 'Novo Esboço';
                outlineTitleEl.focus();
            };

            const openEngagementModal = (dateStr) => {
                currentSelectedDate = dateStr;
                const engagement = engagements.find(e => e.date === dateStr);
                const date = new Date(`${dateStr}T00:00:00-03:00`);
                modalDateEl.textContent = date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                if (engagement) {
                    currentEditingEngagementId = engagement.id;
                    engagementTitleEl.value = engagement.title;
                    modalOutlineSelectEl.value = engagement.outlineId || '';
                    deleteEngagementBtn.classList.remove('hidden');
                } else {
                    currentEditingEngagementId = null;
                    engagementTitleEl.value = '';
                    modalOutlineSelectEl.value = '';
                    deleteEngagementBtn.classList.add('hidden');
                }
                engagementModalEl.classList.remove('hidden');
                engagementModalEl.classList.add('flex');
            };

            const closeEngagementModal = () => {
                engagementModalEl.classList.add('hidden');
                engagementModalEl.classList.remove('flex');
            };
            
            const handleSaveEngagement = async () => {
                const title = engagementTitleEl.value.trim();
                const outlineId = modalOutlineSelectEl.value;
                if (!title) {
                    showToast('Por favor, preencha o título.');
                    return;
                }
                const engagementData = { date: currentSelectedDate, title: title, outlineId: outlineId };
                const docId = currentEditingEngagementId || `${currentSelectedDate}_${Date.now()}`;
                await setDoc(doc(engagementsCol, docId), engagementData, { merge: true });
                showToast('Agendamento salvo!');
                closeEngagementModal();
            };
            
            const handleDeleteEngagement = async () => {
                if (currentEditingEngagementId && confirm('Tem certeza que deseja excluir este agendamento?')) {
                     await deleteDoc(doc(engagementsCol, currentEditingEngagementId));
                     showToast('Agendamento excluído.');
                     closeEngagementModal();
                }
            }
            
            const saveFastingSchedule = async () => {
                const title = fastingTitleEl.value.trim();
                const startDate = fastingStartDateEl.value;
                const endDate = fastingEndDateEl.value;
                const notes = fastingNotesEl.value.trim();
                if (!title || !startDate || !endDate) {
                    showToast('Preencha o propósito e as datas.');
                    return;
                }
                const scheduleData = { title, startDate, endDate, notes, createdAt: new Date() };
                await addDoc(fastingCol, scheduleData);
                showToast('Propósito salvo!');
                fastingTitleEl.value = '';
                fastingStartDateEl.value = '';
                fastingEndDateEl.value = '';
                fastingNotesEl.value = '';
            };

            const clearVerses = () => {
                verseDisplayEl.innerHTML = '';
                renderVerseDisplayPlaceholder();
                showToast('Resultados limpos.');
            };

            const fetchVerse = async () => {
                const book = bibleStudyBookSelectEl.value;
                const userInput = bibleRefInputEl.value.trim();
                if (!userInput) return;
                let reference = /[a-zA-ZáéíóúâêîôûãõçÁÉÍÓÚÂÊÎÔÛÃÕÇ]/.test(userInput) ? userInput : `${book} ${userInput}`;
                if (verseDisplayEl.querySelector('.italic')) verseDisplayEl.innerHTML = '';
                const loadingEl = document.createElement('div');
                loadingEl.className = "w-72 flex-shrink-0 p-3 border border-gray-700 rounded-lg bg-gray-800 animate-pulse";
                loadingEl.innerHTML = 'Buscando...';
                verseDisplayEl.appendChild(loadingEl);
                try {
                    const response = await fetch(`https://bible-api.com/${reference}?translation=almeida`);
                    if (!response.ok) throw new Error('Referência não encontrada.');
                    const data = await response.json();
                    loadingEl.remove();
                    const verseEl = document.createElement('div');
                    verseEl.className = "w-72 flex-shrink-0 p-3 border border-gray-700 rounded-lg bg-gray-800 h-full flex flex-col";
                    verseEl.innerHTML = `<div class="flex justify-between items-center mb-1"><p class="font-bold text-emerald-400">${data.reference}</p><button class="remove-verse-btn text-gray-500 hover:text-red-400 text-xs"><i class="fas fa-times"></i></button></div><p class="overflow-y-auto flex-grow min-h-0">${data.text}</p>`;
                    verseEl.querySelector('.remove-verse-btn').addEventListener('click', () => {
                        verseEl.remove();
                        renderVerseDisplayPlaceholder();
                    });
                    verseDisplayEl.appendChild(verseEl);
                    bibleRefInputEl.value = ''; 
                    bibleRefInputEl.focus();
                } catch (error) {
                    loadingEl.innerHTML = `<p class="text-red-400">Erro: ${error.message}</p>`;
                    setTimeout(() => { 
                        loadingEl.remove();
                        renderVerseDisplayPlaceholder();
                    }, 3000);
                } finally {
                    verseDisplayEl.scrollLeft = verseDisplayEl.scrollWidth;
                }
            };

            const handleGenerateSuggestion = async () => {
                const theme = suggestionThemeInputEl.value.trim();
                if (!theme) {
                    showToast("Por favor, insira um tema.");
                    return;
                }
                suggestionResultEl.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>Gerando esboço...</div>';
                useSuggestionBtn.classList.add('hidden');
                generateSuggestionBtn.disabled = true;
                const apiKey = "AIzaSyAFImZxjnCZJGiZDMdAtnQA2FBsD_ljdvA";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `Você é um assistente pastoral e teólogo. Sua tarefa é criar esboços para sermões bíblicos. Seja claro, objetivo e estruture a resposta sempre da mesma forma.`;
                const userQuery = `Crie um esboço de sermão sobre o tema "${theme}". A resposta DEVE ter o seguinte formato:\nTítulo: [Título do Sermão]\n\n[Restante do conteúdo do esboço, incluindo uma introdução, 3 pontos principais com versículos de apoio, e uma conclusão].`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        suggestionResultEl.textContent = text;
                        useSuggestionBtn.classList.remove('hidden');
                    } else {
                        throw new Error("Resposta da IA inválida ou vazia.");
                    }
                } catch (error) {
                    console.error("Error generating suggestion:", error);
                    suggestionResultEl.textContent = `Ocorreu um erro ao gerar a sugestão. Tente novamente.\nDetalhes: ${error.message}`;
                } finally {
                    generateSuggestionBtn.disabled = false;
                }
            };

            const useSuggestion = () => {
                const fullText = suggestionResultEl.textContent;
                const lines = fullText.split('\n');
                let title = "Esboço Gerado", content = fullText;
                if(lines[0].toLowerCase().startsWith('título:')) {
                    title = lines[0].substring(7).trim();
                    content = lines.slice(2).join('\n');
                }
                outlineTitleEl.value = title;
                outlineContentEl.innerHTML = content.replace(/\n/g, '<br>');
                closeSuggestionModal();
                showToast("Esboço inserido no editor!");
            };

            const openSuggestionModal = () => {
                suggestionModalEl.classList.remove('hidden');
                suggestionModalEl.classList.add('flex');
                suggestionThemeInputEl.focus();
            };

            const closeSuggestionModal = () => {
                suggestionModalEl.classList.add('hidden');
                suggestionModalEl.classList.remove('flex');
                suggestionResultEl.textContent = 'Aguardando um tema para gerar a sugestão...';
                suggestionThemeInputEl.value = '';
                useSuggestionBtn.classList.add('hidden');
            };

            const switchTab = (tabName) => {
                document.querySelectorAll('.right-tab-pane').forEach(pane => pane.classList.add('hidden'));
                document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
            };
            
            const openPresentationMode = (outlineId) => {
                const outline = outlines.find(o => o.id === outlineId);
                if (outline) {
                    presentationTitleEl.textContent = outline.title;
                    presentationContentEl.innerHTML = outline.content;
                    presentationModalEl.classList.remove('hidden');
                    presentationModalEl.classList.add('flex');
                }
            };
            
            const closePresentationMode = () => {
                presentationModalEl.classList.add('hidden');
                presentationModalEl.classList.remove('flex');
            };

            const openFeedbackModal = () => {
                feedbackModalEl.classList.remove('hidden');
                feedbackModalEl.classList.add('flex');
                feedbackTextEl.focus();
            };

            const closeFeedbackModal = () => {
                feedbackModalEl.classList.add('hidden');
                feedbackModalEl.classList.remove('flex');
                feedbackTextEl.value = '';
            };

            const saveFeedback = async () => {
                const text = feedbackTextEl.value.trim();
                if (!text) {
                    showToast('Por favor, escreva a sua mensagem.');
                    return;
                }

                const feedbackData = {
                    text,
                    userId: auth.currentUser.uid,
                    userEmail: auth.currentUser.email,
                    createdAt: new Date()
                };
                
                const feedbackCol = collection(db, `artifacts/${appId}/public/feedback`);
                try {
                    await addDoc(feedbackCol, feedbackData);
                    showToast('Feedback enviado com sucesso. Obrigado!');
                    closeFeedbackModal();
                } catch (error) {
                    console.error("Error saving feedback:", error);
                    showToast('Erro ao enviar feedback. Tente novamente.');
                }
            };

            // Initial calls
            bibleBookSelectEl.innerHTML = '';
            bibleStudyBookSelectEl.innerHTML = '';
            BIBLE_BOOKS.forEach(book => {
                bibleBookSelectEl.add(new Option(book, book));
                bibleStudyBookSelectEl.add(new Option(book, book));
            });
            document.getElementById('prev-month').onclick = () => changeMonth(-1);
            document.getElementById('next-month').onclick = () => changeMonth(1);
            saveOutlineBtn.onclick = saveOutline;
            document.getElementById('clear-editor-btn').onclick = clearEditor;
            document.getElementById('cancel-engagement').onclick = closeEngagementModal;
            document.getElementById('save-engagement').onclick = handleSaveEngagement;
            document.getElementById('delete-engagement').onclick = handleDeleteEngagement;
            document.getElementById('fetch-verse-btn').onclick = fetchVerse;
            document.getElementById('clear-verses-btn').onclick = clearVerses;
            bibleRefInputEl.onkeypress = (e) => { if (e.key === 'Enter') fetchVerse(); };
            document.getElementById('right-tabs').onclick = (e) => {
                const tabBtn = e.target.closest('.tab-btn');
                if(tabBtn) switchTab(tabBtn.dataset.tab);
            };
            document.getElementById('save-fasting-btn').onclick = saveFastingSchedule;

            document.getElementById('format-bold').onclick = () => formatText('bold');
            document.getElementById('format-italic').onclick = () => formatText('italic');
            document.getElementById('format-underline').onclick = () => formatText('underline');
            document.getElementById('format-list').onclick = () => formatText('insertOrderedList');
            document.getElementById('font-color-picker').oninput = (e) => formatText('foreColor', e.target.value);
            document.getElementById('font-size-select').onchange = (e) => formatText('fontSize', e.target.value);

            document.getElementById('suggestion-btn').onclick = openSuggestionModal;
            document.getElementById('cancel-suggestion').onclick = closeSuggestionModal;
            generateSuggestionBtn.onclick = handleGenerateSuggestion;
            useSuggestionBtn.onclick = useSuggestion;
            suggestionThemeInputEl.onkeypress = (e) => { if (e.key === 'Enter') handleGenerateSuggestion(); };
            
            document.getElementById('close-presentation-btn').onclick = closePresentationMode;
            
            feedbackBtn.onclick = openFeedbackModal;
            cancelFeedbackBtn.onclick = closeFeedbackModal;
            saveFeedbackBtn.onclick = saveFeedback;

            setupFirebaseListeners();
            switchTab('archive');
            renderCalendar();
            renderVerseDisplayPlaceholder();
        }

    </script>
</body>
</html>

