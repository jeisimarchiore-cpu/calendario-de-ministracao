<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Ministrações</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Library to export to DOCX -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            background-color: #374151; /* bg-gray-700 */
            transform: scale(1.05);
        }
        .event-dot {
            width: 8px;
            height: 8px;
            background-color: #34d399; /* bg-emerald-400 */
            border-radius: 50%;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Glassmorphism effect for modals */
        .modal-glass {
            background: rgba(31, 41, 55, 0.6); /* bg-gray-800 with opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Tab styling */
        .tab-btn.active {
            border-bottom-color: #34d399; /* border-emerald-400 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .editor-toolbar button, .editor-toolbar select {
            transition: background-color 0.2s;
        }
        [contenteditable]:focus {
            outline: none;
        }
        .mobile-nav-btn.active {
            color: #34d399; /* emerald-400 */
        }
        /* Custom details/summary marker */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary .marker {
            transition: transform 0.2s;
        }
        details[open] > summary .marker {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen w-full lg:p-4 pb-20 lg:pb-4">

        <!-- Top Header for User Info and Logout -->
        <header class="absolute top-0 right-0 p-4 flex items-center gap-4 text-sm z-10">
             <div class="text-right">
                <span id="user-email" class="text-gray-400 block font-medium"></span>
                <span id="user-id" class="text-gray-500 text-xs block"></span>
            </div>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg transition-colors" title="Sair">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </header>

        <!-- Main Content Layout -->
        <div id="main-content-layout" class="flex flex-col lg:flex-row h-full w-full lg:pt-12 lg:gap-4 p-4 lg:p-0">
            <!-- Left Panel: Calendar and Engagements -->
            <aside id="left-panel" class="main-panel w-full lg:w-1/4 flex flex-col gap-4">
                <!-- Calendar Card -->
                <div id="calendar-card" class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="month-year" class="text-xl font-bold text-white"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs text-gray-400 mb-2">
                        <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                    </div>
                    <div id="calendar-grid" class="grid calendar-grid gap-1 flex-grow">
                        <!-- Calendar days will be generated by JS -->
                    </div>
                </div>
                <!-- Engagements List -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg lg:h-1/3 overflow-y-auto">
                    <h3 class="text-lg font-semibold text-white mb-2 border-b border-gray-700 pb-2">Próximas Ministrações</h3>
                    <div id="engagements-list">
                        <p class="text-gray-400 text-sm">Nenhuma ministração agendada.</p>
                    </div>
                </div>
            </aside>

            <!-- Center Panel: Outline Editor -->
            <main id="center-panel" class="main-panel w-full lg:w-1/2 bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col overflow-hidden transition-all duration-300">
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <h2 id="editor-title" class="text-2xl font-bold text-white">Novo Esboço</h2>
                    <div class="flex gap-2 items-center">
                        <button id="toggle-focus-mode-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg transition-colors" title="Modo Foco">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                        <div class="w-px h-6 bg-gray-700"></div>
                        <button id="suggestion-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2" title="Gerar sugestão de esboço"><i class="fas fa-lightbulb"></i> <span class="hidden md:inline">Gerar Ideia</span></button>
                        <button id="save-outline-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2"><i class="fas fa-save"></i> <span class="hidden md:inline">Salvar</span></button>
                        <button id="clear-editor-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-eraser"></i> <span class="hidden md:inline">Limpar</span></button>
                    </div>
                </div>
                
                <input type="text" id="outline-title" placeholder="Título do Esboço" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 mb-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 flex-shrink-0">
                
                <div class="flex-grow flex flex-col gap-4 overflow-y-auto pr-2">
                    <!-- Rich Text Editor -->
                    <div class="flex flex-col h-1/2">
                         <div class="editor-toolbar flex items-center gap-2 bg-gray-900 p-2 rounded-t-lg border-b border-gray-700 flex-wrap flex-shrink-0">
                            <button id="format-bold" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Negrito"><i class="fas fa-bold"></i></button>
                            <button id="format-italic" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Itálico"><i class="fas fa-italic"></i></button>
                            <button id="format-underline" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Sublinhado"><i class="fas fa-underline"></i></button>
                            <button id="format-list" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Lista Numerada"><i class="fas fa-list-ol"></i></button>
                            <div class="w-px h-5 bg-gray-700 mx-1"></div>
                            <div class="relative flex items-center" title="Cor da Fonte">
                                <input type="color" id="font-color-picker" class="absolute opacity-0 w-8 h-8 cursor-pointer">
                                <i class="fas fa-palette text-lg px-2 text-gray-400"></i>
                            </div>
                            <select id="font-size-select" class="bg-gray-700 text-white text-xs rounded border-none focus:ring-0 p-1" title="Tamanho da Fonte">
                                <option value="3">Normal</option>
                                <option value="1">Mínimo</option>
                                <option value="2">Pequeno</option>
                                <option value="4">Médio</option>
                                <option value="5">Grande</option>
                                <option value="7">Enorme</option>
                            </select>
                        </div>
                        <div id="outline-content" contenteditable="true" class="w-full flex-grow bg-gray-900 border-x border-b border-gray-700 rounded-b-lg p-4 text-gray-200 resize-none focus:outline-none overflow-y-auto"></div>
                    </div>

                    <!-- Notes Area -->
                     <div class="flex flex-col h-1/3">
                         <label for="outline-notes" class="block mb-2 text-sm font-medium text-gray-300 flex-shrink-0">Notas e Ilustrações</label>
                        <textarea id="outline-notes" placeholder="Anote aqui ideias, ilustrações, estatísticas..." class="w-full flex-grow bg-gray-900 border border-gray-700 rounded-lg p-4 text-gray-200 resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                    </div>

                    <!-- Study Tools Accordion -->
                    <details id="study-tools-accordion" class="bg-gray-900 rounded-lg border border-gray-700 flex-shrink-0">
                        <summary class="p-3 cursor-pointer flex justify-between items-center text-lg font-semibold text-white">
                            <span><i class="fas fa-book-open mr-3"></i>Ferramentas de Estudo</span>
                            <i class="fas fa-chevron-right marker"></i>
                        </summary>
                        <div class="p-4 border-t border-gray-700">
                             <div id="study-tab-content" class="flex-grow flex flex-col overflow-hidden">
                                <!-- Sub-tabs for Study -->
                                <div class="border-b border-gray-700 mb-2">
                                    <nav id="study-sub-tabs" class="flex gap-4 -mb-px">
                                        <button data-subtab="verse-lookup" class="study-subtab-btn py-2 px-1 border-b-2 border-emerald-400 text-white text-sm font-medium">Busca por Versículo</button>
                                        <button data-subtab="topical-study" class="study-subtab-btn py-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white text-sm font-medium">Estudo por Tema</button>
                                    </nav>
                                </div>

                                <!-- Verse Lookup Pane -->
                                <div id="verse-lookup-pane" class="study-subtab-pane flex-grow flex flex-col overflow-hidden">
                                    <div class="flex gap-2 mb-2 items-center">
                                        <select id="bible-study-book-select" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5"></select>
                                        <input type="text" id="bible-ref-input" placeholder="3:16" class="w-1/3 bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white">
                                        <button id="fetch-verse-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-2.5 rounded-lg" title="Buscar Versículo"><i class="fas fa-search"></i></button>
                                        <button id="clear-verses-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2.5 rounded-lg" title="Limpar"><i class="fas fa-times-circle"></i></button>
                                    </div>
                                    <div id="verse-display" class="bg-gray-800 rounded-lg p-3 h-48 text-gray-300 text-sm flex gap-4 overflow-x-auto pb-4"></div>
                                </div>

                                <!-- Topical Study Pane -->
                                <div id="topical-study-pane" class="study-subtab-pane hidden flex-grow flex flex-col overflow-hidden">
                                    <div class="flex gap-2 mb-2 items-center">
                                        <input type="text" id="topical-theme-input" placeholder="Digite um tema (ex: Fé, Amor, Esperança)" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white">
                                        <button id="fetch-topic-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-2.5 rounded-lg" title="Buscar Tema"><i class="fas fa-search"></i></button>
                                    </div>
                                    <div id="topical-results-display" class="bg-gray-800 rounded-lg p-3 h-48 text-gray-300 text-sm overflow-y-auto space-y-3">
                                         <p class="text-gray-500 italic flex items-center justify-center h-full">Pesquise um tema para ver os versículos relacionados.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="mt-4 flex-shrink-0">
                    <label for="bible-book-select" class="block mb-2 text-sm font-medium text-gray-300">Vincular esboço ao livro de:</label>
                    <select id="bible-book-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5"></select>
                </div>
            </main>

            <!-- Right Panel: Tools -->
            <aside id="right-panel" class="main-panel w-full lg:w-1/4 bg-gray-800 rounded-lg shadow-lg p-6 flex-col hidden lg:flex">
                 <div class="border-b border-gray-700 mb-4">
                    <nav id="right-tabs" class="flex gap-4 -mb-px">
                        <button data-tab="archive" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-book-bible mr-2"></i>Biblioteca</button>
                        <button data-tab="fasting" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium"><i class="fas fa-pray mr-2"></i>Jejum</button>
                    </nav>
                </div>
                <div id="right-tab-content" class="flex-grow flex flex-col overflow-y-hidden">
                    <div id="archive-tab-content" class="right-tab-pane flex-grow overflow-y-auto">
                        <div id="archive-list" class="space-y-2"></div>
                    </div>
                    <div id="fasting-tab-content" class="right-tab-pane hidden flex-grow flex flex-col">
                        <h3 class="text-xl font-semibold text-white mb-2">Jejum e Oração</h3>
                        <div class="bg-gray-900 rounded-lg p-3 mb-3">
                            <h4 class="font-semibold text-white mb-2 text-sm">Novo Propósito</h4>
                             <input type="text" id="fasting-title" placeholder="Propósito" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm mb-2">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label for="fasting-start-date" class="text-xs text-gray-400">Início</label>
                                    <input type="date" id="fasting-start-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                                </div>
                                <div>
                                    <label for="fasting-end-date" class="text-xs text-gray-400">Fim</label>
                                    <input type="date" id="fasting-end-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                                </div>
                            </div>
                            <textarea id="fasting-notes" placeholder="Anotações..." rows="2" class="w-full bg-gray-700 border rounded-lg p-2 text-white text-sm"></textarea>
                            <button id="save-fasting-btn" class="mt-2 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Adicionar</button>
                        </div>
                        <div id="fasting-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                    </div>
                </div>
            </aside>
        </div>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav id="bottom-nav" class="lg:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around p-2 z-30">
            <button data-view="left-panel" class="mobile-nav-btn flex flex-col items-center text-emerald-400 w-1/3">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">Agenda</span>
            </button>
            <button data-view="center-panel" class="mobile-nav-btn flex flex-col items-center text-gray-400 w-1/3">
                <i class="fas fa-pencil-alt text-xl"></i>
                <span class="text-xs mt-1">Esboço</span>
            </button>
            <button data-view="right-panel" class="mobile-nav-btn flex flex-col items-center text-gray-400 w-1/3">
                <i class="fas fa-tools text-xl"></i>
                <span class="text-xs mt-1">Ferramentas</span>
            </button>
        </nav>
    </div>
    
    <!-- Modals -->
    <div id="engagement-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-40">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-white">Agendar Ministração</h3>
            <p class="mb-4 text-gray-300">Data: <span id="modal-date" class="font-semibold"></span></p>
            <div>
                <label for="engagement-title" class="block mb-2 text-sm font-medium text-gray-300">Título do Evento/Local</label>
                <input type="text" id="engagement-title" placeholder="Ex: Culto de Domingo - Igreja X" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5 mb-4">
            </div>
            <div>
                <label for="modal-outline-select" class="block mb-2 text-sm font-medium text-gray-300">Vincular Esboço</label>
                <select id="modal-outline-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5"></select>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-engagement" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Cancelar</button>
                <button id="save-engagement" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg">Salvar Agendamento</button>
                <button id="delete-engagement" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg hidden">Excluir</button>
            </div>
        </div>
    </div>
    
    <div id="suggestion-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-40">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-white">Assistente de Esboços (IA)</h3>
            <p class="text-sm text-gray-300 mb-4">Digite um tema, versículo ou palavra-chave para gerar uma sugestão de esboço.</p>
            <div class="flex gap-2 mb-4">
                <input type="text" id="suggestion-theme-input" placeholder="Ex: A Parábola do Filho Pródigo" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                <button id="generate-suggestion-btn" class="py-2 px-4 bg-sky-500 hover:bg-sky-600 text-white rounded-lg">Gerar Esboço</button>
            </div>
            <div id="suggestion-result" class="bg-gray-900 rounded-lg p-4 flex-grow overflow-y-auto text-gray-300 text-sm whitespace-pre-wrap"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-suggestion" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Fechar</button>
                <button id="use-suggestion-btn" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg hidden">Usar este Esboço</button>
            </div>
        </div>
    </div>

    <!-- Explanation Modal -->
     <div id="explanation-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-50">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <h3 id="explanation-title" class="text-xl font-bold mb-4 text-white">Explicação do Versículo</h3>
            <div id="explanation-result" class="bg-gray-900 rounded-lg p-4 flex-grow overflow-y-auto text-gray-300 text-sm whitespace-pre-wrap">
                <!-- Explanation will be loaded here -->
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="close-explanation-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Presentation Mode Modal -->
    <div id="presentation-modal" class="fixed inset-0 bg-gray-900 p-4 md:p-8 flex-col hidden z-50">
        <div class="w-full max-w-4xl mx-auto flex-grow flex flex-col h-full">
            <h2 id="presentation-title" class="text-2xl md:text-4xl font-bold text-emerald-400 mb-6 text-center flex-shrink-0"></h2>
            <div id="presentation-content" class="text-base md:text-lg text-gray-200 leading-relaxed flex-grow overflow-y-auto p-4 md:p-6 bg-gray-800 rounded-lg">
                <!-- Outline content goes here -->
            </div>
             <div class="text-center mt-6 flex-shrink-0">
                <button id="close-presentation-btn" class="py-2 px-6 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden z-50">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 id="confirmation-title" class="text-lg font-bold mb-4 text-white">Confirmar Ação</h3>
            <p id="confirmation-message" class="mb-6 text-gray-300"></p>
            <div class="flex justify-end gap-3">
                <button id="cancel-confirmation-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">Cancelar</button>
                <button id="confirm-action-btn" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 lg:bottom-5 right-5 bg-emerald-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-preaching-app';

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const userIdEl = document.getElementById('user-id');
        const userEmailEl = document.getElementById('user-email');
        
        let userId = null;
        let outlinesUnsubscribe, engagementsUnsubscribe, fastingUnsubscribe;

        // --- Auth State & App Startup ---
        const main = async () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userEmailEl.textContent = user.isAnonymous ? 'Utilizador Convidado' : user.email || 'Utilizador';
                    userIdEl.textContent = `ID: ${user.uid}`;

                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('flex');
                    
                    initializeAppLogic();
                } else {
                    userId = null;
                    appContainer.classList.add('hidden');
                    appContainer.classList.remove('flex');
                    
                    document.body.insertAdjacentHTML('beforeend', '<div class="flex items-center justify-center h-screen text-white">Sessão terminada. Por favor, recarregue a página.</div>');

                    if (outlinesUnsubscribe) outlinesUnsubscribe();
                    if (engagementsUnsubscribe) engagementsUnsubscribe();
                    if (fastingUnsubscribe) fastingUnsubscribe();
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                appContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-red-500 text-center p-4"><p>Ocorreu um erro crítico na autenticação. Por favor, verifique a consola e recarregue a página.</p></div>`;
                appContainer.classList.remove('hidden');
            }
        };

        main();

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- Main App Logic (to be initialized after login) ---
        function initializeAppLogic() {
            let outlinesCol, engagementsCol, fastingCol;
            let currentDate = new Date();
            let outlines = [], engagements = [], fastingSchedules = [];
            let currentEditingOutlineId = null, currentSelectedDate = null, currentEditingEngagementId = null;
            let isFocusMode = false;

            const BIBLE_BOOKS = [
                "Gênesis", "Êxodo", "Levítico", "Números", "Deuteronômio", "Josué", "Juízes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Crônicas", "2 Crônicas", "Esdras", "Neemias", "Ester", "Jó", "Salmos", "Provérbios", "Eclesiastes", "Cânticos", "Isaías", "Jeremias", "Lamentações", "Ezequiel", "Daniel", "Oséias", "Joel", "Amós", "Obadias", "Jonas", "Miquéias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias",
                "Mateus", "Marcos", "Lucas", "João", "Atos", "Romanos", "1 Coríntios", "2 Coríntios", "Gálatas", "Efésios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Timóteo", "2 Timóteo", "Tito", "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 João", "2 João", "3 João", "Judas", "Apocalipse"
            ];
            
            const monthYearEl = document.getElementById('month-year');
            const calendarGridEl = document.getElementById('calendar-grid');
            const saveOutlineBtn = document.getElementById('save-outline-btn');
            const outlineTitleEl = document.getElementById('outline-title');
            const outlineContentEl = document.getElementById('outline-content');
            const outlineNotesEl = document.getElementById('outline-notes');
            const bibleBookSelectEl = document.getElementById('bible-book-select');
            const archiveListEl = document.getElementById('archive-list');
            const modalOutlineSelectEl = document.getElementById('modal-outline-select');
            const engagementsListEl = document.getElementById('engagements-list');
            const editorTitleEl = document.getElementById('editor-title');
            const bibleStudyBookSelectEl = document.getElementById('bible-study-book-select');
            const verseDisplayEl = document.getElementById('verse-display');
            const bibleRefInputEl = document.getElementById('bible-ref-input');
            const fastingListEl = document.getElementById('fasting-list');
            const fastingTitleEl = document.getElementById('fasting-title');
            const fastingStartDateEl = document.getElementById('fasting-start-date');
            const fastingEndDateEl = document.getElementById('fasting-end-date');
            const fastingNotesEl = document.getElementById('fasting-notes');
            const suggestionModalEl = document.getElementById('suggestion-modal');
            const suggestionThemeInputEl = document.getElementById('suggestion-theme-input');
            const suggestionResultEl = document.getElementById('suggestion-result');
            const useSuggestionBtn = document.getElementById('use-suggestion-btn');
            const generateSuggestionBtn = document.getElementById('generate-suggestion-btn');
            const engagementModalEl = document.getElementById('engagement-modal');
            const modalDateEl = document.getElementById('modal-date');
            const engagementTitleEl = document.getElementById('engagement-title');
            const deleteEngagementBtn = document.getElementById('delete-engagement');
            const presentationModalEl = document.getElementById('presentation-modal');
            const presentationTitleEl = document.getElementById('presentation-title');
            const presentationContentEl = document.getElementById('presentation-content');
            const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
            const mainPanels = document.querySelectorAll('.main-panel');
            const confirmationModalEl = document.getElementById('confirmation-modal');
            const confirmationMessageEl = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
            const studySubTabs = document.getElementById('study-sub-tabs');
            const studySubtabPanes = document.querySelectorAll('.study-subtab-pane');
            const topicalThemeInput = document.getElementById('topical-theme-input');
            const fetchTopicBtn = document.getElementById('fetch-topic-btn');
            const topicalResultsDisplay = document.getElementById('topical-results-display');
            const explanationModal = document.getElementById('explanation-modal');
            const explanationTitle = document.getElementById('explanation-title');
            const explanationResult = document.getElementById('explanation-result');
            const closeExplanationBtn = document.getElementById('close-explanation-btn');
            const toggleFocusModeBtn = document.getElementById('toggle-focus-mode-btn');
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const centerPanel = document.getElementById('center-panel');
            
            let confirmationCallback = null;

            const showConfirmationModal = (message, callback) => {
                confirmationMessageEl.textContent = message;
                confirmationCallback = callback;
                confirmationModalEl.classList.remove('hidden');
                confirmationModalEl.classList.add('flex');
            };

            const hideConfirmationModal = () => {
                confirmationModalEl.classList.add('hidden');
                confirmationModalEl.classList.remove('flex');
                confirmationCallback = null;
            };

            confirmActionBtn.addEventListener('click', () => {
                if (confirmationCallback) {
                    confirmationCallback();
                }
                hideConfirmationModal();
            });

            cancelConfirmationBtn.addEventListener('click', hideConfirmationModal);

            const showToast = (message) => {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.remove('opacity-0', 'translate-y-20');
                toast.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-20');
                    toast.classList.remove('opacity-100', 'translate-y-0');
                }, 3000);
            };

            const formatText = (command, value = null) => {
                document.execCommand(command, false, value);
                outlineContentEl.focus();
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                monthYearEl.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${year}`;
                calendarGridEl.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGridEl.innerHTML += `<div class="p-2"></div>`;
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                    const dayEngagements = engagements.filter(e => e.date === dateStr);
                    const dayEl = document.createElement('div');
                    dayEl.className = `calendar-day cursor-pointer flex flex-col items-center justify-center h-12 md:h-16 rounded-lg border border-transparent ${isToday ? 'bg-emerald-500 text-white font-bold' : 'hover:border-emerald-400'}`;
                    dayEl.dataset.date = dateStr;
                    dayEl.innerHTML = `<span>${day}</span><div class="flex gap-1 mt-1">${dayEngagements.map(() => `<div class="event-dot"></div>`).join('')}</div>`;
                    dayEl.addEventListener('click', () => openEngagementModal(dateStr));
                    calendarGridEl.appendChild(dayEl);
                }
            };

            const downloadOutline = (outlineId) => {
                const outline = outlines.find(o => o.id === outlineId);
                if (!outline) return;

                const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${outline.title}</title></head><body>`;
                const footer = "</body></html>";
                
                let contentHtml = `<h1>${outline.title}</h1>`;
                contentHtml += `<p><strong>Livro:</strong> ${outline.book}</p><br>`;
                contentHtml += `<h2>Esboço</h2>`;
                contentHtml += `<div>${outline.content}</div>`;

                if (outline.notes) {
                    contentHtml += `<br><h2>Notas e Ilustrações</h2>`;
                    contentHtml += `<p>${outline.notes.replace(/\n/g, '<br>')}</p>`;
                }
                
                const source = header + contentHtml + footer;

                const fileDownload = htmlDocx.asBlob(source);
                
                const url = URL.createObjectURL(fileDownload);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${outline.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('A baixar o esboço...');
            };

            const printOutline = (outlineId) => {
                const outline = outlines.find(o => o.id === outlineId);
                if (!outline) return;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Imprimir Esboço</title>');
                printWindow.document.write(`
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Georgia&family=Helvetica&display=swap');
                        body { 
                            font-family: 'Georgia', serif; 
                            line-height: 1.6;
                            margin: 40px;
                        } 
                        h1, h2 {
                             font-family: 'Helvetica', sans-serif;
                             color: #222; 
                             border-bottom: 2px solid #333;
                             padding-bottom: 8px;
                             margin-top: 24px;
                        }
                        h1 { font-size: 24pt; }
                        h2 { font-size: 18pt; }
                        p, div, li { font-size: 12pt; }
                        strong { font-weight: bold; }
                        em, i { font-style: italic; }
                        u { text-decoration: underline; }
                    </style>
                `);
                printWindow.document.write('</head><body>');
                printWindow.document.write(`<h1>${outline.title}</h1>`);
                printWindow.document.write(`<p><strong>Livro:</strong> ${outline.book}</p>`);
                printWindow.document.write('<h2>Esboço</h2>');
                printWindow.document.write(`<div>${outline.content}</div>`);
                if(outline.notes) {
                    printWindow.document.write('<h2>Notas e Ilustrações</h2>');
                    printWindow.document.write(`<p>${outline.notes.replace(/\n/g, '<br>')}</p>`);
                }
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                
                // Wait for content to render before printing
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            };

            const renderOutlines = () => {
                archiveListEl.innerHTML = '';
                modalOutlineSelectEl.innerHTML = '<option value="">Nenhum (somente agendar)</option>';
                const groupedOutlines = BIBLE_BOOKS.reduce((acc, book) => {
                    const bookOutlines = outlines.filter(o => o.book === book);
                    if (bookOutlines.length > 0) acc[book] = bookOutlines;
                    return acc;
                }, {});
                if (outlines.length === 0) {
                    archiveListEl.innerHTML = '<p class="text-gray-400 text-sm">Nenhum esboço salvo ainda.</p>';
                }
                for (const book in groupedOutlines) {
                    const bookSection = document.createElement('div');
                    bookSection.innerHTML = `<h3 class="text-lg font-semibold text-emerald-400">${book}</h3>`;
                    const list = document.createElement('ul');
                    list.className = 'ml-4 space-y-1';
                    groupedOutlines[book].forEach(outline => {
                        const li = document.createElement('li');
                        li.className = 'text-gray-300 hover:text-white flex justify-between items-center group';
                        li.innerHTML = `
                            <span class="cursor-pointer flex-grow pr-4"><i class="fas fa-file-alt mr-2 text-gray-500"></i>${outline.title}</span>
                            <div class="flex items-center gap-4 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                                <button data-id="${outline.id}" class="print-outline-btn text-sky-400 hover:text-sky-300" title="Imprimir"><i class="fas fa-print"></i></button>
                                <button data-id="${outline.id}" class="download-outline-btn text-emerald-400 hover:text-emerald-300" title="Baixar como DOCX"><i class="fas fa-file-word"></i></button>
                                <button data-id="${outline.id}" class="delete-outline-btn text-red-500 hover:text-red-400" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        
                        li.querySelector('span').addEventListener('click', () => loadOutlineIntoEditor(outline.id));
                        
                        li.querySelector('.print-outline-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            printOutline(outline.id);
                        });

                        li.querySelector('.download-outline-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            downloadOutline(outline.id);
                        });

                        li.querySelector('.delete-outline-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            showConfirmationModal('Tem certeza que deseja excluir este esboço?', async () => {
                               await deleteDoc(doc(outlinesCol, outline.id));
                               showToast('Esboço excluído.');
                               if(currentEditingOutlineId === outline.id) clearEditor();
                            });
                        });

                        list.appendChild(li);
                    });
                    bookSection.appendChild(list);
                    archiveListEl.appendChild(bookSection);
                }
                outlines.forEach(outline => modalOutlineSelectEl.add(new Option(outline.title, outline.id)));
            };
        
            const renderEngagementsList = () => {
                const sortedEngagements = [...engagements].filter(e => new Date(e.date) >= new Date(new Date().toDateString())).sort((a, b) => new Date(a.date) - new Date(b.date));
                if(sortedEngagements.length === 0) {
                    engagementsListEl.innerHTML = '<p class="text-gray-400 text-sm">Nenhuma ministração agendada.</p>';
                    return;
                }
                engagementsListEl.innerHTML = sortedEngagements.map(e => {
                    const outline = outlines.find(o => o.id === e.outlineId);
                    const date = new Date(`${e.date}T12:00:00Z`);
                    const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', timeZone: 'UTC' });
                    return `<div class="p-2 rounded-lg hover:bg-gray-700 cursor-pointer" data-engagement-id="${e.id}"><p class="font-semibold text-white">${formattedDate} - ${e.title}</p><p class="text-sm text-gray-400">${outline ? outline.title : 'Sem esboço vinculado'}</p></div>`;
                }).join('');
                document.querySelectorAll('#engagements-list [data-engagement-id]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const engagementId = e.currentTarget.dataset.engagementId;
                        const engagement = engagements.find(eng => eng.id === engagementId);
                        if (engagement && engagement.outlineId) {
                            openPresentationMode(engagement.outlineId);
                        } else {
                            showToast("Este agendamento não tem um esboço vinculado.");
                        }
                    });
                });
            };

            const renderFastingSchedules = () => {
                const sortedSchedules = [...fastingSchedules].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                if (sortedSchedules.length === 0) {
                    fastingListEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Nenhum propósito cadastrado.</p>';
                    return;
                }
                fastingListEl.innerHTML = sortedSchedules.map(item => {
                    const startDate = new Date(`${item.startDate}T12:00:00Z`).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    const endDate = new Date(`${item.endDate}T12:00:00Z`).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    return `<div class="bg-gray-800 p-3 rounded-lg group"><div class="flex justify-between items-start"><div><p class="font-semibold text-white">${item.title}</p><p class="text-xs text-emerald-400">${startDate} até ${endDate}</p></div><button data-id="${item.id}" class="delete-fasting-btn text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-sm"><i class="fas fa-trash"></i></button></div><p class="text-sm text-gray-300 mt-2">${item.notes || ''}</p></div>`;
                }).join('');
                document.querySelectorAll('.delete-fasting-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.currentTarget.dataset.id;
                        showConfirmationModal('Deseja excluir este propósito?', async () => {
                            await deleteDoc(doc(fastingCol, id));
                            showToast('Propósito excluído.');
                        });
                    });
                });
            };

            const renderVerseDisplayPlaceholder = () => {
                if (verseDisplayEl.children.length === 0) {
                    verseDisplayEl.innerHTML = '<p class="text-gray-500 italic flex items-center justify-center h-full w-full text-center">Consulte um versículo...</p>';
                }
            };
            
            const setupFirebaseListeners = () => {
                 outlinesCol = collection(db, `artifacts/${appId}/users/${userId}/outlines`);
                 engagementsCol = collection(db, `artifacts/${appId}/users/${userId}/engagements`);
                 fastingCol = collection(db, `artifacts/${appId}/users/${userId}/fastingSchedules`);
                outlinesUnsubscribe = onSnapshot(query(outlinesCol), (snapshot) => {
                    outlines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.title.localeCompare(b.title));
                    renderOutlines();
                    renderEngagementsList();
                });
                engagementsUnsubscribe = onSnapshot(query(engagementsCol), (snapshot) => {
                    engagements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCalendar();
                    renderEngagementsList();
                });
                fastingUnsubscribe = onSnapshot(query(fastingCol), (snapshot) => {
                    fastingSchedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderFastingSchedules();
                });
            };
            
            const changeMonth = (offset) => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                renderCalendar();
            };

            const saveOutline = async () => {
                const title = outlineTitleEl.value.trim();
                const content = outlineContentEl.innerHTML;
                const notes = outlineNotesEl.value.trim();
                const book = bibleBookSelectEl.value;
                if (!title || !content) {
                    showToast('Preencha o título e o conteúdo.');
                    return;
                }
                const outlineData = { title, content, notes, book, updatedAt: new Date() };
                if (currentEditingOutlineId) {
                    await setDoc(doc(outlinesCol, currentEditingOutlineId), outlineData, { merge: true });
                    showToast('Esboço atualizado com sucesso!');
                } else {
                    const newDoc = await addDoc(outlinesCol, outlineData);
                    currentEditingOutlineId = newDoc.id; // Keep editing the same doc after first save
                    editorTitleEl.textContent = 'Editando Esboço';
                    showToast('Esboço salvo com sucesso!');
                }
            };

            const loadOutlineIntoEditor = (id) => {
                const outline = outlines.find(o => o.id === id);
                if (outline) {
                    currentEditingOutlineId = id;
                    outlineTitleEl.value = outline.title;
                    outlineContentEl.innerHTML = outline.content;
                    outlineNotesEl.value = outline.notes || '';
                    bibleBookSelectEl.value = outline.book;
                    editorTitleEl.textContent = 'Editando Esboço';
                }
                 if(window.innerWidth < 1024) { // If on mobile, switch to editor view
                    switchMobileView('center-panel');
                }
            };

            const clearEditor = () => {
                currentEditingOutlineId = null;
                outlineTitleEl.value = '';
                outlineContentEl.innerHTML = '';
                outlineNotesEl.value = '';
                bibleBookSelectEl.value = BIBLE_BOOKS[0];
                editorTitleEl.textContent = 'Novo Esboço';
                outlineTitleEl.focus();
            };

            const openEngagementModal = (dateStr) => {
                currentSelectedDate = dateStr;
                const engagement = engagements.find(e => e.date === dateStr);
                const date = new Date(`${dateStr}T12:00:00Z`);
                modalDateEl.textContent = date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
                if (engagement) {
                    currentEditingEngagementId = engagement.id;
                    engagementTitleEl.value = engagement.title;
                    modalOutlineSelectEl.value = engagement.outlineId || '';
                    deleteEngagementBtn.classList.remove('hidden');
                } else {
                    currentEditingEngagementId = null;
                    engagementTitleEl.value = '';
                    modalOutlineSelectEl.value = '';
                    deleteEngagementBtn.classList.add('hidden');
                }
                engagementModalEl.classList.remove('hidden');
                engagementModalEl.classList.add('flex');
            };

            const closeEngagementModal = () => {
                engagementModalEl.classList.add('hidden');
                engagementModalEl.classList.remove('flex');
            };
            
            const handleSaveEngagement = async () => {
                const title = engagementTitleEl.value.trim();
                const outlineId = modalOutlineSelectEl.value;
                if (!title) {
                    showToast('Por favor, preencha o título.');
                    return;
                }
                const engagementData = { date: currentSelectedDate, title: title, outlineId: outlineId };
                if (currentEditingEngagementId) {
                    // Update existing engagement
                    await setDoc(doc(engagementsCol, currentEditingEngagementId), engagementData, { merge: true });
                } else {
                    // Add new engagement
                    await addDoc(engagementsCol, engagementData);
                }
                showToast('Agendamento salvo!');
                closeEngagementModal();
            };
            
            const handleDeleteEngagement = async () => {
                if (currentEditingEngagementId) {
                    showConfirmationModal('Tem certeza que deseja excluir este agendamento?', async () => {
                        await deleteDoc(doc(engagementsCol, currentEditingEngagementId));
                        showToast('Agendamento excluído.');
                        closeEngagementModal();
                    });
                }
            }
            
            const saveFastingSchedule = async () => {
                const title = fastingTitleEl.value.trim();
                const startDate = fastingStartDateEl.value;
                const endDate = fastingEndDateEl.value;
                const notes = fastingNotesEl.value.trim();
                if (!title || !startDate || !endDate) {
                    showToast('Preencha o propósito e as datas.');
                    return;
                }
                const scheduleData = { title, startDate, endDate, notes, createdAt: new Date() };
                await addDoc(fastingCol, scheduleData);
                showToast('Propósito salvo!');
                fastingTitleEl.value = '';
                fastingStartDateEl.value = '';
                fastingEndDateEl.value = '';
                fastingNotesEl.value = '';
            };

            const clearVerses = () => {
                verseDisplayEl.innerHTML = '';
                renderVerseDisplayPlaceholder();
                showToast('Resultados limpos.');
            };

            const fetchVerse = async (referenceOverride = null, targetElement = verseDisplayEl, isTopicalSearch = false) => {
                const book = bibleStudyBookSelectEl.value;
                const userInput = bibleRefInputEl.value.trim();
                
                let reference;
                if (referenceOverride) {
                    reference = referenceOverride;
                } else {
                    if (!userInput) return;
                    reference = /[a-zA-ZáéíóúâêîôûãõçÁÉÍÓÚÂÊÎÔÛÃÕÇ]/.test(userInput) ? userInput : `${book} ${userInput}`;
                }

                if (targetElement.querySelector('.italic')) targetElement.innerHTML = '';
                
                const loadingEl = document.createElement('div');
                if(isTopicalSearch) {
                    loadingEl.className = "w-full p-3 border border-gray-700 rounded-lg bg-gray-800 animate-pulse";
                } else {
                    loadingEl.className = "w-72 flex-shrink-0 p-3 border border-gray-700 rounded-lg bg-gray-800 animate-pulse";
                }
                loadingEl.innerHTML = `Buscando ${reference}...`;
                targetElement.appendChild(loadingEl);
                
                try {
                    const response = await fetch(`https://bible-api.com/${reference}?translation=almeida`);
                    if (!response.ok) throw new Error('Referência não encontrada.');
                    const data = await response.json();
                    loadingEl.remove();
                    
                    let verseContent = '';
                    if (data.verses) {
                        verseContent = data.verses.map(v => `<p class="mb-2"><strong>${v.verse}</strong>&nbsp;${v.text}</p>`).join('');
                    } else {
                        verseContent = `<p>${data.text}</p>`;
                    }

                    const verseEl = document.createElement('div');
                    if(isTopicalSearch){
                         verseEl.className = "w-full p-3 border border-gray-700 rounded-lg bg-gray-800 flex flex-col";
                    } else {
                         verseEl.className = "w-72 flex-shrink-0 p-3 border border-gray-700 rounded-lg bg-gray-800 h-full flex flex-col";
                    }
                    verseEl.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-bold text-emerald-400">${data.reference}</p>
                            <div class="flex items-center gap-3">
                                 <button class="explain-verse-btn text-sky-400 hover:text-sky-300" title="Explicar versículo"><i class="fas fa-comment-dots"></i></button>
                                 <button class="remove-verse-btn text-gray-500 hover:text-red-400 text-xs"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="${isTopicalSearch ? '' : 'overflow-y-auto flex-grow min-h-0'}">${verseContent}</div>
                    `;
                    verseEl.querySelector('.remove-verse-btn').addEventListener('click', () => {
                        verseEl.remove();
                        if (targetElement.children.length === 0) {
                             if(isTopicalSearch){
                                topicalResultsDisplay.innerHTML = '<p class="text-gray-500 italic flex items-center justify-center h-full">Pesquise um tema para ver os versículos relacionados.</p>';
                             } else {
                                renderVerseDisplayPlaceholder();
                             }
                        }
                    });
                    verseEl.querySelector('.explain-verse-btn').addEventListener('click', () => openExplanationModal(data.reference));
                    
                    targetElement.appendChild(verseEl);
                    if(!isTopicalSearch) {
                       bibleRefInputEl.value = ''; 
                       bibleRefInputEl.focus();
                    }

                } catch (error) {
                    loadingEl.innerHTML = `<p class="text-red-400">Erro ao buscar ${reference}: ${error.message}</p>`;
                    setTimeout(() => { 
                        loadingEl.remove();
                         if (targetElement.children.length === 0) {
                             if(isTopicalSearch){
                                topicalResultsDisplay.innerHTML = '<p class="text-gray-500 italic flex items-center justify-center h-full">Pesquise um tema para ver os versículos relacionados.</p>';
                             } else {
                                renderVerseDisplayPlaceholder();
                             }
                        }
                    }, 3000);
                } finally {
                    if(!isTopicalSearch) {
                         targetElement.scrollLeft = targetElement.scrollWidth;
                    }
                }
            };
            
            const handleGenerateSuggestion = async () => {
                const theme = suggestionThemeInputEl.value.trim();
                if (!theme) {
                    showToast("Por favor, insira um tema.");
                    return;
                }
                suggestionResultEl.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>Gerando esboço...</div>';
                useSuggestionBtn.classList.add('hidden');
                generateSuggestionBtn.disabled = true;
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `Você é um assistente pastoral e teólogo. Sua tarefa é criar esboços para sermões bíblicos. Seja claro, objetivo e estruture a resposta sempre da mesma forma.`;
                const userQuery = `Crie um esboço de sermão sobre o tema "${theme}". A resposta DEVE ter o seguinte formato:\nTítulo: [Título do Sermão]\n\n[Restante do conteúdo do esboço, incluindo uma introdução, 3 pontos principais com versículos de apoio, e uma conclusão].`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        suggestionResultEl.textContent = text;
                        useSuggestionBtn.classList.remove('hidden');
                    } else {
                        throw new Error("Resposta da IA inválida ou vazia.");
                    }
                } catch (error) {
                    console.error("Error generating suggestion:", error);
                    suggestionResultEl.textContent = `Ocorreu um erro ao gerar a sugestão. Tente novamente.\nDetalhes: ${error.message}`;
                } finally {
                    generateSuggestionBtn.disabled = false;
                }
            };
            
            const useSuggestion = () => {
                const fullText = suggestionResultEl.textContent;
                const lines = fullText.split('\n');
                let title = "Esboço Gerado", content = fullText;
                if(lines[0].toLowerCase().startsWith('título:')) {
                    title = lines[0].substring(7).trim();
                    content = lines.slice(2).join('\n');
                }
                outlineTitleEl.value = title;
                outlineContentEl.innerHTML = content.replace(/\n/g, '<br>');
                closeSuggestionModal();
                showToast("Esboço inserido no editor!");
            };

            const openSuggestionModal = () => {
                suggestionModalEl.classList.remove('hidden');
                suggestionModalEl.classList.add('flex');
                suggestionThemeInputEl.focus();
            };

            const closeSuggestionModal = () => {
                suggestionModalEl.classList.add('hidden');
                suggestionModalEl.classList.remove('flex');
                suggestionResultEl.textContent = 'Aguardando um tema para gerar a sugestão...';
                suggestionThemeInputEl.value = '';
                useSuggestionBtn.classList.add('hidden');
            };

            const switchTab = (tabName) => {
                document.querySelectorAll('.right-tab-pane').forEach(pane => pane.classList.add('hidden'));
                document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
            };
            
            const openPresentationMode = (outlineId) => {
                const outline = outlines.find(o => o.id === outlineId);
                if (outline) {
                    presentationTitleEl.textContent = outline.title;
                    presentationContentEl.innerHTML = outline.content;
                    presentationModalEl.classList.remove('hidden');
                    presentationModalEl.classList.add('flex');
                }
            };
            
            const closePresentationMode = () => {
                presentationModalEl.classList.add('hidden');
                presentationModalEl.classList.remove('flex');
            };
            
            const switchMobileView = (viewId) => {
                mainPanels.forEach(panel => {
                    if (panel.id === viewId) {
                        panel.classList.remove('hidden');
                        panel.classList.add('flex');
                    } else {
                        panel.classList.add('hidden');
                        panel.classList.remove('flex');
                    }
                });
                mobileNavBtns.forEach(btn => {
                    if (btn.dataset.view === viewId) {
                        btn.classList.add('active', 'text-emerald-400');
                        btn.classList.remove('text-gray-400');
                    } else {
                        btn.classList.remove('active', 'text-emerald-400');
                        btn.classList.add('text-gray-400');
                    }
                });
            };

            const switchStudySubTab = (subtabName) => {
                studySubtabPanes.forEach(pane => {
                    pane.classList.toggle('hidden', pane.id !== `${subtabName}-pane`);
                });
                document.querySelectorAll('.study-subtab-btn').forEach(btn => {
                    const isActive = btn.dataset.subtab === subtabName;
                    btn.classList.toggle('border-emerald-400', isActive);
                    btn.classList.toggle('text-white', isActive);
                    btn.classList.toggle('border-transparent', !isActive);
                    btn.classList.toggle('text-gray-400', !isActive);
                });
            };

            const openExplanationModal = (reference) => {
                explanationTitle.textContent = `Explicação de ${reference}`;
                explanationResult.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>A carregar explicação...</div>';
                explanationModal.classList.remove('hidden');
                explanationModal.classList.add('flex');
                getVerseExplanation(reference);
            };

            const closeExplanationModal = () => {
                explanationModal.classList.add('hidden');
                explanationModal.classList.remove('flex');
            };

            const getVerseExplanation = async (reference) => {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `Você é um teólogo e estudioso da Bíblia. Forneça uma explicação clara e concisa para o versículo bíblico solicitado. Foque no contexto histórico, significado teológico e aplicação prática.`;
                const userQuery = `Explique o versículo: ${reference}.`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        explanationResult.textContent = text;
                    } else {
                        throw new Error("Resposta da IA inválida ou vazia.");
                    }
                } catch (error) {
                    console.error("Error getting explanation:", error);
                    explanationResult.textContent = `Ocorreu um erro ao buscar a explicação. Detalhes: ${error.message}`;
                }
            };

            const handleTopicalSearch = async () => {
                const theme = topicalThemeInput.value.trim();
                if (!theme) {
                    showToast("Por favor, insira um tema.");
                    return;
                }
                topicalResultsDisplay.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>A procurar versículos sobre o tema...</div>';
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `Você é um assistente de estudo bíblico. Sua tarefa é encontrar referências bíblicas sobre um determinado tema.`;
                const userQuery = `Liste 5 a 7 referências de versículos bíblicos chave sobre o tema "${theme}". Responda APENAS com as referências, separadas por vírgula (ex: João 3:16, Romanos 8:28, Salmos 23:1).`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        topicalResultsDisplay.innerHTML = ''; // Clear loading
                        const references = text.split(',').map(ref => ref.trim());
                        for (const ref of references) {
                            if (ref) {
                               await fetchVerse(ref, topicalResultsDisplay, true);
                            }
                        }
                    } else {
                        throw new Error("Não foi possível encontrar versículos para este tema.");
                    }

                } catch (error) {
                    console.error("Error on topical search:", error);
                    topicalResultsDisplay.innerHTML = `<p class="text-red-400 text-center">${error.message}</p>`;
                }
            };

             const toggleFocusMode = () => {
                isFocusMode = !isFocusMode;
                const icon = toggleFocusModeBtn.querySelector('i');
                
                leftPanel.classList.toggle('hidden', isFocusMode);
                rightPanel.classList.toggle('hidden', isFocusMode);

                centerPanel.classList.toggle('lg:w-1/2', !isFocusMode);
                centerPanel.classList.toggle('lg:w-full', isFocusMode);

                if (isFocusMode) {
                    icon.classList.remove('fa-expand-arrows-alt');
                    icon.classList.add('fa-compress-arrows-alt');
                    toggleFocusModeBtn.title = "Sair do Modo Foco";
                } else {
                    icon.classList.remove('fa-compress-arrows-alt');
                    icon.classList.add('fa-expand-arrows-alt');
                    toggleFocusModeBtn.title = "Modo Foco";
                }
            };


            // Initial calls
            bibleBookSelectEl.innerHTML = '';
            bibleStudyBookSelectEl.innerHTML = '';
            BIBLE_BOOKS.forEach(book => {
                bibleBookSelectEl.add(new Option(book, book));
                bibleStudyBookSelectEl.add(new Option(book, book));
            });
            document.getElementById('prev-month').onclick = () => changeMonth(-1);
            document.getElementById('next-month').onclick = () => changeMonth(1);
            saveOutlineBtn.onclick = saveOutline;
            document.getElementById('clear-editor-btn').onclick = clearEditor;
            document.getElementById('cancel-engagement').onclick = closeEngagementModal;
            document.getElementById('save-engagement').onclick = handleSaveEngagement;
            document.getElementById('delete-engagement').onclick = handleDeleteEngagement;
            document.getElementById('fetch-verse-btn').onclick = () => fetchVerse(null, verseDisplayEl);
            document.getElementById('clear-verses-btn').onclick = clearVerses;
            bibleRefInputEl.onkeypress = (e) => { if (e.key === 'Enter') fetchVerse(null, verseDisplayEl); };
            document.getElementById('right-tabs').onclick = (e) => {
                const tabBtn = e.target.closest('.tab-btn');
                if(tabBtn) switchTab(tabBtn.dataset.tab);
            };
            document.getElementById('save-fasting-btn').onclick = saveFastingSchedule;

            document.getElementById('format-bold').onclick = () => formatText('bold');
            document.getElementById('format-italic').onclick = () => formatText('italic');
            document.getElementById('format-underline').onclick = () => formatText('underline');
            document.getElementById('format-list').onclick = () => formatText('insertOrderedList');
            document.getElementById('font-color-picker').oninput = (e) => formatText('foreColor', e.target.value);
            document.getElementById('font-size-select').onchange = (e) => formatText('fontSize', e.target.value);

            document.getElementById('suggestion-btn').onclick = openSuggestionModal;
            document.getElementById('cancel-suggestion').onclick = closeSuggestionModal;
            generateSuggestionBtn.onclick = handleGenerateSuggestion;
            useSuggestionBtn.onclick = useSuggestion;
            suggestionThemeInputEl.onkeypress = (e) => { if (e.key === 'Enter') handleGenerateSuggestion(); };
            
            document.getElementById('close-presentation-btn').onclick = closePresentationMode;
            
            mobileNavBtns.forEach(btn => {
                btn.addEventListener('click', () => switchMobileView(btn.dataset.view));
            });
            
            studySubTabs.addEventListener('click', (e) => {
                const tabBtn = e.target.closest('.study-subtab-btn');
                if (tabBtn) switchStudySubTab(tabBtn.dataset.subtab);
            });
            fetchTopicBtn.onclick = handleTopicalSearch;
            topicalThemeInput.onkeypress = (e) => { if (e.key === 'Enter') handleTopicalSearch(); };
            closeExplanationBtn.onclick = closeExplanationModal;
            toggleFocusModeBtn.onclick = toggleFocusMode;

            setupFirebaseListeners();
            switchTab('archive');
            renderCalendar();
            renderVerseDisplayPlaceholder();
            if (window.innerWidth < 1024) {
                switchMobileView('left-panel'); // Set initial view for mobile
            }
        }

    </script>
</body>
</html>

