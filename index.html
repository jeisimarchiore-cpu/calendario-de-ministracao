<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Ministrações</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            background-color: #374151; /* bg-gray-700 */
            transform: scale(1.05);
        }
        .event-dot {
            width: 8px;
            height: 8px;
            background-color: #34d399; /* bg-emerald-400 */
            border-radius: 50%;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Glassmorphism effect for modals */
        .modal-glass {
            background: rgba(31, 41, 55, 0.6); /* bg-gray-800 with opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Tab styling */
        .tab-btn.active {
            border-bottom-color: #34d399; /* border-emerald-400 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .editor-toolbar button {
            transition: background-color 0.2s;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Container -->
    <div class="flex h-screen w-full p-4 gap-4">

        <!-- Left Panel: Calendar and Engagements -->
        <aside class="w-1/4 flex flex-col gap-4">
            <!-- Calendar Card -->
            <div id="calendar-card" class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="month-year" class="text-xl font-bold text-white"></h2>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-700 transition-colors"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-400 mb-2">
                    <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
                </div>
                <div id="calendar-grid" class="grid calendar-grid gap-1 flex-grow">
                    <!-- Calendar days will be generated by JS -->
                </div>
            </div>
            <!-- Engagements List -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg h-1/3 overflow-y-auto">
                 <h3 class="text-lg font-semibold text-white mb-2 border-b border-gray-700 pb-2">Próximas Ministrações</h3>
                 <div id="engagements-list">
                    <!-- Engagements list will be populated by JS -->
                    <p class="text-gray-400 text-sm">Nenhuma ministração agendada.</p>
                 </div>
            </div>
        </aside>

        <!-- Center Panel: Outline Editor -->
        <main class="w-1/2 bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h2 id="editor-title" class="text-2xl font-bold text-white">Novo Esboço</h2>
                <div class="flex gap-2">
                    <button id="suggestion-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2" title="Gerar sugestão de esboço"><i class="fas fa-lightbulb"></i> Gerar Ideia</button>
                    <button id="save-outline-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2"><i class="fas fa-save"></i> Salvar</button>
                    <button id="clear-editor-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fas fa-eraser"></i> Limpar</button>
                </div>
            </div>
            
            <input type="text" id="outline-title" placeholder="Título do Esboço" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 mb-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            
            <div class="flex-grow flex gap-4 overflow-hidden">
                <!-- Main Editor Column -->
                <div class="w-2/3 flex flex-col">
                    <div class="editor-toolbar flex items-center gap-2 bg-gray-900 p-2 rounded-t-lg border-b border-gray-700">
                         <button id="format-bold" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Negrito"><i class="fas fa-bold"></i></button>
                         <button id="format-italic" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Itálico"><i class="fas fa-italic"></i></button>
                         <button id="format-underline" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Sublinhado"><i class="fas fa-underline"></i></button>
                         <button id="format-list" class="px-3 py-1 text-sm rounded hover:bg-gray-700" title="Lista Numerada"><i class="fas fa-list-ol"></i></button>
                    </div>
                    <textarea id="outline-content" placeholder="Comece a escrever sua ministração aqui..." class="w-full h-full flex-grow bg-gray-900 border-x border-b border-gray-700 rounded-b-lg p-4 text-gray-200 resize-none focus:outline-none"></textarea>
                </div>
                <!-- Notes Column -->
                <div class="w-1/3 flex flex-col">
                    <label for="outline-notes" class="block mb-2 text-sm font-medium text-gray-300">Notas e Ilustrações</label>
                    <textarea id="outline-notes" placeholder="Anote aqui ideias, ilustrações, estatísticas..." class="w-full h-full flex-grow bg-gray-900 border border-gray-700 rounded-lg p-4 text-gray-200 resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
            </div>

            <div class="mt-4">
                <label for="bible-book-select" class="block mb-2 text-sm font-medium text-gray-300">Vincular esboço ao livro de:</label>
                <select id="bible-book-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5">
                    <!-- Options will be generated by JS -->
                </select>
            </div>
        </main>

        <!-- Right Panel: Tools (Archive, Study, Fasting) -->
        <aside class="w-1/4 bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col">
             <!-- Tabs Navigation -->
            <div class="border-b border-gray-700 mb-4">
                <nav id="right-tabs" class="flex gap-4 -mb-px">
                    <button data-tab="archive" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium">
                        <i class="fas fa-archive mr-2"></i>Arquivo
                    </button>
                    <button data-tab="study" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium">
                        <i class="fas fa-book-open mr-2"></i>Estudo
                    </button>
                    <button data-tab="fasting" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-white transition-colors text-sm font-medium">
                        <i class="fas fa-pray mr-2"></i>Jejum
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="right-tab-content" class="flex-grow flex flex-col overflow-y-hidden">
                <!-- Archive Tab -->
                <div id="archive-tab-content" class="right-tab-pane flex-grow overflow-y-auto">
                    <div id="archive-list" class="space-y-2">
                        <!-- Archive content will be generated by JS -->
                    </div>
                </div>
                
                <!-- Bible Study Tab -->
                <div id="study-tab-content" class="right-tab-pane hidden flex-grow flex flex-col">
                     <h3 class="text-xl font-semibold text-white mb-2">Estudo Rápido</h3>
                    <div class="flex gap-2 mb-2 items-center">
                        <select id="bible-study-book-select" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 p-2.5">
                            <!-- Options will be generated by JS -->
                        </select>
                        <input type="text" id="bible-ref-input" placeholder="3:16" class="w-1/3 bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <button id="fetch-verse-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-2.5 rounded-lg transition-colors"><i class="fas fa-search"></i></button>
                        <button id="clear-verses-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2.5 rounded-lg transition-colors" title="Limpar"><i class="fas fa-times-circle"></i></button>
                    </div>
                    <div id="verse-display" class="bg-gray-900 rounded-lg p-3 flex-grow text-gray-300 text-sm flex gap-4 overflow-x-auto pb-4">
                        <!-- Verses will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Fasting and Prayer Tab -->
                <div id="fasting-tab-content" class="right-tab-pane hidden flex-grow flex flex-col">
                    <h3 class="text-xl font-semibold text-white mb-2">Jejum e Oração</h3>
                    <div class="bg-gray-900 rounded-lg p-3 mb-3">
                        <h4 class="font-semibold text-white mb-2 text-sm">Novo Propósito</h4>
                         <input type="text" id="fasting-title" placeholder="Propósito" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm mb-2">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label for="fasting-start-date" class="text-xs text-gray-400">Início</label>
                                <input type="date" id="fasting-start-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                            </div>
                            <div>
                                <label for="fasting-end-date" class="text-xs text-gray-400">Fim</label>
                                <input type="date" id="fasting-end-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm">
                            </div>
                        </div>
                        <textarea id="fasting-notes" placeholder="Anotações..." rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"></textarea>
                        <button id="save-fasting-btn" class="mt-2 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Adicionar</button>
                    </div>
                    <div id="fasting-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                        <!-- Fasting items will be listed here -->
                    </div>
                </div>
            </div>
        </aside>

    </div>

    <!-- Add Engagement Modal -->
    <div id="engagement-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-white">Agendar Ministração</h3>
            <p class="mb-4 text-gray-300">Data: <span id="modal-date" class="font-semibold"></span></p>
            <div>
                <label for="engagement-title" class="block mb-2 text-sm font-medium text-gray-300">Título do Evento/Local</label>
                <input type="text" id="engagement-title" placeholder="Ex: Culto de Domingo - Igreja X" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 mb-4">
            </div>
            <div>
                <label for="modal-outline-select" class="block mb-2 text-sm font-medium text-gray-300">Vincular Esboço</label>
                <select id="modal-outline-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5">
                    <option value="">Nenhum (somente agendar)</option>
                    <!-- Outline options will be populated by JS -->
                </select>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-engagement" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">Cancelar</button>
                <button id="save-engagement" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg transition-colors">Salvar Agendamento</button>
                 <button id="delete-engagement" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors hidden">Excluir</button>
            </div>
        </div>
    </div>
    
    <!-- AI Suggestion Modal -->
    <div id="suggestion-modal" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center hidden">
        <div class="modal-glass p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-white">Assistente de Esboços (IA)</h3>
            <p class="text-sm text-gray-300 mb-4">Digite um tema, versículo ou palavra-chave para gerar uma sugestão de esboço.</p>
            <div class="flex gap-2 mb-4">
                <input type="text" id="suggestion-theme-input" placeholder="Ex: A Parábola do Filho Pródigo" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-emerald-500 block w-full p-2.5">
                <button id="generate-suggestion-btn" class="py-2 px-4 bg-sky-500 hover:bg-sky-600 text-white rounded-lg transition-colors">Gerar Esboço</button>
            </div>
            <div id="suggestion-result" class="bg-gray-900 rounded-lg p-4 flex-grow overflow-y-auto text-gray-300 text-sm whitespace-pre-wrap">
                Aguardando um tema para gerar a sugestão...
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-suggestion" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">Fechar</button>
                <button id="use-suggestion-btn" class="py-2 px-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg transition-colors hidden">Usar este Esboço</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-emerald-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
        <p>Ação realizada com sucesso!</p>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCp2CxegdrcOk4Bj6I45_8LOl0nTOt3rEg",
            authDomain: "calendario-de-ministracao.firebaseapp.com",
            projectId: "calendario-de-ministracao",
            storageBucket: "calendario-de-ministracao.firebasestorage.app",
            messagingSenderId: "1091866768883",
            appId: "1:1091866768883:web:9290fd424ff5cbf0980e86",
            measurementId: "G-TBPTMVYF4M"
        };
        const appId = 'default-preaching-app'; // Using a default app id for simplicity

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let outlinesCol;
        let engagementsCol;
        let fastingCol;

        // --- Global State ---
        let currentDate = new Date();
        let outlines = [];
        let engagements = [];
        let fastingSchedules = [];
        let currentEditingOutlineId = null;
        let currentSelectedDate = null;
        let currentEditingEngagementId = null;

        const BIBLE_BOOKS = [
            "Gênesis", "Êxodo", "Levítico", "Números", "Deuteronômio", "Josué", "Juízes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Crônicas", "2 Crônicas", "Esdras", "Neemias", "Ester", "Jó", "Salmos", "Provérbios", "Eclesiastes", "Cânticos", "Isaías", "Jeremias", "Lamentações", "Ezequiel", "Daniel", "Oséias", "Joel", "Amós", "Obadias", "Jonas", "Miquéias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias",
            "Mateus", "Marcos", "Lucas", "João", "Atos", "Romanos", "1 Coríntios", "2 Coríntios", "Gálatas", "Efésios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Timóteo", "2 Timóteo", "Tito", "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 João", "2 João", "3 João", "Judas", "Apocalipse"
        ];
        
        // --- DOM Elements ---
        const monthYearEl = document.getElementById('month-year');
        const calendarGridEl = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const saveOutlineBtn = document.getElementById('save-outline-btn');
        const clearEditorBtn = document.getElementById('clear-editor-btn');
        const outlineTitleEl = document.getElementById('outline-title');
        const outlineContentEl = document.getElementById('outline-content');
        const outlineNotesEl = document.getElementById('outline-notes');
        const bibleBookSelectEl = document.getElementById('bible-book-select');
        const archiveListEl = document.getElementById('archive-list');
        const engagementModalEl = document.getElementById('engagement-modal');
        const modalDateEl = document.getElementById('modal-date');
        const engagementTitleEl = document.getElementById('engagement-title');
        const modalOutlineSelectEl = document.getElementById('modal-outline-select');
        const cancelEngagementBtn = document.getElementById('cancel-engagement');
        const saveEngagementBtn = document.getElementById('save-engagement');
        const deleteEngagementBtn = document.getElementById('delete-engagement');
        const engagementsListEl = document.getElementById('engagements-list');
        const editorTitleEl = document.getElementById('editor-title');
        const fetchVerseBtn = document.getElementById('fetch-verse-btn');
        const bibleRefInputEl = document.getElementById('bible-ref-input');
        const verseDisplayEl = document.getElementById('verse-display');
        const clearVersesBtn = document.getElementById('clear-verses-btn');
        const bibleStudyBookSelectEl = document.getElementById('bible-study-book-select');
        const tabsEl = document.getElementById('right-tabs');
        const tabPanes = document.querySelectorAll('.right-tab-pane');
        const fastingTitleEl = document.getElementById('fasting-title');
        const fastingStartDateEl = document.getElementById('fasting-start-date');
        const fastingEndDateEl = document.getElementById('fasting-end-date');
        const fastingNotesEl = document.getElementById('fasting-notes');
        const saveFastingBtn = document.getElementById('save-fasting-btn');
        const fastingListEl = document.getElementById('fasting-list');
        const suggestionBtn = document.getElementById('suggestion-btn');
        const suggestionModalEl = document.getElementById('suggestion-modal');
        const cancelSuggestionBtn = document.getElementById('cancel-suggestion');
        const generateSuggestionBtn = document.getElementById('generate-suggestion-btn');
        const useSuggestionBtn = document.getElementById('use-suggestion-btn');
        const suggestionThemeInputEl = document.getElementById('suggestion-theme-input');
        const suggestionResultEl = document.getElementById('suggestion-result');

        // --- Utility Functions ---
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-20');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-20');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        };

        const formatText = (command) => {
            document.execCommand(command, false, null);
            outlineContentEl.focus();
        };


        // --- Render Functions ---
        const renderCalendar = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${year}`;
            
            calendarGridEl.innerHTML = '';
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGridEl.innerHTML += `<div class="p-2"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                const dayEngagements = engagements.filter(e => e.date === dateStr);
                
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day cursor-pointer flex flex-col items-center justify-center h-16 rounded-lg border border-transparent ${isToday ? 'bg-emerald-500 text-white font-bold' : 'hover:border-emerald-400'}`;
                dayEl.dataset.date = dateStr;
                
                dayEl.innerHTML = `
                    <span>${day}</span>
                    <div class="flex gap-1 mt-1">${dayEngagements.map(() => `<div class="event-dot"></div>`).join('')}</div>
                `;
                dayEl.addEventListener('click', () => openEngagementModal(dateStr));
                calendarGridEl.appendChild(dayEl);
            }
        };

        const renderOutlines = () => {
            archiveListEl.innerHTML = '';
            modalOutlineSelectEl.innerHTML = '<option value="">Nenhum (somente agendar)</option>';
            
            const groupedOutlines = BIBLE_BOOKS.reduce((acc, book) => {
                const bookOutlines = outlines.filter(o => o.book === book);
                if (bookOutlines.length > 0) {
                    acc[book] = bookOutlines;
                }
                return acc;
            }, {});

            if (outlines.length === 0) {
                 archiveListEl.innerHTML = '<p class="text-gray-400 text-sm">Nenhum esboço salvo ainda.</p>';
            }

            for (const book in groupedOutlines) {
                const bookSection = document.createElement('div');
                bookSection.innerHTML = `<h3 class="text-lg font-semibold text-emerald-400">${book}</h3>`;
                const list = document.createElement('ul');
                list.className = 'ml-4 space-y-1';
                groupedOutlines[book].forEach(outline => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-300 hover:text-white cursor-pointer flex justify-between items-center group';
                    li.innerHTML = `
                        <span><i class="fas fa-file-alt mr-2 text-gray-500"></i>${outline.title}</span>
                        <button data-id="${outline.id}" class="delete-outline-btn text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-trash-alt"></i></button>
                    `;
                    li.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-outline-btn')) return;
                        loadOutlineIntoEditor(outline.id)
                    });
                    list.appendChild(li);
                });
                bookSection.appendChild(list);
                archiveListEl.appendChild(bookSection);
            }
            
            outlines.forEach(outline => {
                const option = new Option(outline.title, outline.id);
                modalOutlineSelectEl.add(option);
            });
            
            document.querySelectorAll('.delete-outline-btn').forEach(btn => {
               btn.addEventListener('click', async (e) => {
                   const id = e.currentTarget.dataset.id;
                   if (confirm('Tem certeza que deseja excluir este esboço? Esta ação não pode ser desfeita.')) {
                        await deleteDoc(doc(outlinesCol, id));
                        showToast('Esboço excluído.');
                        clearEditor();
                   }
               }) 
            });
        };
        
        const renderEngagementsList = () => {
            const sortedEngagements = [...engagements]
                .filter(e => new Date(e.date) >= new Date(new Date().toDateString())) // From today onwards
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if(sortedEngagements.length === 0) {
                engagementsListEl.innerHTML = '<p class="text-gray-400 text-sm">Nenhuma ministração agendada.</p>';
                return;
            }

            engagementsListEl.innerHTML = sortedEngagements.map(e => {
                const outline = outlines.find(o => o.id === e.outlineId);
                const date = new Date(`${e.date}T00:00:00-03:00`); // Assuming local time
                const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                return `
                    <div class="p-2 rounded-lg hover:bg-gray-700 cursor-pointer" data-date="${e.date}">
                        <p class="font-semibold text-white">${formattedDate} - ${e.title}</p>
                        <p class="text-sm text-gray-400">${outline ? outline.title : 'Sem esboço vinculado'}</p>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('#engagements-list [data-date]').forEach(el => {
                el.addEventListener('click', (e) => {
                    const dateStr = e.currentTarget.dataset.date;
                    openEngagementModal(dateStr);
                })
            })
        };

        const renderFastingSchedules = () => {
            const sortedSchedules = [...fastingSchedules]
                .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            if (sortedSchedules.length === 0) {
                fastingListEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Nenhum propósito cadastrado.</p>';
                return;
            }

            fastingListEl.innerHTML = sortedSchedules.map(item => {
                const startDate = new Date(`${item.startDate}T00:00:00-03:00`).toLocaleDateString('pt-BR');
                const endDate = new Date(`${item.endDate}T00:00:00-03:00`).toLocaleDateString('pt-BR');

                return `
                    <div class="bg-gray-800 p-3 rounded-lg group">
                        <div class="flex justify-between items-start">
                             <div>
                                <p class="font-semibold text-white">${item.title}</p>
                                <p class="text-xs text-emerald-400">${startDate} até ${endDate}</p>
                             </div>
                            <button data-id="${item.id}" class="delete-fasting-btn text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-sm"><i class="fas fa-trash"></i></button>
                        </div>
                        <p class="text-sm text-gray-300 mt-2">${item.notes || ''}</p>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.delete-fasting-btn').forEach(btn => {
                btn.addEventListener('click', async e => {
                    const id = e.currentTarget.dataset.id;
                    if (confirm('Deseja excluir este propósito?')) {
                        await deleteDoc(doc(fastingCol, id));
                        showToast('Propósito excluído.');
                    }
                });
            });
        };

        const renderVerseDisplayPlaceholder = () => {
            if (verseDisplayEl.children.length === 0) {
                verseDisplayEl.innerHTML = '<p class="text-gray-500 italic flex items-center justify-center h-full">Consulte um versículo...</p>';
            }
        };

        // --- Event Handlers & Logic ---
        const setupFirebaseListeners = () => {
             outlinesCol = collection(db, `artifacts/${appId}/users/${userId}/outlines`);
             engagementsCol = collection(db, `artifacts/${appId}/users/${userId}/engagements`);
             fastingCol = collection(db, `artifacts/${appId}/users/${userId}/fastingSchedules`);

            onSnapshot(query(outlinesCol), (snapshot) => {
                outlines = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.title.localeCompare(b.title));
                renderOutlines();
                renderEngagementsList();
            });
            
            onSnapshot(query(engagementsCol), (snapshot) => {
                engagements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendar();
                renderEngagementsList();
            });

            onSnapshot(query(fastingCol), (snapshot) => {
                fastingSchedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFastingSchedules();
            });
        };
        
        const changeMonth = (offset) => {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        };

        const saveOutline = async () => {
            const title = outlineTitleEl.value.trim();
            const content = outlineContentEl.value; // Save HTML content
            const notes = outlineNotesEl.value.trim();
            const book = bibleBookSelectEl.value;

            if (!title || !content) {
                showToast('Preencha o título e o conteúdo.');
                return;
            }

            const outlineData = { title, content, notes, book, updatedAt: new Date() };

            if (currentEditingOutlineId) {
                await setDoc(doc(outlinesCol, currentEditingOutlineId), outlineData, { merge: true });
                showToast('Esboço atualizado com sucesso!');
            } else {
                await addDoc(outlinesCol, outlineData);
                showToast('Esboço salvo com sucesso!');
            }
            clearEditor();
        };

        const loadOutlineIntoEditor = (id) => {
            const outline = outlines.find(o => o.id === id);
            if (outline) {
                currentEditingOutlineId = id;
                outlineTitleEl.value = outline.title;
                outlineContentEl.value = outline.content;
                outlineNotesEl.value = outline.notes || '';
                bibleBookSelectEl.value = outline.book;
                editorTitleEl.textContent = 'Editando Esboço';
            }
        };

        const clearEditor = () => {
            currentEditingOutlineId = null;
            outlineTitleEl.value = '';
            outlineContentEl.value = '';
            outlineNotesEl.value = '';
            bibleBookSelectEl.value = BIBLE_BOOKS[0];
            editorTitleEl.textContent = 'Novo Esboço';
            outlineTitleEl.focus();
        };

        const openEngagementModal = (dateStr) => {
            currentSelectedDate = dateStr;
            const engagement = engagements.find(e => e.date === dateStr);

            const date = new Date(`${dateStr}T00:00:00-03:00`);
            modalDateEl.textContent = date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            if (engagement) {
                currentEditingEngagementId = engagement.id;
                engagementTitleEl.value = engagement.title;
                modalOutlineSelectEl.value = engagement.outlineId || '';
                deleteEngagementBtn.classList.remove('hidden');
            } else {
                currentEditingEngagementId = null;
                engagementTitleEl.value = '';
                modalOutlineSelectEl.value = '';
                deleteEngagementBtn.classList.add('hidden');
            }
            
            engagementModalEl.classList.remove('hidden');
            engagementModalEl.classList.add('flex');
        };

        const closeEngagementModal = () => {
            engagementModalEl.classList.add('hidden');
            engagementModalEl.classList.remove('flex');
        };
        
        const handleSaveEngagement = async () => {
            const title = engagementTitleEl.value.trim();
            const outlineId = modalOutlineSelectEl.value;

            if (!title) {
                showToast('Por favor, preencha o título.');
                return;
            }
            
            const engagementData = {
                date: currentSelectedDate,
                title: title,
                outlineId: outlineId
            };
            
            const docId = currentEditingEngagementId || `${currentSelectedDate}_${Date.now()}`;
            await setDoc(doc(engagementsCol, docId), engagementData, { merge: true });

            showToast('Agendamento salvo!');
            closeEngagementModal();
        };
        
        const handleDeleteEngagement = async () => {
            if (currentEditingEngagementId && confirm('Tem certeza que deseja excluir este agendamento?')) {
                 await deleteDoc(doc(engagementsCol, currentEditingEngagementId));
                 showToast('Agendamento excluído.');
                 closeEngagementModal();
            }
        }
        
        const saveFastingSchedule = async () => {
            const title = fastingTitleEl.value.trim();
            const startDate = fastingStartDateEl.value;
            const endDate = fastingEndDateEl.value;
            const notes = fastingNotesEl.value.trim();

            if (!title || !startDate || !endDate) {
                showToast('Preencha o propósito e as datas.');
                return;
            }

            const scheduleData = { title, startDate, endDate, notes, createdAt: new Date() };
            await addDoc(fastingCol, scheduleData);
            showToast('Propósito salvo!');

            // Clear form
            fastingTitleEl.value = '';
            fastingStartDateEl.value = '';
            fastingEndDateEl.value = '';
            fastingNotesEl.value = '';
        };

        const clearVerses = () => {
            verseDisplayEl.innerHTML = '';
            renderVerseDisplayPlaceholder();
            showToast('Resultados limpos.');
        };

        const fetchVerse = async () => {
            const book = bibleStudyBookSelectEl.value;
            const userInput = bibleRefInputEl.value.trim();
            if (!userInput) return;

            let reference;
            if (/[a-zA-ZáéíóúâêîôûãõçÁÉÍÓÚÂÊÎÔÛÃÕÇ]/.test(userInput)) {
                reference = userInput;
            } else {
                if (!book) {
                    showToast('Selecione um livro para buscar.');
                    return;
                }
                reference = `${book} ${userInput}`;
            }

            if (verseDisplayEl.querySelector('.italic')) {
                verseDisplayEl.innerHTML = '';
            }

            const loadingEl = document.createElement('div');
            loadingEl.className = "w-72 flex-shrink-0 p-3 border border-gray-700 rounded-lg bg-gray-800 animate-pulse";
            loadingEl.innerHTML = 'Buscando...';
            verseDisplayEl.appendChild(loadingEl);

            try {
                const response = await fetch(`https://bible-api.com/${reference}?translation=almeida`);
                if (!response.ok) throw new Error('Referência não encontrada.');
                const data = await response.json();
                
                loadingEl.remove();
                
                const verseEl = document.createElement('div');
                verseEl.className = "w-72 flex-shrink-0 p-3 border border-gray-700 rounded-lg bg-gray-800 h-full flex flex-col";
                verseEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="font-bold text-emerald-400">${data.reference}</p>
                        <button class="remove-verse-btn text-gray-500 hover:text-red-400 text-xs"><i class="fas fa-times"></i></button>
                    </div>
                    <p class="overflow-y-auto flex-grow">${data.text}</p>
                `;

                verseEl.querySelector('.remove-verse-btn').addEventListener('click', () => {
                    verseEl.remove();
                    renderVerseDisplayPlaceholder();
                });

                verseDisplayEl.appendChild(verseEl);
                bibleRefInputEl.value = ''; 
                bibleRefInputEl.focus();

            } catch (error) {
                loadingEl.innerHTML = `<p class="text-red-400">Erro: ${error.message}</p>`;
                setTimeout(() => { 
                    loadingEl.remove();
                    renderVerseDisplayPlaceholder();
                }, 3000);
            } finally {
                verseDisplayEl.scrollLeft = verseDisplayEl.scrollWidth;
            }
        };

        const handleGenerateSuggestion = async () => {
            const theme = suggestionThemeInputEl.value.trim();
            if (!theme) {
                showToast("Por favor, insira um tema.");
                return;
            }

            suggestionResultEl.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin mr-2"></i>Gerando esboço...</div>';
            useSuggestionBtn.classList.add('hidden');
            generateSuggestionBtn.disabled = true;

            const apiKey = ""; // Provided by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = `Você é um assistente pastoral e teólogo. Sua tarefa é criar esboços para sermões bíblicos. Seja claro, objetivo e estruture a resposta sempre da mesma forma.`;
            const userQuery = `Crie um esboço de sermão sobre o tema "${theme}". A resposta DEVE ter o seguinte formato:\nTítulo: [Título do Sermão]\n\n[Restante do conteúdo do esboço, incluindo uma introdução, 3 pontos principais com versículos de apoio, e uma conclusão].`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    suggestionResultEl.textContent = text;
                    useSuggestionBtn.classList.remove('hidden');
                } else {
                    throw new Error("Resposta da IA inválida ou vazia.");
                }

            } catch (error) {
                console.error("Error generating suggestion:", error);
                suggestionResultEl.textContent = `Ocorreu um erro ao gerar a sugestão. Tente novamente.\nDetalhes: ${error.message}`;
                showToast("Erro ao gerar sugestão.");
            } finally {
                generateSuggestionBtn.disabled = false;
            }
        };

        const useSuggestion = () => {
            const fullText = suggestionResultEl.textContent;
            const lines = fullText.split('\n');
            
            let title = "Esboço Gerado";
            let content = fullText;

            if(lines[0].toLowerCase().startsWith('título:')) {
                title = lines[0].substring(7).trim();
                content = lines.slice(2).join('\n'); // Skip title line and the blank line
            }

            outlineTitleEl.value = title;
            outlineContentEl.value = content;
            
            closeSuggestionModal();
            showToast("Esboço inserido no editor!");
        };

        const openSuggestionModal = () => {
            suggestionModalEl.classList.remove('hidden');
            suggestionModalEl.classList.add('flex');
            suggestionThemeInputEl.focus();
        };

        const closeSuggestionModal = () => {
             suggestionModalEl.classList.add('hidden');
            suggestionModalEl.classList.remove('flex');
            suggestionResultEl.textContent = 'Aguardando um tema para gerar a sugestão...';
            suggestionThemeInputEl.value = '';
            useSuggestionBtn.classList.add('hidden');
        };

        const switchTab = (tabName) => {
            tabPanes.forEach(pane => {
                pane.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
        };

        // --- Initial Setup ---
        const init = async () => {
            try {
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                if (!userId) {
                    console.error("Authentication failed, UID is null.");
                    return;
                }
                
                BIBLE_BOOKS.forEach(book => {
                    bibleBookSelectEl.add(new Option(book, book));
                    bibleStudyBookSelectEl.add(new Option(book, book));
                });
                
                // Event Listeners
                prevMonthBtn.addEventListener('click', () => changeMonth(-1));
                nextMonthBtn.addEventListener('click', () => changeMonth(1));
                saveOutlineBtn.addEventListener('click', saveOutline);
                clearEditorBtn.addEventListener('click', clearEditor);
                cancelEngagementBtn.addEventListener('click', closeEngagementModal);
                saveEngagementBtn.addEventListener('click', handleSaveEngagement);
                deleteEngagementBtn.addEventListener('click', handleDeleteEngagement);
                fetchVerseBtn.addEventListener('click', fetchVerse);
                clearVersesBtn.addEventListener('click', clearVerses);
                bibleRefInputEl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') fetchVerse();
                });
                tabsEl.addEventListener('click', (e) => {
                    const tabBtn = e.target.closest('.tab-btn');
                    if(tabBtn) {
                        switchTab(tabBtn.dataset.tab);
                    }
                });
                saveFastingBtn.addEventListener('click', saveFastingSchedule);
                
                 // Replace textarea with a contentEditable div for rich text
                const richTextEditor = document.createElement('div');
                richTextEditor.id = 'outline-content';
                richTextEditor.setAttribute('contenteditable', 'true');
                richTextEditor.className = 'w-full h-full flex-grow bg-gray-900 border-x border-b border-gray-700 rounded-b-lg p-4 text-gray-200 resize-none focus:outline-none';
                outlineContentEl.parentNode.replaceChild(richTextEditor, outlineContentEl);
                // Re-assign the element after replacement
                const newOutlineContentEl = document.getElementById('outline-content');


                // Formatting Buttons
                document.getElementById('format-bold').addEventListener('click', () => formatText('bold'));
                document.getElementById('format-italic').addEventListener('click', () => formatText('italic'));
                document.getElementById('format-underline').addEventListener('click', () => formatText('underline'));
                document.getElementById('format-list').addEventListener('click', () => formatText('insertOrderedList'));
                
                // Suggestion Modal Listeners
                suggestionBtn.addEventListener('click', openSuggestionModal);
                cancelSuggestionBtn.addEventListener('click', closeSuggestionModal);
                generateSuggestionBtn.addEventListener('click', handleGenerateSuggestion);
                useSuggestionBtn.addEventListener('click', useSuggestion);
                suggestionThemeInputEl.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleGenerateSuggestion();
                });

                setupFirebaseListeners();
                switchTab('archive'); // Set initial tab for the right panel
                renderCalendar();
                renderVerseDisplayPlaceholder();

            } catch (error) {
                console.error("Error during initialization or Auth:", error);
                document.body.innerHTML = '<div class="text-red-500 text-center p-8">Erro ao conectar com a base de dados. Verifique a configuração do Firebase e as Regras de Segurança.</div>';
            }
        };

        // Run app
        init();
    </script>
</body>
</html>


